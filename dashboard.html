<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sist. Monitoreo | UEB - GAD SDT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- ESTILO CLEAN UI PROFESIONAL --- */
        :root { --primary: #1e3a8a; --accent: #2563eb; --dark: #0f172a; --gray: #64748b; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--dark); padding-bottom: 60px; }

        /* HEADER */
        .top-bar { background: #fff; padding: 15px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .inst-logos { font-size: 0.75rem; color: var(--gray); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .project-main-title { font-weight: 900; font-size: 1.1rem; color: var(--primary); letter-spacing: -0.5px; }
        .project-sub-title { font-size: 0.75rem; color: var(--accent); font-weight: 700; text-transform: uppercase; }

        /* TABS */
        .nav-pills { background: #e2e8f0; padding: 4px; border-radius: 10px; display: inline-flex; }
        .nav-link { color: var(--gray); font-weight: 600; border-radius: 8px; padding: 8px 20px; font-size: 0.85rem; transition: 0.2s; }
        .nav-link.active { background: #fff; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* CARDS & MAPS */
        .clean-card { background: #fff; border-radius: 12px; padding: 20px; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .kpi-val { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 5px; color: var(--dark); }
        .map-container { height: 380px; width: 100%; border-radius: 12px; background: #e2e8f0; z-index: 1; overflow: hidden; }

        /* POPUPS MAPA */
        .leaflet-popup-content-wrapper { border-radius: 8px; font-family: 'Inter'; font-size: 0.8rem; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        .pop-head { background: var(--primary); color: white; padding: 8px 10px; font-weight: 700; }
        .pop-body { padding: 10px; }
        .pop-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 2px; }

        /* --- ESTILOS DE REPORTE A4 --- */
        .report-view-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; padding: 20px; }
        .a4-sheet {
            background: white; width: 210mm; min-height: 297mm; padding: 15mm;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative;
            transform: scale(0.85); transform-origin: top center; margin-bottom: -40mm;
        }

        /* HEADER REPORTE */
        .rep-header { border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .rep-uni { font-size: 0.7rem; font-weight: 700; color: var(--gray); text-transform: uppercase; }
        .rep-title { font-size: 1.2rem; font-weight: 900; color: var(--primary); text-transform: uppercase; line-height: 1.1; margin-top: 5px; }
        .rep-context { font-size: 0.8rem; font-weight: 700; color: var(--accent); margin-top: 2px; }
        .rep-meta { text-align: right; font-size: 0.7rem; color: var(--gray); line-height: 1.4; }
        
        /* FOOTER REPORTE (LEGAL) */
        .rep-footer {
            position: absolute; bottom: 15mm; left: 15mm; right: 15mm;
            border-top: 1px solid #cbd5e1; padding-top: 10px;
            text-align: center; font-size: 0.55rem; color: #64748b; line-height: 1.3;
        }

        /* KPI Box Reporte */
        .rep-kpi-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .rep-kpi-box { flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; text-align: center; }
        .rep-kpi-num { font-size: 1.6rem; font-weight: 800; color: var(--primary); line-height: 1; }
        .rep-kpi-txt { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-top: 4px; }
        
        .rep-table { width: 100%; font-size: 0.7rem; border-collapse: collapse; margin-top: 10px; }
        .rep-table th { background: #f1f5f9; padding: 6px; text-align: left; border-bottom: 2px solid #cbd5e1; font-weight: 800; }
        .rep-table td { padding: 6px; border-bottom: 1px solid #e2e8f0; }

        /* GRID TÉCNICO OBJ 2 */
        .tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .tech-item { border: 1px solid #e2e8f0; border-radius: 5px; padding: 6px; background: #fff; }
        .tech-head { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; margin-bottom: 3px; }
        .tech-name { font-size: 0.6rem; font-weight: 800; color: var(--primary); text-transform: uppercase; }
        .tech-body { font-size: 0.55rem; color: #475569; text-align: justify; line-height: 1.2; }

        /* MODULO 3 (COMING SOON) */
        .coming-soon-box {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 60vh; background: white; border-radius: 12px; border: 2px dashed #cbd5e1;
            text-align: center; padding: 40px;
        }

        @media print {
            body * { visibility: hidden; }
            .printable.active, .printable.active * { visibility: visible; }
            .printable.active { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; transform: none !important; box-shadow: none; }
            @page { size: A4; margin: 10mm; }
            .no-print { display: none !important; }
        }

        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader-ring { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="loader-ring"></div>
        <div class="small fw-bold text-secondary" id="loadText">CONECTANDO A BASE DE DATOS...</div>
    </div>

    <div class="top-bar no-print">
        <div>
            <div class="inst-logos mb-1">UEB • GAD PROVINCIAL SDT • ING. RIESGOS DE DESASTRES</div>
            <div class="project-main-title">PRODUCTO DE PRÁCTICAS PRE PROFESIONALES</div>
            <div class="project-sub-title">FORTALECIMIENTO DE CAPACIDADES Y COMITÉS COMUNITARIOS</div>
        </div>
        <select id="parroquiaFilter" class="form-select border-primary text-primary fw-bold" style="width: 260px;" onchange="applyFilter()">
            <option value="ALL">CONSOLIDADO PROVINCIAL</option>
        </select>
    </div>

    <div class="container-fluid px-4 mt-3">
        
        <div class="d-flex justify-content-center mb-4 no-print">
            <ul class="nav nav-pills shadow-sm" id="mainTabs">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab1">1. DIAGNÓSTICO</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab2">2. EVALUACIÓN SOCIAL</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab3">3. ESTRATEGIAS (OBJ 3)</button></li>
                <li class="nav-item"><button class="nav-link bg-dark text-white ms-3" data-bs-toggle="pill" data-bs-target="#tab4">4. GENERAR REPORTES PDF</button></li>
            </ul>
        </div>

        <div class="tab-content">

            <div class="tab-pane fade show active" id="tab1">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center"><div><div class="small text-muted fw-bold">TOTAL REGISTROS</div><div class="kpi-val" id="c1_total">0</div></div><i class="bi bi-building fs-1 opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center"><div><div class="small text-muted fw-bold">SIST. ALARMA</div><div class="kpi-val text-primary" id="c1_alarma">0%</div></div><i class="bi bi-broadcast fs-1 text-primary opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center"><div><div class="small text-muted fw-bold">VEHÍCULOS</div><div class="kpi-val text-success" id="c1_veh">0%</div></div><i class="bi bi-truck fs-1 text-success opacity-25"></i></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-8"><div class="clean-card p-0"><div class="p-3 border-bottom bg-light small fw-bold">MAPA DE RECURSOS</div><div id="map1" class="map-container"></div></div></div>
                    <div class="col-lg-4 d-flex flex-column gap-3">
                        <div class="clean-card flex-grow-1"><div class="small fw-bold mb-2">TALENTO HUMANO</div><div class="flex-grow-1"><canvas id="chart1a"></canvas></div></div>
                        <div class="clean-card flex-grow-1"><div class="small fw-bold mb-2">LOGÍSTICA</div><div class="flex-grow-1"><canvas id="chart1b"></canvas></div></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab2">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center"><div><div class="small text-muted fw-bold">COMUNIDADES EVALUADAS</div><div class="kpi-val" id="c2_total">0</div></div><i class="bi bi-people fs-1 opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center"><div><div class="small text-muted fw-bold">ÍNDICE GESTIÓN</div><div class="kpi-val text-primary" id="c2_index">0.0</div></div><i class="bi bi-bar-chart fs-1 text-primary opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center"><div><div class="small text-muted fw-bold">ESTADO</div><div class="kpi-val" id="c2_status">-</div></div><i class="bi bi-shield-check fs-1 opacity-25"></i></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-8"><div class="clean-card p-0"><div class="p-3 border-bottom bg-light small fw-bold">MAPA SOCIAL (CLICK PARA INFO)</div><div id="map2" class="map-container"></div></div></div>
                    <div class="col-lg-4"><div class="clean-card"><div class="small fw-bold mb-3">RADAR DE VARIABLES</div><div class="h-100 d-flex justify-content-center align-items-center"><canvas id="chart2"></canvas></div></div></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab3">
                <div class="coming-soon-box">
                    <i class="bi bi-folder-plus text-primary mb-3" style="font-size: 4rem;"></i>
                    <h2 class="fw-bold text-dark">PRÓXIMAMENTE</h2>
                    <h5 class="text-secondary mb-4">OBJETIVO ESPECÍFICO 3</h5>
                    <p class="text-muted" style="max-width: 600px;">
                        "Proponer estrategias a los actores comunitarios en la aplicación de la guía para la conformación de los 10 planes comunitarios desarrollados en cada parroquia."
                    </p>
                    <span class="badge bg-warning text-dark mt-3">MÓDULO DE ANEXOS Y RESPALDOS</span>
                </div>
            </div>

            <div class="tab-pane fade" id="tab4">
                <div class="report-view-container">
                    
                    <div class="d-flex flex-column gap-2 align-items-center">
                        <button onclick="printSheet('sheet1')" class="btn btn-dark w-100 fw-bold no-print shadow-sm"><i class="bi bi-printer me-2"></i>INFORME OBJETIVO 1</button>
                        
                        <div id="sheet1" class="a4-sheet printable">
                            <div class="rep-header">
                                <div>
                                    <div class="rep-uni">UEB • GAD PROVINCIAL SDT</div>
                                    <div class="rep-title">INFORME DE CAPACIDADES</div>
                                    <div class="rep-context">PRODUCTO DE PRÁCTICAS PRE PROFESIONALES</div>
                                </div>
                                <div class="rep-meta">
                                    <strong>Tutor Institucional:</strong><br>Ing. Mauricio Ledesma<br>
                                    <span class="text-primary fw-bold" id="r1_loc">UBICACIÓN</span><br>
                                    <span id="r1_date">--/--/--</span>
                                </div>
                            </div>
                            
                            <div class="rep-kpi-row">
                                <div class="rep-kpi-box"><div>SALUD</div><div class="rep-kpi-num" id="r1_salud">0%</div><div class="rep-kpi-txt">COBERTURA</div></div>
                                <div class="rep-kpi-box"><div>ALARMAS</div><div class="rep-kpi-num text-danger" id="r1_alarma">0%</div><div class="rep-kpi-txt">SISTEMAS</div></div>
                                <div class="rep-kpi-box"><div>VEHÍCULOS</div><div class="rep-kpi-num text-success" id="r1_veh">0%</div><div class="rep-kpi-txt">LOGÍSTICA</div></div>
                            </div>

                            <div class="d-flex gap-3 mb-3" style="height: 240px;">
                                <div style="width:60%; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;"><div id="mapR1" style="width:100%; height:100%"></div></div>
                                <div style="width:40%"><canvas id="chartR1"></canvas></div>
                            </div>

                            <div class="small fw-bold text-uppercase text-secondary border-bottom pb-1 mb-2">ANÁLISIS TÉCNICO SITUACIONAL:</div>
                            <div id="r1_text_content" style="font-size:0.75rem; text-align:justify; column-count:2; column-gap:20px; color:#334155;"></div>

                            <div class="rep-footer">
                                Generado automáticamente del proyecto <strong>"Fortalecimiento de capacidades en las parroquias rurales de la provincia de Santo Domingo de los Tsáchilas aplicando la guía de conformación de comités comunitarios ante riesgos y desastres."</strong><br>
                                <strong>Dylan Velez y Jordan Sanabria</strong><br>
                                Carrera de Ingeniería en Riesgos de Desastres | Universidad Estatal de Bolívar
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-column gap-2 align-items-center">
                        <button onclick="printSheet('sheet2')" class="btn btn-danger w-100 fw-bold no-print shadow-sm"><i class="bi bi-printer me-2"></i>INFORME OBJETIVO 2</button>
                        
                        <div id="sheet2" class="a4-sheet printable">
                            <div class="rep-header" style="border-color: #dc2626;">
                                <div>
                                    <div class="rep-uni">UEB • GAD PROVINCIAL SDT</div>
                                    <div class="rep-title" style="color:#dc2626">EVALUACIÓN COMUNITARIA</div>
                                    <div class="rep-context" style="color:#b91c1c">PRODUCTO DE PRÁCTICAS PRE PROFESIONALES</div>
                                </div>
                                <div class="rep-meta">
                                    <strong>Tutor Institucional:</strong><br>Ing. Mauricio Ledesma<br>
                                    <span class="text-danger fw-bold" id="r2_loc">UBICACIÓN</span><br>
                                    <span id="r2_date">--/--/--</span>
                                </div>
                            </div>

                            <div class="rep-kpi-row">
                                <div class="rep-kpi-box"><div>MUESTRA</div><div class="rep-kpi-num" id="r2_total">0</div><div class="rep-kpi-txt">COMUNIDADES</div></div>
                                <div class="rep-kpi-box"><div>ÍNDICE</div><div class="rep-kpi-num text-primary" id="r2_index">0.0</div><div class="rep-kpi-txt">PROMEDIO</div></div>
                                <div class="rep-kpi-box"><div>ESTADO</div><div class="rep-kpi-num text-warning" id="r2_status">-</div><div class="rep-kpi-txt">MADUREZ</div></div>
                            </div>

                            <div class="d-flex gap-3 mb-3" style="height: 180px;">
                                <div style="width:50%; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;"><div id="mapR2" style="width:100%; height:100%"></div></div>
                                <div style="width:50%; display:flex; justify-content:center;"><canvas id="chartR2"></canvas></div>
                            </div>

                            <div class="small fw-bold text-uppercase text-secondary border-bottom pb-1">MATRIZ DE DICTAMEN TÉCNICO DESGLOSADO:</div>
                            <div id="r2_technical_grid" class="tech-grid"></div>

                            <div class="rep-footer">
                                Generado automáticamente del proyecto <strong>"Fortalecimiento de capacidades en las parroquias rurales de la provincia de Santo Domingo de los Tsáchilas aplicando la guía de conformación de comités comunitarios ante riesgos y desastres."</strong><br>
                                <strong>Dylan Velez y Jordan Sanabria</strong><br>
                                Carrera de Ingeniería en Riesgos de Desastres | Universidad Estatal de Bolívar
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // CONFIG
        const PROXY_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec");
        const LABELS = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];
        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];

        // TEXTOS TÉCNICOS
        const TEXTS = {
            obj1: {
                intro: ["El diagnóstico situacional revela", "El levantamiento de información indica", "La evaluación de capacidades muestra"],
                mid: ["una infraestructura operativa en proceso de consolidación", "brechas significativas en la dotación de recursos", "niveles heterogéneos de respuesta"],
                rec: ["Se recomienda fortalecer la red de alerta temprana.", "Es prioritario gestionar convenios de movilidad.", "Se sugiere capacitar al personal en protocolos."]
            },
            obj2: {
                low: ["Debilidad estructural en la organización comunitaria.", "Ausencia de protocolos validados.", "Baja percepción del riesgo."],
                mid: ["Procesos de organización en etapa de desarrollo.", "Participación activa pero desarticulada.", "Capacidades instaladas básicas."],
                high: ["Alta cohesión social y respuesta coordinada.", "Cultura de prevención consolidada.", "Liderazgo comunitario efectivo."]
            }
        };

        let DATA_CAP=[], DATA_EVAL=[], maps={}, charts={};

        window.onload = () => {
            const sel = document.getElementById('parroquiaFilter');
            PARROQUIAS.sort().forEach(p => sel.add(new Option(p, p)));
            
            initAllMaps();
            startLoading();

            // REFRESH MAPS ON TAB CHANGE
            document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(el => {
                el.addEventListener('shown.bs.tab', () => {
                    for(let k in maps) maps[k].invalidateSize();
                    if(el.dataset.bsTarget === '#tab4') {
                        setTimeout(()=>{ fitMap(maps['mapR1']); fitMap(maps['mapR2']); }, 300);
                    }
                });
            });
        };

        function startLoading() {
            const msgs = ["Conectando con Servidor...", "Descargando Datos...", "Generando Matrices...", "Renderizando Mapas..."];
            let i=0;
            const iv = setInterval(() => { document.getElementById('loadText').innerText = msgs[i++%msgs.length]; }, 800);
            
            fetch(PROXY_URL + "&t=" + Date.now())
                .then(r => r.json())
                .then(d => {
                    clearInterval(iv);
                    if(d.status === 'success') finish(d.dataCap, d.dataEval);
                })
                .catch(() => {
                    clearInterval(iv);
                    console.warn("Offline Mode");
                    finish([["","Alluriquín","","","-.29","-79.05","SI","NO","SI","SI","NO","SI","NO","SI"]], [["2025-11-22","Alluriquín","Centro","Lider","Juan",-.29,-79.05,4,5,3,4,5,4,3,5]]);
                });
        }

        function finish(dc, de) {
            DATA_CAP=dc||[]; DATA_EVAL=de||[];
            document.getElementById('preloader').style.display='none';
            applyFilter();
        }

        function initAllMaps() {
            ['map1','map2','mapR1','mapR2'].forEach(id => {
                maps[id] = L.map(id, {zoomControl:false, attributionControl:false}).setView([-0.25, -79.17], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(maps[id]);
            });
        }

        function createPop(t, rows) {
            return `<div class="pop-head">${t}</div><div class="pop-body">${rows.map(r=>`<div class="pop-row"><span>${r[0]}</span><b>${r[1]}</b></div>`).join('')}</div>`;
        }

        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            const isProv = val === 'ALL';
            const fCap = isProv ? DATA_CAP : DATA_CAP.filter(r => r[1] === val);
            const fEval = isProv ? DATA_EVAL : DATA_EVAL.filter(r => r[1] === val);
            const name = isProv ? "CONSOLIDADO PROVINCIAL" : "PARROQUIA " + val.toUpperCase();

            updateTab1(fCap);
            updateTab2(fEval);
            updateRep1(fCap, name, fCap.length);
            updateRep2(fEval, name);
        }

        function updateTab1(d) {
            let s=0, a=0, v=0, f=0;
            let lg = L.layerGroup();
            d.forEach(r => {
                if(r[6]==='SI') s++; if(r[8]==='SI') f++; if(r[11]==='SI') a++; if(r[13]==='SI') v++;
                let lat=parseFloat(r[4]), lng=parseFloat(r[5]);
                if(lat) {
                    let sc = (r[6]==='SI'?1:0)+(r[11]==='SI'?1:0)+(r[13]==='SI'?1:0);
                    let c = sc>=2?'#16a34a':(sc===1?'#f59e0b':'#dc2626');
                    L.circleMarker([lat, lng], {radius:6, color:'white', fillColor:c, fillOpacity:0.9, weight:1}).addTo(lg)
                    .bindPopup(createPop(r[1], [['Salud',r[6]],['Alarma',r[11]],['Vehículo',r[13]]]));
                }
            });
            updateMap('map1', lg);
            let t=d.length||1;
            document.getElementById('c1_total').innerText=d.length;
            document.getElementById('c1_alarma').innerText=Math.round(a/t*100)+'%';
            document.getElementById('c1_veh').innerText=Math.round(v/t*100)+'%';
            renderBar('chart1a', ['Salud','Fuego'], [s,f], '#2563eb');
            renderBar('chart1b', ['Alarma','Vehículo'], [a,v], '#16a34a');
        }

        function updateTab2(d) {
            let sums=new Array(8).fill(0);
            let lg = L.layerGroup();
            d.forEach(r => {
                for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]);
                let lat=parseFloat(r[5]), lng=parseFloat(r[6]);
                if(lat) {
                    let avg=0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg=(avg/8).toFixed(1);
                    let c = avg>=4?'#16a34a':(avg>=3?'#f59e0b':'#dc2626');
                    L.circleMarker([lat, lng], {radius:6, color:'white', fillColor:c, fillOpacity:0.9, weight:1}).addTo(lg)
                    .bindPopup(createPop(r[2], [['Parroquia',r[1]],['Resp',r[4]],['Nota',avg]]));
                }
            });
            updateMap('map2', lg);
            let avgs = sums.map(s => (s/(d.length||1)).toFixed(1));
            let global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            document.getElementById('c2_total').innerText=d.length;
            document.getElementById('c2_index').innerText=global;
            document.getElementById('c2_status').innerText=global>=4?"SÓLIDO":(global>=3?"MEDIO":"BAJO");
            renderRadar('chart2', avgs, '#2563eb', 'rgba(37,99,235,0.2)');
        }

        function updateRep1(d, name, t) {
            document.getElementById('r1_loc').innerText = name;
            document.getElementById('r1_date').innerText = new Date().toLocaleDateString('es-ES');
            let s=d.filter(r=>r[6]==='SI').length, a=d.filter(r=>r[11]==='SI').length, v=d.filter(r=>r[13]==='SI').length;
            
            document.getElementById('r1_salud').innerText = Math.round(s/(t||1)*100)+'%';
            document.getElementById('r1_alarma').innerText = Math.round(a/(t||1)*100)+'%';
            document.getElementById('r1_veh').innerText = Math.round(v/(t||1)*100)+'%';

            let intro = TEXTS.obj1.intro[Math.floor(Math.random()*3)];
            let mid = TEXTS.obj1.mid[Math.floor(Math.random()*3)];
            let rec = TEXTS.obj1.rec[Math.floor(Math.random()*3)];
            document.getElementById('r1_text_content').innerHTML = `<p>${intro} en ${name} ${mid}. De ${t} registros, la cobertura de salud es del ${Math.round(s/(t||1)*100)}%.</p><p>${rec} Se debe priorizar la inversión en las zonas críticas.</p>`;

            renderBar('chartR1', ['Salud','Alarma','Vehículo'], [s,a,v], '#1e3a8a');
            let lg=L.layerGroup(); d.forEach(r=>{if(parseFloat(r[4])) L.circleMarker([r[4],r[5]],{radius:4,color:'#333',weight:0.5,fillColor:'#2563eb',fillOpacity:1}).addTo(lg)});
            updateMap('mapR1', lg);
        }

        function updateRep2(d, name) {
            document.getElementById('r2_loc').innerText = name;
            document.getElementById('r2_date').innerText = new Date().toLocaleDateString('es-ES');
            document.getElementById('r2_total').innerText = d.length;
            
            let sums=new Array(8).fill(0);
            d.forEach(r => { for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]); });
            let avgs = sums.map(s => Number((s/(d.length||1)).toFixed(1)));
            let global = (avgs.reduce((a,b)=>a+b,0)/8).toFixed(1);
            
            document.getElementById('r2_index').innerText = global;
            document.getElementById('r2_status').innerText = global>=3.5?"ALTO":(global>=2.5?"MEDIO":"BAJO");

            renderRadar('chartR2', avgs, '#dc2626', 'rgba(220,38,38,0.1)');
            let lg=L.layerGroup(); d.forEach(r=>{
                let avg=0;for(let i=0;i<8;i++)avg+=Number(r[i+7]); avg/=8;
                let c=avg>=4?'#16a34a':(avg>=3?'#f59e0b':'#dc2626');
                if(parseFloat(r[5])) L.circleMarker([r[5],r[6]],{radius:4,color:'#333',weight:0.5,fillColor:c,fillOpacity:1}).addTo(lg);
            });
            updateMap('mapR2', lg);

            const grid = document.getElementById('r2_technical_grid'); grid.innerHTML="";
            avgs.forEach((sc, i) => {
                let txt = sc>=4?TEXTS.obj2.high[Math.floor(Math.random()*3)] : (sc>=3?TEXTS.obj2.mid[Math.floor(Math.random()*3)]:TEXTS.obj2.low[Math.floor(Math.random()*3)]);
                let c=sc>=4?'#16a34a':(sc>=3?'#f59e0b':'#dc2626');
                grid.innerHTML += `<div class="tech-item"><div class="tech-head"><span class="tech-name">${LABELS[i]}</span><span style="color:${c};font-weight:800;font-size:0.6rem">${sc}</span></div><div class="tech-body">${txt}</div></div>`;
            });
        }

        function updateMap(id, lg) {
            maps[id].eachLayer(l => { if(!!l.toGeoJSON) maps[id].removeLayer(l); });
            lg.addTo(maps[id]);
            if(lg.getLayers().length>0) setTimeout(()=>fitMap(maps[id]), 200);
        }
        function fitMap(m) { m.setView([-0.25, -79.17], 10); }

        function renderBar(id, l, d, c) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {type:'bar', data:{labels:l, datasets:[{data:d, backgroundColor:c, borderRadius:3}]}, options:{indexAxis:'y', maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{display:false}, ticks:{font:{size:8}}}}}});
        }
        function renderRadar(id, d, c, bg) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {type:'radar', data:{labels:LABELS, datasets:[{data:d, borderColor:c, backgroundColor:bg, pointRadius:1.5}]}, options:{maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{r:{min:0, max:5, ticks:{display:false}, pointLabels:{font:{size:7}}}}}});
        }
        function printSheet(id) {
            document.querySelectorAll('.printable').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.print();
        }
    </script>
</body>
</html>
