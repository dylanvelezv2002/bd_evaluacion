<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Riesgos | UEB - GAD</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- DISEÑO PRO V2.1 (CON POPUPS CORREGIDOS) --- */
        :root {
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-light: #e2e8f0;
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.03), 0 4px 6px -2px rgba(0, 0, 0, 0.01);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 60px;
        }

        /* HEADER MODERNO */
        .top-bar {
            background: var(--surface);
            padding: 1.2rem 3rem;
            margin-bottom: 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--border-light);
            position: sticky; top: 0; z-index: 1000;
        }
        .project-title { font-size: 1.25rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 2px; }
        .project-subtitle { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

        /* FILTROS Y BOTONES */
        .form-select { background-color: #f8fafc; border: 1px solid var(--border-light); border-radius: 10px; font-size: 0.9rem; cursor: pointer; }
        .btn-dark { background-color: var(--text-main); border: none; border-radius: 10px; }

        /* TABS */
        .nav-pills { background: #e2e8f0; padding: 4px; border-radius: 12px; display: inline-flex; }
        .nav-pills .nav-link { color: var(--text-muted); font-weight: 600; font-size: 0.85rem; padding: 8px 20px; border-radius: 9px; border: none; }
        .nav-pills .nav-link.active { background-color: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-weight: 700; }

        /* CARDS */
        .clean-card {
            background: var(--surface); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0);
            padding: 1.5rem; height: 100%; box-shadow: var(--shadow-card); position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card-header-custom { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #f1f5f9; }
        .card-title-text { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; }

        /* KPI */
        .kpi-val { font-size: 2.5rem; font-weight: 800; color: var(--text-main); line-height: 1; letter-spacing: -0.03em; margin-bottom: 4px; }
        .kpi-lbl { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .kpi-icon-bg { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-size: 1.8rem; }

        /* MAPA - POPUPS ESTILIZADOS */
        .map-container { height: 450px; width: 100%; border-radius: var(--radius); background: #e2e8f0; z-index: 1; }
        
        /* ESTILO PERSONALIZADO PARA LOS POPUPS (BURBUJAS) DE LEAFLET */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1) !important;
            padding: 0 !important;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0 !important;
            width: 200px !important;
        }
        .popup-header {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .popup-body {
            padding: 12px 15px;
            font-size: 0.9rem;
            color: var(--text-main);
            background: white;
        }
        .popup-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .popup-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 600; }
        .popup-val { font-weight: 800; }

        /* UTILS */
        .badge-status { padding: 6px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .bg-fortaleza { background-color: #dcfce7; color: #15803d; }
        .bg-mejora { background-color: #fef9c3; color: #a16207; }
        .bg-critico { background-color: #fee2e2; color: #b91c1c; }
        .btn-icon { border: none; background: #f1f5f9; color: #64748b; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .analysis-box { background-color: #f8fafc; border-radius: 12px; padding: 15px; font-size: 0.85rem; color: #475569; line-height: 1.5; margin-top: auto; border: 1px solid #f1f5f9; }
        .report-text { font-size: 1rem; line-height: 1.7; color: #334155; text-align: justify; white-space: pre-line; }
        .check-ok { color: #10b981; font-size: 1.3rem; } .check-no { color: #ef4444; font-size: 1.3rem; opacity: 0.3; }

        /* TABLES */
        .table { --bs-table-bg: transparent; }
        .table thead th { background-color: #f8fafc; color: #64748b; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; padding: 1rem; }
        .table td { vertical-align: middle; font-size: 0.9rem; color: var(--text-main); padding: 1rem; border-bottom: 1px solid #f1f5f9; }

        /* PRELOADER */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .spinner-custom { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print { .no-print, .nav-pills { display: none !important; } .clean-card { box-shadow: none; border: 1px solid #ccc; } }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="spinner-custom"></div>
        <div id="loaderText" class="text-secondary small fw-bold tracking-wider">CARGANDO DATOS...</div>
    </div>

    <div class="top-bar no-print">
        <div class="header-content-left">
            <div class="project-title"><i class="bi bi-shield-check text-primary me-2"></i>MONITOR DE RIESGOS</div>
            <div class="project-subtitle ps-1">UEB & GAD PROVINCIAL SDT | GESTIÓN 2025</div>
        </div>
        <div class="header-content-right d-flex gap-3">
            <select id="parroquiaFilter" class="form-select fw-bold" style="width: 240px;" onchange="applyFilter()">
                <option value="ALL">Vista General Provincial</option>
            </select>
            <button onclick="window.print()" class="btn btn-dark btn-sm fw-bold px-4"><i class="bi bi-printer me-2"></i>Reporte</button>
        </div>
    </div>

    <div class="container-fluid px-4 px-md-5" style="max-width: 1600px;">
        
        <div class="d-flex justify-content-center justify-content-lg-start mb-4 no-print">
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-obj1">1. DIAGNÓSTICO INSTITUCIONAL</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-obj2">2. EVALUACIÓN COMUNITARIA</button></li>
            </ul>
        </div>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-obj1">
                <div class="d-flex align-items-end mb-4 pb-2 border-bottom">
                    <div><h2 class="fw-bold m-0 text-dark" id="titleObj1">Informe de Capacidades</h2><p class="text-muted m-0 mt-1 small">Recursos y primera respuesta</p></div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Total GADs</div><div class="kpi-val" id="capTotal">0</div></div><div class="kpi-icon-bg bg-light text-secondary"><i class="bi bi-building"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Sist. Alerta</div><div class="kpi-val text-primary" id="capAlarma">0%</div></div><div class="kpi-icon-bg bg-primary-subtle text-primary"><i class="bi bi-broadcast"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Flota Vehicular</div><div class="kpi-val text-success" id="capVehiculo">0%</div></div><div class="kpi-icon-bg bg-success-subtle text-success"><i class="bi bi-truck"></i></div></div></div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="clean-card p-0">
                            <div class="p-3 px-4 border-bottom bg-white d-flex justify-content-between"><span class="card-title-text">Mapa de Recursos (Click en los puntos)</span><i class="bi bi-geo-alt text-muted"></i></div>
                            <div id="mapCap" class="map-container" style="border-radius: 0 0 16px 16px;"></div>
                        </div>
                    </div>
                    <div class="col-lg-4 d-flex flex-column gap-4">
                        <div class="clean-card flex-grow-1"><div class="card-header-custom"><span class="card-title-text">Talento Humano</span></div><div class="flex-grow-1 d-flex align-items-center"><canvas id="chartTalento" style="max-height: 180px;"></canvas></div></div>
                        <div class="clean-card flex-grow-1"><div class="card-header-custom"><span class="card-title-text">Logística</span></div><div class="flex-grow-1 d-flex align-items-center"><canvas id="chartLogistica" style="max-height: 180px;"></canvas></div></div>
                    </div>
                </div>

                <div class="clean-card p-4 mb-5 border-start border-5 border-primary">
                    <h5 class="fw-bold text-primary mb-3 text-uppercase small ls-1"><i class="bi bi-file-earmark-text me-2"></i>Dictamen Técnico</h5>
                    <div id="obj1ReportText" class="report-text">Cargando análisis...</div>
                </div>

                <div class="clean-card p-0 mb-5">
                    <div class="p-3 px-4 border-bottom d-flex justify-content-between align-items-center"><span class="card-title-text">Matriz de Recursos</span><button class="btn-icon no-print" onclick="downloadCard('capTableBody', 'Inventario')"><i class="bi bi-camera"></i></button></div>
                    <div class="table-responsive"><table class="table table-hover mb-0 w-100 align-middle text-center"><thead><tr><th class="text-start ps-4">Territorio</th><th>Salud</th><th>Bomberos</th><th>Seguridad</th><th>Alarma</th><th>Albergue</th><th>Vehículo</th></tr></thead><tbody id="capTableBody"></tbody></table></div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-obj2">
                <div class="d-flex align-items-end mb-4 pb-2 border-bottom">
                    <div><h2 class="fw-bold m-0 text-dark" id="reportTitle">Evaluación Comunitaria</h2><p class="text-muted m-0 mt-1 small">Percepción social y resiliencia</p></div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Comunidades</div><div class="kpi-val" id="kpiTotal">0</div></div><div class="kpi-icon-bg bg-light text-secondary"><i class="bi bi-people"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Índice Global</div><div class="kpi-val text-primary" id="kpiPromedio">0.0</div></div><div class="kpi-icon-bg bg-primary-subtle text-primary"><i class="bi bi-bar-chart-steps"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Estado Actual</div><div class="fw-bold text-uppercase mt-1" id="kpiEstado" style="font-size: 1.5rem;">-</div></div><div class="kpi-icon-bg bg-light text-muted"><i class="bi bi-activity"></i></div></div></div>
                </div>

                <div class="row g-4 mb-5">
                    <div class="col-lg-8">
                        <div class="clean-card p-0">
                            <div class="p-3 px-4 border-bottom bg-white"><span class="card-title-text">Mapa de Calor Social (Click en los puntos)</span></div>
                            <div id="mapEval" class="map-container" style="border-radius: 0 0 16px 16px;"></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="clean-card p-0 h-100 d-flex flex-column">
                            <div class="p-3 px-4 border-bottom bg-white"><span class="card-title-text">Semáforo Territorial</span></div>
                            <div id="territoryGrid" class="flex-grow-1 overflow-auto custom-scroll"></div>
                        </div>
                    </div>
                </div>

                <h4 class="fw-bold text-secondary mb-4 small text-uppercase ls-1">Desglose de Indicadores</h4>
                <div class="row g-4 mb-5" id="chartsGrid"></div>

                <div class="row g-4 mb-5">
                    <div class="col-lg-4">
                        <div class="clean-card" id="cardRadar">
                            <div class="card-header-custom"><span class="card-title-text">Perfil de Resiliencia</span><button class="btn-icon no-print" onclick="downloadCard('cardRadar','Radar')"><i class="bi bi-camera"></i></button></div>
                            <div style="height:300px; display:flex; justify-content:center;"><canvas id="radarChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="clean-card p-0 overflow-hidden h-100">
                            <div class="p-3 px-4 border-bottom"><span class="card-title-text">Registro de Actores Clave</span></div>
                            <div class="table-responsive" style="max-height:380px"><table class="table table-hover mb-0 w-100 small"><thead><tr><th class="ps-4">Fecha</th><th>Parroquia</th><th>Comunidad</th><th>Cargo</th><th>Puntaje</th></tr></thead><tbody id="tableBody"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const BASE_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";
        const PROXY_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(BASE_URL);
        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];
        const LABELS_OBJ2 = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];
        const TIPS = ["Conectando al servidor seguro...", "Analizando datos...", "Generando visualizaciones..."];

        let DATA_CAP=[], DATA_EVAL=[], mapCap, mapEval, markersCap=new L.LayerGroup(), markersEval=new L.LayerGroup(), chartInstances={};

        // --- FUNCIÓN PARA CREAR EL POPUP BONITO (HTML) ---
        function createPopup(title, rows) {
            let body = rows.map(r => `<div class="popup-row"><span class="popup-label">${r.label}</span><span class="popup-val">${r.val}</span></div>`).join('');
            return `<div class="popup-header">${title}</div><div class="popup-body">${body}</div>`;
        }

        function generateObj1Report(data, isProv, name, alarmas, total) {
            if(data.length===0) return "No existe información registrada.";
            let salud = data.filter(r=>r[6]==='SI').length;
            let veh = data.filter(r=>r[13]==='SI').length;
            let pctAlarma = Math.round((alarmas/total)*100);
            let pctSalud = Math.round((salud/total)*100);
            let txt = `De conformidad con el diagnóstico institucional realizado ${isProv ? 'a nivel provincial' : 'en la parroquia ' + name}, se observa que el ${pctSalud}% del territorio dispone de talento humano en salud. `;
            txt += (pctAlarma < 50) ? `Se identifica una vulnerabilidad tecnológica crítica, dado que apenas el ${pctAlarma}% cuenta con sistemas de alerta temprana. ` : `La infraestructura de alerta temprana muestra una cobertura sólida del ${pctAlarma}%. `;
            txt += `En movilidad logística, el ${Math.round((veh/total)*100)}% de los GADs posee vehículos operativos.`;
            return txt;
        }

        const textObj2 = {
            low: ["Atención Prioritaria: Se detecta desconexión estructural.", "Nivel Crítico: Requiere intervención inmediata."],
            mid: ["En Desarrollo: Existen capacidades base, pero requieren fortalecimiento.", "Nivel Medio: Estabilidad parcial."],
            high: ["Fortaleza Institucional: El indicador supera los estándares.", "Nivel Óptimo: Capacidad de autogestión."]
        };
        function getAnalysisText(key, score) {
            let lvl = score >= 4 ? 'high' : (score >= 3 ? 'mid' : 'low');
            return textObj2[lvl][Math.floor(Math.random() * textObj2[lvl].length)];
        }

        window.onload = () => {
            runPreloader(); initMaps();
            const sel = document.getElementById('parroquiaFilter');
            PARROQUIAS.sort().forEach(p => sel.add(new Option(p, p)));
            
            fetch(PROXY_URL).then(r => r.json()).then(d => {
                document.getElementById('preloader').style.opacity='0';
                setTimeout(()=>document.getElementById('preloader').style.display='none', 500);
                if(d.status==='success') { DATA_CAP=d.dataCap||[]; DATA_EVAL=d.dataEval||[]; applyFilter(); }
                else { Swal.fire("Aviso", "No hay datos disponibles.", "info"); }
            }).catch(e => { 
                document.getElementById('preloader').style.display='none';
                Swal.fire({ title: "Modo Seguro", text: "Se ha activado el puente de conexión alternativo.", icon: "info" }); 
            });
        };

        function runPreloader() {
            let i=0; setInterval(()=>{document.getElementById('loaderText').innerText=TIPS[i];i=(i+1)%TIPS.length}, 2000);
            setTimeout(()=>document.getElementById('preloader').style.display='none', 8000);
        }

        function initMaps() {
            mapCap = L.map('mapCap', {zoomControl:false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution:''}).addTo(mapCap);
            markersCap.addTo(mapCap);
            mapEval = L.map('mapEval', {zoomControl:false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution:''}).addTo(mapEval);
            markersEval.addTo(mapEval);
            document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(el => { el.addEventListener('shown.bs.tab', () => { mapCap.invalidateSize(); mapEval.invalidateSize(); }); });
        }

        function fitBounds(map, layer) {
            if (layer.getLayers().length > 0) map.fitBounds(layer.getBounds());
            else map.setView([-0.2530, -79.1754], 10);
        }

        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            const isProv = val === 'ALL';
            const t = isProv ? "Consolidado Provincial" : val;
            document.getElementById('titleObj1').innerText = "Informe: " + t;
            document.getElementById('reportTitle').innerText = "Reporte: " + t;
            const fCap = isProv ? DATA_CAP : DATA_CAP.filter(r => r[1] === val);
            const fEval = isProv ? DATA_EVAL : DATA_EVAL.filter(r => r[1] === val);
            renderObj1(fCap, isProv, val);
            renderObj2(fEval);
            setTimeout(() => { fitBounds(mapCap, markersCap); fitBounds(mapEval, markersEval); }, 500);
        }

        function renderObj1(data, isProv, name) {
            document.getElementById('capTotal').innerText = data.length;
            markersCap.clearLayers();
            const tbody = document.getElementById('capTableBody'); tbody.innerHTML="";
            let alarmas=0, vehiculos=0, salud=0, fuego=0;
            data.forEach(r => {
                if(r[6]==='SI') salud++; if(r[8]==='SI') fuego++;
                if(r[11]==='SI') alarmas++; if(r[13]==='SI') vehiculos++;
                const i=(v)=>v==='SI'?'<i class="bi bi-check-circle-fill check-ok"></i>':'<i class="bi bi-dash-circle check-no"></i>';
                tbody.innerHTML += `<tr><td class="text-start ps-4 fw-bold text-secondary">${r[1]}</td><td>${i(r[6])}</td><td>${i(r[8])}</td><td>${i(r[9])}</td><td>${i(r[11])}</td><td>${i(r[12])}</td><td>${i(r[13])}</td></tr>`;
                if(r[4]&&r[5]) {
                    let lat = parseFloat(r[4])+(Math.random()-0.5)*0.0005; let lng = parseFloat(r[5])+(Math.random()-0.5)*0.0005;
                    let score=0; if(r[6]==='SI')score++; if(r[11]==='SI')score++; if(r[13]==='SI')score++;
                    let c=score>=2?'#10b981':(score===1?'#f59e0b':'#ef4444');
                    // POPUP AGREGADO AQUÍ
                    let popupContent = createPopup(r[1], [
                        {label: 'Salud (Médico)', val: r[6]},
                        {label: 'Alarma', val: r[11]},
                        {label: 'Vehículo', val: r[13]},
                        {label: 'Índice Total', val: score + '/3'}
                    ]);
                    L.circleMarker([lat, lng], {radius:9, fillColor:c, color:'white', weight:2, fillOpacity:0.9}).bindPopup(popupContent).addTo(markersCap);
                }
            });
            const t = data.length || 1;
            document.getElementById('capAlarma').innerText = Math.round((alarmas/t)*100)+"%";
            document.getElementById('capVehiculo').innerText = Math.round((vehiculos/t)*100)+"%";
            renderBarChart('chartTalento', ['Salud', 'Fuego'], [salud, fuego], t, '#2563eb');
            renderBarChart('chartLogistica', ['Alarma', 'Vehículo'], [alarmas, vehiculos], t, '#10b981');
            document.getElementById('obj1ReportText').innerHTML = generateObj1Report(data, isProv, name, alarmas, t);
        }

        function renderObj2(data) {
            markersEval.clearLayers();
            const grid = document.getElementById('chartsGrid'); grid.innerHTML="";
            const tbody = document.getElementById('tableBody'); tbody.innerHTML="";
            let sums = new Array(8).fill(0);
            if(data.length === 0) { document.getElementById('kpiTotal').innerText="0"; return; }
            data.forEach(r => {
                for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]);
                let lat = parseFloat(r[5])+(Math.random()-0.5)*0.0005; let lng = parseFloat(r[6])+(Math.random()-0.5)*0.0005;
                let rowAvg=0; for(let i=0;i<8;i++) rowAvg+=Number(r[i+7]); rowAvg=(rowAvg/8).toFixed(1);
                tbody.innerHTML += `<tr><td class="ps-4 text-muted">${new Date(r[0]).toLocaleDateString()}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[4]}</td><td class="fw-bold">${rowAvg}</td></tr>`;
                let color = rowAvg>=4?'#10b981':(rowAvg>=3?'#f59e0b':'#ef4444');
                // POPUP AGREGADO AQUÍ
                let popupContent = createPopup(r[2], [
                    {label: 'Parroquia', val: r[1]},
                    {label: 'Responsable', val: r[4]},
                    {label: 'Evaluación', val: rowAvg + '/5'}
                ]);
                L.circleMarker([lat, lng], {radius:8, fillColor:color, color:'white', weight:1, fillOpacity:0.9}).bindPopup(popupContent).addTo(markersEval);
            });
            const avgs = sums.map(s => (s/data.length).toFixed(1));
            const global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            document.getElementById('kpiTotal').innerText = data.length;
            document.getElementById('kpiPromedio').innerText = global;
            const st = document.getElementById('kpiEstado');
            if(global>=4) { st.innerText="SÓLIDO"; st.className="fw-bold text-success mt-1"; } else if(global>=3) { st.innerText="REGULAR"; st.className="fw-bold text-warning mt-1"; } else { st.innerText="CRÍTICO"; st.className="fw-bold text-danger mt-1"; }
            avgs.forEach((avg, i) => {
                let color = avg>=4?'#10b981':(avg>=3?'#f59e0b':'#ef4444');
                let text = getAnalysisText('p'+(i+1), avg);
                let badge = avg>=4?'FORTALEZA':(avg>=3?'MEJORA':'CRÍTICO');
                let badgeClass = avg>=4?'bg-fortaleza':(avg>=3?'bg-mejora':'bg-critico');
                grid.innerHTML += `<div class="col-md-6 col-xl-3"><div class="clean-card" id="c${i}"><div class="card-header-custom"><span class="card-title-text">${LABELS_OBJ2[i]}</span><button class="btn-icon no-print" onclick="downloadCard('c${i}','${LABELS_OBJ2[i]}')"><i class="bi bi-camera"></i></button></div><div class="d-flex justify-content-between align-items-end mb-3"><h2 class="fw-bold m-0" style="color:${color}; font-size: 2.2rem;">${avg}</h2><span class="badge-status ${badgeClass}">${badge}</span></div><div style="height:50px; margin-bottom: 15px;"><canvas id="cv${i}"></canvas></div><div class="analysis-box"><span class="text-primary fw-bold small mb-1 d-block">OBSERVACIÓN:</span>${text}</div></div></div>`;
                setTimeout(()=>new Chart(document.getElementById(`cv${i}`), {type:'bar', data:{labels:[''], datasets:[{data:[avg], backgroundColor:color, borderRadius:4, barThickness: 12}]}, options:{indexAxis:'y', maintainAspectRatio:false, scales:{x:{min:0,max:5,display:false},y:{display:false}}, plugins:{legend:{display:false}, tooltip:{enabled:false}}}}),0);
            });
            renderMonitor(data); renderRadar(avgs);
        }

        function renderMonitor(data) {
            const c = document.getElementById('territoryGrid'); c.innerHTML="";
            const g={}; PARROQUIAS.forEach(p=>g[p]={s:0,c:0});
            data.forEach(r=>{if(g[r[1]]){let s=0;for(let i=0;i<8;i++)s+=Number(r[i+7]);g[r[1]].s+=s/8;g[r[1]].c++;}});
            Object.keys(g).sort().forEach(p=>{
                let d=g[p], s=d.c>0?(d.s/d.c).toFixed(1):"0.0", color=d.c===0?'#9ca3af':(s>=4?'#10b981':(s>=3?'#f59e0b':'#ef4444'));
                c.innerHTML+=`<div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-hover-light" onclick="document.getElementById('parroquiaFilter').value='${p}'; applyFilter();" style="cursor:pointer; transition:0.2s;"><div class="d-flex align-items-center"><span class="dot me-2" style="background:${color};width:8px;height:8px;border-radius:50%"></span><span class="small fw-bold text-secondary">${p}</span></div><span class="badge rounded-pill text-dark bg-light border">${s}</span></div>`;
            });
        }

        function renderRadar(avgs) {
            if(chartInstances['radar']) chartInstances['radar'].destroy();
            chartInstances['radar'] = new Chart(document.getElementById('radarChart'), {type:'radar', data:{labels:LABELS_OBJ2, datasets:[{label:'Nivel', data:avgs, backgroundColor:'rgba(37, 99, 235, 0.2)', borderColor:'#2563eb', pointBackgroundColor: '#2563eb'}]}, options: {scales: { r: { angleLines: { color: '#e2e8f0' }, grid: { color: '#e2e8f0' }, pointLabels: { font: { size: 10, family: 'Inter' } } } }}});
        }

        function renderBarChart(id, lbls, vals, max, color) {
            if(chartInstances[id]) chartInstances[id].destroy();
            chartInstances[id] = new Chart(document.getElementById(id), {type: 'bar', data: { labels: lbls, datasets: [{ label: 'Cobertura', data: vals, backgroundColor: color, borderRadius: 6, barThickness: 20 }] }, options: { indexAxis: 'y', scales: { x: { max: max, ticks: { stepSize: 1, display: false }, grid: {display:false} }, y: { grid: {display:false}, ticks: {font:{family:'Inter'}} } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }});
        }

        function downloadCard(id, t) {
            const el = document.getElementById(id), btn = el.querySelector('.btn-icon'); if(btn) btn.style.display='none';
            html2canvas(el, {scale:2, backgroundColor:'#fff'}).then(c=>{ const l=document.createElement('a'); l.download=`Analisis_${t}.png`; l.href=c.toDataURL(); l.click(); if(btn) btn.style.display='block'; });
        }
    </script>
</body>
</html>
