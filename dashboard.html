<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Integral | UEB - GAD</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- ESTILOS GLOBALES --- */
        :root {
            --bg-body: #f8fafc; --surface: #ffffff;
            --primary: #2563eb; --secondary: #475569;
            --accent-red: #dc2626; --accent-green: #16a34a;
            --border: #e2e8f0; --radius: 12px;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); padding-bottom: 50px; }
        
        /* HEADER APP */
        .top-bar { background: var(--surface); padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .project-title { font-weight: 800; color: #1e3a8a; font-size: 1.2rem; }
        .form-select { background-color: #f1f5f9; border: 1px solid var(--border); font-weight: 600; color: #334155; }

        /* TABS */
        .nav-pills { background: #e2e8f0; padding: 4px; border-radius: 10px; display: inline-flex; }
        .nav-pills .nav-link { color: var(--secondary); font-weight: 600; padding: 8px 20px; border-radius: 8px; font-size: 0.85rem; }
        .nav-pills .nav-link.active { background-color: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* CARDS & MAPS */
        .clean-card { background: var(--surface); border-radius: var(--radius); padding: 1.5rem; border: 1px solid var(--border); height: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .map-container { height: 400px; width: 100%; border-radius: var(--radius); background: #e2e8f0; z-index: 1; }
        .kpi-val { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .kpi-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--secondary); }

        /* --- DISEÑO REPORTE A4 (ESTRICTO) --- */
        .print-container { display: none; } /* Oculto en web normal */
        
        .a4-preview {
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; color: #0f172a;
        }

        .rep-header { border-bottom: 2px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .rep-title { font-size: 1.5rem; font-weight: 900; text-transform: uppercase; color: #1e3a8a; line-height: 1; }
        .rep-sub { font-size: 0.8rem; font-weight: 600; color: #64748b; margin-top: 4px; }
        
        .rep-section-title { 
            background: #f1f5f9; border-left: 4px solid var(--primary); padding: 6px 10px; 
            font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; margin-top: 20px;
        }

        /* Grid Reporte */
        .rep-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .rep-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        .rep-box { border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; }
        .rep-kpi-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .rep-kpi-lbl { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #64748b; }

        .rep-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin-top: 10px; }
        .rep-table th { background: #f8fafc; padding: 6px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        .rep-table td { padding: 6px; border-bottom: 1px solid #e2e8f0; }

        .dictamen-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .dict-card { background: #fff; border: 1px solid #e2e8f0; padding: 8px; border-radius: 6px; }
        .dict-score { font-weight: 800; font-size: 0.9rem; float: right; }
        .dict-name { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #475569; display: block;}

        /* PRELOADER */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        /* IMPRESIÓN */
        @media print {
            body * { visibility: hidden; }
            .a4-preview, .a4-preview * { visibility: visible; }
            .a4-preview { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
            @page { margin: 10mm; size: A4; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="small fw-bold text-secondary">CARGANDO BASE DE DATOS...</div>
    </div>

    <div class="top-bar no-print">
        <div>
            <div class="project-title">MONITOR INTEGRAL DE RIESGOS</div>
            <div class="small text-muted fw-bold">UEB - GAD PROVINCIAL SDT</div>
        </div>
        <select id="parroquiaFilter" class="form-select" style="width: 250px;" onchange="applyFilter()">
            <option value="ALL">TODA LA PROVINCIA</option>
        </select>
    </div>

    <div class="container-fluid px-4 mt-4">
        
        <div class="d-flex justify-content-center mb-4 no-print">
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-obj1">1. DIAGNÓSTICO INSTITUCIONAL</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-obj2">2. EVALUACIÓN SOCIAL</button></li>
                <li class="nav-item"><button class="nav-link bg-dark text-white ms-3" data-bs-toggle="pill" data-bs-target="#tab-report" onclick="prepareReport()">3. GENERAR REPORTE PDF</button></li>
            </ul>
        </div>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="tab-obj1">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center justify-content-between"><div><div class="kpi-lbl">GADs Registrados</div><div class="kpi-val" id="kpiCapTotal">0</div></div><i class="bi bi-building fs-1 text-secondary opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center justify-content-between"><div><div class="kpi-lbl">Cobertura Alarmas</div><div class="kpi-val text-primary" id="kpiCapAlarma">0%</div></div><i class="bi bi-broadcast fs-1 text-primary opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center justify-content-between"><div><div class="kpi-lbl">Flota Vehicular</div><div class="kpi-val text-success" id="kpiCapVeh">0%</div></div><i class="bi bi-truck fs-1 text-success opacity-25"></i></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-8"><div class="clean-card p-0"><div class="p-3 border-bottom fw-bold small text-muted bg-light">MAPA DE RECURSOS</div><div id="mapCap" class="map-container"></div></div></div>
                    <div class="col-lg-4">
                        <div class="clean-card mb-3" style="height: 48%;"><div class="small fw-bold text-muted mb-2">TALENTO HUMANO</div><div style="height:150px"><canvas id="chartTalento"></canvas></div></div>
                        <div class="clean-card" style="height: 48%;"><div class="small fw-bold text-muted mb-2">LOGÍSTICA</div><div style="height:150px"><canvas id="chartLogistica"></canvas></div></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-obj2">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center justify-content-between"><div><div class="kpi-lbl">Comunidades</div><div class="kpi-val" id="kpiEvalTotal">0</div></div><i class="bi bi-people fs-1 text-secondary opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center justify-content-between"><div><div class="kpi-lbl">Índice Gestión</div><div class="kpi-val text-primary" id="kpiEvalProm">0.0</div></div><i class="bi bi-bar-chart fs-1 text-primary opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center justify-content-between"><div><div class="kpi-lbl">Estado</div><div class="kpi-val" id="kpiEvalStatus" style="font-size:1.5rem">-</div></div><i class="bi bi-shield-check fs-1 opacity-25 text-secondary"></i></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-8"><div class="clean-card p-0"><div class="p-3 border-bottom fw-bold small text-muted bg-light">MAPA DE PERCEPCIÓN</div><div id="mapEval" class="map-container"></div></div></div>
                    <div class="col-lg-4"><div class="clean-card"><div class="small fw-bold text-muted mb-3">RADAR DE VARIABLES</div><div style="height:300px"><canvas id="radarChart"></canvas></div></div></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-report">
                <div class="d-flex flex-column align-items-center">
                    <button onclick="window.print()" class="btn btn-dark btn-lg fw-bold mb-4 shadow px-5 rounded-pill no-print"><i class="bi bi-printer-fill me-2"></i>IMPRIMIR REPORTE A4</button>
                    
                    <div class="a4-preview">
                        <div class="rep-header">
                            <div>
                                <div class="rep-title">INFORME INTEGRAL DE GESTIÓN</div>
                                <div class="rep-sub">SISTEMA DE MONITOREO DE RIESGOS | UEB - GAD SDT</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-primary" id="repLocation">PROVINCIA</div>
                                <div class="small text-muted" id="repDate">Fecha: 22/11/2025</div>
                            </div>
                        </div>

                        <div class="rep-section-title">1. DIAGNÓSTICO DE CAPACIDADES (INSTITUCIONAL)</div>
                        <div class="rep-grid-3 mb-3">
                            <div class="rep-box text-center">
                                <div class="rep-kpi-lbl">COBERTURA SALUD</div>
                                <div class="rep-kpi-val text-primary" id="repCapSalud">0%</div>
                            </div>
                            <div class="rep-box text-center">
                                <div class="rep-kpi-lbl">SISTEMAS ALARTA</div>
                                <div class="rep-kpi-val text-danger" id="repCapAlarma">0%</div>
                            </div>
                            <div class="rep-box text-center">
                                <div class="rep-kpi-lbl">PARQUE AUTOMOTOR</div>
                                <div class="rep-kpi-val text-success" id="repCapVeh">0%</div>
                            </div>
                        </div>
                        <div class="rep-grid-2 mb-4">
                             <div class="rep-box" style="height: 180px;">
                                <div class="small fw-bold text-center text-muted mb-2">RECURSOS DISPONIBLES</div>
                                <canvas id="chartRepBar"></canvas>
                            </div>
                            <div class="rep-box bg-light">
                                <div class="small fw-bold text-primary mb-2">DICTAMEN TÉCNICO:</div>
                                <p class="small text-muted text-justify m-0" style="line-height: 1.4;" id="repTxtObj1">
                                    Analizando la capacidad operativa...
                                </p>
                            </div>
                        </div>

                        <div class="rep-section-title">2. EVALUACIÓN COMUNITARIA (SOCIAL)</div>
                        
                        <div class="rep-grid-2 mb-3">
                             <div class="rep-box d-flex align-items-center justify-content-center" style="height: 220px;">
                                <div style="width:100%; height:100%"><canvas id="chartRepRadar"></canvas></div>
                            </div>
                            <div class="rep-box p-0 overflow-hidden" style="height: 220px;">
                                <div id="mapRep" style="width:100%; height:100%;"></div>
                            </div>
                        </div>

                        <div class="small fw-bold text-muted mb-2 text-uppercase">Desglose de Indicadores:</div>
                        <div class="dictamen-grid" id="repGridVars">
                            </div>

                        <div class="mt-4">
                            <div class="small fw-bold text-muted mb-1 text-uppercase">Últimos Registros:</div>
                            <table class="rep-table">
                                <thead><tr><th>Comunidad</th><th>Responsable</th><th>Fecha</th><th class="text-center">Nota</th></tr></thead>
                                <tbody id="repTableBody"></tbody>
                            </table>
                        </div>

                        <div class="position-absolute bottom-0 start-0 w-100 p-4 text-center">
                            <div style="border-top: 1px solid #ddd; padding-top: 10px;" class="small text-muted fst-italic">
                                Documento generado automáticamente por la plataforma de Prácticas Pre-Profesionales UEB.
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DATOS Y CONFIG
        const BASE_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";
        const PROXY_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(BASE_URL);
        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];
        const LABELS_VAR = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];

        let DATA_CAP = [], DATA_EVAL = [];
        let mapCap, mapEval, mapRep;
        let layersCap = L.layerGroup(), layersEval = L.layerGroup(), layersRep = L.layerGroup();
        let charts = {};

        window.onload = () => {
            // Llenar select
            const sel = document.getElementById('parroquiaFilter');
            PARROQUIAS.sort().forEach(p => sel.add(new Option(p, p)));
            document.getElementById('repDate').innerText = "Fecha Emisión: " + new Date().toLocaleDateString();

            // Iniciar Mapas
            initMaps();

            // Cargar Datos
            fetch(PROXY_URL).then(r => r.json()).then(d => {
                document.getElementById('preloader').style.display = 'none';
                if(d.status === 'success') {
                    DATA_CAP = d.dataCap || [];
                    DATA_EVAL = d.dataEval || [];
                    applyFilter();
                }
            }).catch(e => {
                document.getElementById('preloader').style.display = 'none';
                Swal.fire("Error", "No se pudo conectar con la base de datos.", "error");
            });

            // Fix mapas al cambiar pestaña
            document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(el => {
                el.addEventListener('shown.bs.tab', () => {
                    mapCap.invalidateSize();
                    mapEval.invalidateSize();
                    if(el.getAttribute('data-bs-target') === '#tab-report') {
                        setTimeout(() => { mapRep.invalidateSize(); fitMap(mapRep, layersRep); }, 300);
                    }
                });
            });
        };

        function initMaps() {
            const tiles = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            
            mapCap = L.map('mapCap', {zoomControl:false}).setView([-0.253, -79.17], 10);
            L.tileLayer(tiles).addTo(mapCap);
            layersCap.addTo(mapCap);

            mapEval = L.map('mapEval', {zoomControl:false}).setView([-0.253, -79.17], 10);
            L.tileLayer(tiles).addTo(mapEval);
            layersEval.addTo(mapEval);

            // Mapa del Reporte (Estático)
            mapRep = L.map('mapRep', {zoomControl:false, attributionControl:false}).setView([-0.253, -79.17], 10);
            L.tileLayer(tiles).addTo(mapRep);
            layersRep.addTo(mapRep);
        }

        function createPopup(title, lines) {
            return `<div style="font-weight:bold;color:#1e3a8a;margin-bottom:5px;border-bottom:1px solid #eee;">${title}</div>` + 
                   lines.map(l => `<div style="display:flex;justify-content:space-between;font-size:0.85rem;"><span>${l[0]}:</span> <strong>${l[1]}</strong></div>`).join('');
        }

        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            const isProv = val === 'ALL';
            
            // Filtrar
            const fCap = isProv ? DATA_CAP : DATA_CAP.filter(r => r[1] === val);
            const fEval = isProv ? DATA_EVAL : DATA_EVAL.filter(r => r[1] === val);

            // Render Tabs
            renderTab1(fCap, isProv, val);
            renderTab2(fEval);

            // Actualizar datos listos para el reporte (se dibuja al hacer click en tab 3)
            window.REPORT_DATA = { cap: fCap, eval: fEval, name: isProv ? "CONSOLIDADO PROVINCIAL" : "PARROQUIA " + val };
            if(document.querySelector('#tab-report').classList.contains('active')) prepareReport();
        }

        function fitMap(map, layerGroup) {
            if (layerGroup.getLayers().length > 0) map.fitBounds(layerGroup.getBounds(), {padding: [20,20]});
            else map.setView([-0.253, -79.17], 10);
        }

        // --- LOGICA TAB 1 ---
        function renderTab1(data, isProv, name) {
            document.getElementById('kpiCapTotal').innerText = data.length;
            let alarmas = data.filter(r=>r[11]==='SI').length, veh = data.filter(r=>r[13]==='SI').length, salud = data.filter(r=>r[6]==='SI').length, fuego = data.filter(r=>r[8]==='SI').length;
            let pctAlarma = Math.round((alarmas/data.length||1)*100);
            let pctVeh = Math.round((veh/data.length||1)*100);

            document.getElementById('kpiCapAlarma').innerText = pctAlarma + "%";
            document.getElementById('kpiCapVeh').innerText = pctVeh + "%";

            layersCap.clearLayers();
            data.forEach(r => {
                let lat = parseFloat(r[4]), lng = parseFloat(r[5]);
                if(lat && lng) {
                    let score = (r[6]==='SI'?1:0) + (r[11]==='SI'?1:0) + (r[13]==='SI'?1:0);
                    let color = score >= 2 ? '#16a34a' : (score===1 ? '#f59e0b' : '#dc2626');
                    L.circleMarker([lat+(Math.random()-0.5)*0.001, lng+(Math.random()-0.5)*0.001], {radius:8, color:'white', weight:1, fillColor:color, fillOpacity:0.9})
                    .bindPopup(createPopup(r[1], [['Salud',r[6]],['Alarma',r[11]],['Vehículo',r[13]]])).addTo(layersCap);
                }
            });
            fitMap(mapCap, layersCap);

            renderBar('chartTalento', ['Salud','Fuego','Seguridad'], [salud, fuego, data.filter(r=>r[9]==='SI').length], '#2563eb');
            renderBar('chartLogistica', ['Alarma','Albergue','Vehículo'], [alarmas, data.filter(r=>r[12]==='SI').length, veh], '#16a34a');
        }

        // --- LOGICA TAB 2 ---
        function renderTab2(data) {
            document.getElementById('kpiEvalTotal').innerText = data.length;
            let sums = new Array(8).fill(0);
            data.forEach(r => { for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]); });
            let avgs = sums.map(s => (s/(data.length||1)).toFixed(1));
            let global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);

            document.getElementById('kpiEvalProm').innerText = global;
            let st = document.getElementById('kpiEvalStatus');
            st.innerText = global>=4 ? "SÓLIDO" : (global>=3 ? "REGULAR" : "CRÍTICO");
            st.className = "kpi-val " + (global>=4 ? "text-success" : (global>=3 ? "text-warning" : "text-danger"));

            layersEval.clearLayers();
            data.forEach(r => {
                let lat = parseFloat(r[5]), lng = parseFloat(r[6]);
                if(lat && lng) {
                    let rowAvg=0; for(let i=0;i<8;i++) rowAvg+=Number(r[i+7]); rowAvg=(rowAvg/8).toFixed(1);
                    let color = rowAvg>=4?'#16a34a':(rowAvg>=3?'#f59e0b':'#dc2626');
                    L.circleMarker([lat+(Math.random()-0.5)*0.001, lng+(Math.random()-0.5)*0.001], {radius:7, color:'white', weight:1, fillColor:color, fillOpacity:0.9})
                    .bindPopup(createPopup(r[2], [['Parroquia',r[1]], ['Responsable',r[4]], ['Nota', rowAvg]])).addTo(layersEval);
                }
            });
            fitMap(mapEval, layersEval);

            renderRadar('radarChart', avgs, '#2563eb', 'rgba(37, 99, 235, 0.2)');
        }

        // --- LOGICA REPORTE (TAB 3) ---
        function prepareReport() {
            const d = window.REPORT_DATA;
            if(!d) return;

            document.getElementById('repLocation').innerText = d.name;

            // 1. Llenar Datos Diagnóstico
            let alarmas = d.cap.filter(r=>r[11]==='SI').length;
            let salud = d.cap.filter(r=>r[6]==='SI').length;
            let veh = d.cap.filter(r=>r[13]==='SI').length;
            let total = d.cap.length || 1;
            
            document.getElementById('repCapSalud').innerText = Math.round((salud/total)*100) + "%";
            document.getElementById('repCapAlarma').innerText = Math.round((alarmas/total)*100) + "%";
            document.getElementById('repCapVeh').innerText = Math.round((veh/total)*100) + "%";

            // Gráfico Barras Reporte
            renderBar('chartRepBar', ['Salud', 'Alarmas', 'Vehículos'], [salud, alarmas, veh], '#475569');
            
            // Texto Dictamen
            document.getElementById('repTxtObj1').innerText = `Se han evaluado ${total} puntos territoriales. La cobertura de salud es del ${Math.round((salud/total)*100)}%, mientras que los sistemas de alerta temprana cubren el ${Math.round((alarmas/total)*100)}%. Se recomienda priorizar la inversión en zonas sin cobertura vehicular (${Math.round((veh/total)*100)}%).`;

            // 2. Llenar Datos Evaluación
            let sums = new Array(8).fill(0);
            d.eval.forEach(r => { for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]); });
            let avgs = sums.map(s => (s/(d.eval.length||1)).toFixed(1));

            renderRadar('chartRepRadar', avgs, '#dc2626', 'rgba(220, 38, 38, 0.1)'); // Radar Rojo

            // 3. Mapa Reporte (Puntos combinados o solo evaluación)
            layersRep.clearLayers();
            // Poner puntos de Eval (son los más relevantes para el mapa social)
            d.eval.forEach(r => {
                let lat = parseFloat(r[5]), lng = parseFloat(r[6]);
                if(lat && lng) {
                    let rowAvg=0; for(let i=0;i<8;i++) rowAvg+=Number(r[i+7]); rowAvg=(rowAvg/8).toFixed(1);
                    let color = rowAvg>=4?'#16a34a':(rowAvg>=3?'#f59e0b':'#dc2626');
                    L.circleMarker([lat+(Math.random()-0.5)*0.002, lng+(Math.random()-0.5)*0.002], {radius:6, color:'#333', weight:1, fillColor:color, fillOpacity:1}).addTo(layersRep);
                }
            });
            setTimeout(() => fitMap(mapRep, layersRep), 500);

            // 4. Grid Variables
            const grid = document.getElementById('repGridVars'); grid.innerHTML = "";
            avgs.forEach((v, i) => {
                let color = v>=4?'#16a34a':(v>=3?'#d97706':'#dc2626');
                grid.innerHTML += `<div class="dict-card"><span class="dict-name">${LABELS_VAR[i]}</span><span class="dict-score" style="color:${color}">${v}</span></div>`;
            });

            // 5. Tabla
            const tbody = document.getElementById('repTableBody'); tbody.innerHTML = "";
            d.eval.slice(0, 5).forEach(r => {
                let avg=0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg=(avg/8).toFixed(1);
                tbody.innerHTML += `<tr><td>${r[2]}</td><td>${r[4]}</td><td>${new Date(r[0]).toLocaleDateString()}</td><td class="text-center fw-bold">${avg}</td></tr>`;
            });
        }

        // HELPERS CHARTS
        function renderBar(id, labels, data, color) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar', data: { labels: labels, datasets: [{ data: data, backgroundColor: color, borderRadius: 4 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { display: false } } } }
            });
        }
        function renderRadar(id, data, color, bg) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'radar', data: { labels: LABELS_VAR, datasets: [{ data: data, borderColor: color, backgroundColor: bg, pointBackgroundColor: color, pointRadius: 2 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { min: 0, max: 5, ticks: { display: false }, pointLabels: { font: { size: 9 } } } } }
            });
        }
    </script>
</body>
</html>
