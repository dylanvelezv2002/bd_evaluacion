<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Riesgos | UEB - GAD</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- DISEÑO CLEAN UI V3.0 (CON REPORTE A4) --- */
        :root {
            --bg-body: #f1f5f9; --surface: #ffffff;
            --primary: #2563eb; --primary-dark: #1e3a8a;
            --text-main: #0f172a; --text-muted: #64748b;
            --border-light: #e2e8f0; --radius: 16px;
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.03), 0 4px 6px -2px rgba(0, 0, 0, 0.01);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding-bottom: 60px; }
        
        /* ESTILOS GENERALES DE LA APP (Mismos de antes) */
        .top-bar { background: var(--surface); padding: 1.2rem 3rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); border-bottom: 1px solid var(--border-light); position: sticky; top: 0; z-index: 1000; }
        .project-title { font-size: 1.25rem; font-weight: 800; color: var(--primary-dark); }
        .project-subtitle { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-select { background-color: #f8fafc; border: 1px solid var(--border-light); border-radius: 10px; cursor: pointer; }
        .btn-dark { background-color: var(--text-main); border: none; border-radius: 10px; }
        .nav-pills { background: #e2e8f0; padding: 4px; border-radius: 12px; display: inline-flex; }
        .nav-pills .nav-link { color: var(--text-muted); font-weight: 600; font-size: 0.85rem; padding: 8px 20px; border-radius: 9px; border: none; }
        .nav-pills .nav-link.active { background-color: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-weight: 700; }
        
        .clean-card { background: var(--surface); border-radius: var(--radius); padding: 1.5rem; height: 100%; box-shadow: var(--shadow-card); display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
        .kpi-val { font-size: 2.5rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 4px; }
        .kpi-lbl { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .map-container { height: 450px; width: 100%; border-radius: var(--radius); background: #e2e8f0; z-index: 1; }
        
        /* POPUPS LEAFLET ESTILIZADOS */
        .leaflet-popup-content-wrapper { border-radius: 12px !important; padding: 0 !important; overflow: hidden; }
        .popup-header { background: var(--primary); color: white; padding: 8px 12px; font-size: 0.8rem; font-weight: 700; }
        .popup-body { padding: 10px 12px; font-size: 0.85rem; background: white; }
        .popup-row { display: flex; justify-content: space-between; margin-bottom: 4px; }

        /* --- HOJA A4 PARA REPORTE (CSS ESPECÍFICO) --- */
        .a4-sheet {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
            color: #1e293b;
        }
        
        /* Header Reporte */
        .report-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; }
        .report-logos { display: flex; gap: 15px; }
        .logo-box { width: 50px; height: 50px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 0.7rem; }
        .report-title-block { text-align: right; }
        .rt-main { font-size: 1.4rem; font-weight: 900; color: #0f172a; letter-spacing: -0.5px; text-transform: uppercase; }
        .rt-sub { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }

        /* KPIs Reporte */
        .report-kpis { display: flex; justify-content: space-between; margin-bottom: 30px; text-align: center; }
        .rk-item { flex: 1; border-right: 1px solid #e2e8f0; }
        .rk-item:last-child { border: none; }
        .rk-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 5px; letter-spacing: 1px; }
        .rk-val { font-size: 2.2rem; font-weight: 800; color: var(--primary); }
        .rk-status { font-size: 1.5rem; font-weight: 800; text-transform: uppercase; color: #f59e0b; }

        /* Secciones Reporte */
        .section-title-bar { border-left: 4px solid var(--primary); padding-left: 10px; background: #f8fafc; margin-bottom: 15px; padding-top: 5px; padding-bottom: 5px; }
        .st-text { font-weight: 800; font-size: 0.85rem; text-transform: uppercase; color: #334155; }
        
        /* Grilla Variables */
        .vars-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 25px; }
        .var-box { border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; }
        .vb-head { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .vb-name { font-weight: 700; font-size: 0.8rem; color: var(--primary-dark); }
        .vb-val { font-weight: 800; font-size: 0.9rem; }
        .vb-desc { font-size: 0.7rem; color: #64748b; line-height: 1.3; }

        /* Tabla Reporte */
        .report-table th { background: #f1f5f9 !important; font-size: 0.7rem; text-transform: uppercase; color: #475569; font-weight: 800; padding: 8px; }
        .report-table td { font-size: 0.75rem; padding: 6px 8px; border-color: #e2e8f0; color: #334155; }
        
        /* Map & Chart in Report */
        .report-visual-row { display: flex; gap: 20px; height: 280px; margin-bottom: 25px; }
        .rv-map { flex: 1; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .rv-chart { flex: 1; display: flex; align-items: center; justify-content: center; border: 1px solid #f8fafc; }

        /* UTILS & PRELOADER */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner-custom { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* IMPRESIÓN: Oculta todo menos la hoja A4 */
        @media print {
            body * { visibility: hidden; }
            .a4-sheet, .a4-sheet * { visibility: visible; }
            .a4-sheet { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
            @page { size: A4; margin: 10mm; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="spinner-custom mb-3"></div>
        <div class="text-secondary small fw-bold ls-1">GENERANDO ENTORNO...</div>
    </div>

    <div class="top-bar no-print">
        <div class="header-content-left">
            <div class="project-title"><i class="bi bi-activity text-primary me-2"></i>SISTEMA DE MONITOREO</div>
            <div class="project-subtitle ps-1">Plataforma de Gestión de Riesgos</div>
        </div>
        <div class="header-content-right d-flex gap-3">
            <select id="parroquiaFilter" class="form-select fw-bold" style="width: 240px;" onchange="applyFilter()">
                <option value="ALL">Vista General Provincial</option>
            </select>
            <button onclick="printReport()" class="btn btn-dark btn-sm fw-bold px-4"><i class="bi bi-printer-fill me-2"></i>IMPRIMIR REPORTE</button>
        </div>
    </div>

    <div class="container-fluid px-4 px-md-5 mb-5" style="max-width: 1600px;">
        
        <div class="d-flex justify-content-center justify-content-lg-start mb-4 no-print">
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-obj1">1. DIAGNÓSTICO</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-obj2">2. EVALUACIÓN SOCIAL</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="renderReportView()">3. GENERAR REPORTE PDF</button></li>
            </ul>
        </div>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-obj1">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Total GADs</div><div class="kpi-val" id="capTotal">0</div></div><i class="bi bi-building fs-1 text-light text-secondary"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Sist. Alerta</div><div class="kpi-val text-primary" id="capAlarma">0%</div></div><i class="bi bi-broadcast fs-1 text-primary opacity-25"></i></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Vehículos</div><div class="kpi-val text-success" id="capVehiculo">0%</div></div><i class="bi bi-truck fs-1 text-success opacity-25"></i></div></div>
                </div>
                <div class="clean-card p-0 mb-4"><div id="mapCap" class="map-container"></div></div>
                <div class="clean-card"><h5 class="fw-bold text-primary small">DICTAMEN TÉCNICO</h5><div id="obj1ReportText" class="small text-muted">Analizando...</div></div>
            </div>

            <div class="tab-pane fade" id="pills-obj2">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card p-4"><div><div class="kpi-lbl">Índice Global</div><div class="kpi-val text-primary" id="kpiPromedio">0.0</div></div></div></div>
                    <div class="col-md-8"><div class="clean-card p-0"><div id="mapEval" class="map-container"></div></div></div>
                </div>
                <div class="row g-4"><div class="col-12"><div class="clean-card"><div style="height:250px"><canvas id="radarChart"></canvas></div></div></div></div>
            </div>

            <div class="tab-pane fade" id="pills-report">
                <div class="d-flex justify-content-center bg-secondary bg-opacity-10 py-5 rounded-4">
                    
                    <div class="a4-sheet">
                        
                        <div class="report-header">
                            <div class="report-logos">
                                <div class="logo-box"><i class="bi bi-shield-fill fs-4"></i></div> <div class="logo-box"><i class="bi bi-bank2 fs-4"></i></div> </div>
                            <div class="report-title-block">
                                <div class="rt-main">INFORME DE EVALUACIÓN</div>
                                <div class="rt-sub" id="reportLocation">GAD PROVINCIAL SDT</div>
                            </div>
                        </div>

                        <div class="report-kpis">
                            <div class="rk-item">
                                <div class="rk-lbl">COMUNIDADES</div>
                                <div class="rk-val" id="repKpiCount">0</div>
                            </div>
                            <div class="rk-item">
                                <div class="rk-lbl">ÍNDICE GLOBAL</div>
                                <div class="rk-val" id="repKpiIndex">0.0</div>
                            </div>
                            <div class="rk-item">
                                <div class="rk-lbl">ESTADO</div>
                                <div class="rk-status" id="repKpiStatus">MEDIA</div>
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-6"><div class="section-title-bar"><span class="st-text">PERCEPCIÓN SOCIAL</span></div></div>
                            <div class="col-6"><div class="section-title-bar"><span class="st-text">ANÁLISIS FACTORIAL</span></div></div>
                        </div>
                        <div class="report-visual-row">
                            <div class="rv-map" id="mapReport"></div>
                            <div class="rv-chart">
                                <div style="width: 90%; height: 90%;"><canvas id="radarReport"></canvas></div>
                            </div>
                        </div>

                        <div class="section-title-bar"><span class="st-text">DICTAMEN TÉCNICO POR VARIABLE</span></div>
                        <div class="vars-grid" id="reportGridVars">
                            </div>

                        <div class="section-title-bar"><span class="st-text">REGISTRO DE EVALUACIONES</span></div>
                        <table class="table table-bordered report-table mb-0">
                            <thead><tr><th>Comunidad</th><th>Responsable</th><th>Fecha</th><th class="text-center">Puntaje</th></tr></thead>
                            <tbody id="reportTableBody"></tbody>
                        </table>

                        <div class="mt-4 pt-3 border-top d-flex justify-content-between text-muted" style="font-size: 0.6rem;">
                            <span>Generado Automáticamente por Sistema Monitor v2.5</span>
                            <span>Fecha de Emisión: <span id="printDate"></span></span>
                        </div>

                    </div>
                    </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- LÓGICA JS (INTEGRADA CON EL REPORTE) ---
        const BASE_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";
        const PROXY_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(BASE_URL);
        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];
        const LABELS_OBJ2 = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];
        
        let DATA_CAP=[], DATA_EVAL=[], mapCap, mapEval, mapReport, chartInstances={};
        let currentFilteredData = [];

        // --- TEXTOS TÉCNICOS ALEATORIOS PARA EL REPORTE ---
        const reportTexts = {
            high: "Estándar óptimo.", mid: "Capacidad en desarrollo.", low: "Requiere atención prioritaria."
        };

        window.onload = () => {
            const sel = document.getElementById('parroquiaFilter');
            PARROQUIAS.sort().forEach(p => sel.add(new Option(p, p)));
            initMaps();
            
            fetch(PROXY_URL).then(r => r.json()).then(d => {
                document.getElementById('preloader').style.display='none';
                if(d.status==='success') { DATA_CAP=d.dataCap||[]; DATA_EVAL=d.dataEval||[]; applyFilter(); }
            }).catch(e => { document.getElementById('preloader').style.display='none'; Swal.fire("Offline", "Cargando datos locales simulados...", "warning"); });
            
            document.getElementById('printDate').innerText = new Date().toLocaleDateString();
        };

        function initMaps() {
            // Mapas normales
            mapCap = L.map('mapCap', {zoomControl:false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapCap);
            mapEval = L.map('mapEval', {zoomControl:false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapEval);
            
            // Mapa del Reporte (Estático)
            mapReport = L.map('mapReport', {zoomControl:false, attributionControl: false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png').addTo(mapReport);
            
            // Fix resize issues
            document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(el => {
                el.addEventListener('shown.bs.tab', () => { 
                    mapCap.invalidateSize(); mapEval.invalidateSize(); 
                    if(el.dataset.bsTarget === '#pills-report') setTimeout(()=>mapReport.invalidateSize(), 200);
                });
            });
        }

        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            const isProv = val === 'ALL';
            
            // Filtrar datos
            const fCap = isProv ? DATA_CAP : DATA_CAP.filter(r => r[1] === val);
            currentFilteredData = isProv ? DATA_EVAL : DATA_EVAL.filter(r => r[1] === val); // Guardar para el reporte

            // Renderizar Pestañas Normales
            renderObj1(fCap, isProv, val);
            renderObj2(currentFilteredData);
            
            // Si estamos en la pestaña de reporte, actualizarla también
            if(document.querySelector('#pills-report').classList.contains('active')) {
                renderReportView();
            }
        }

        function renderObj1(data, isProv, name) {
            document.getElementById('capTotal').innerText = data.length;
            let alarmas = data.filter(r=>r[11]==='SI').length;
            let veh = data.filter(r=>r[13]==='SI').length;
            document.getElementById('capAlarma').innerText = Math.round((alarmas/data.length||1)*100)+"%";
            document.getElementById('capVehiculo').innerText = Math.round((veh/data.length||1)*100)+"%";
            // (Lógica de mapa y texto recortada para brevedad, mantener la anterior)
        }

        function renderObj2(data) {
            // Calculos básicos pestaña 2 (Radar principal, KPIs)
            let sums = new Array(8).fill(0);
            data.forEach(r => { for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]); });
            const avgs = sums.map(s => (s/(data.length||1)).toFixed(1));
            const global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            
            document.getElementById('kpiPromedio').innerText = global;
            
            // Radar Pestaña 2
            if(chartInstances['radar']) chartInstances['radar'].destroy();
            chartInstances['radar'] = new Chart(document.getElementById('radarChart'), {
                type:'radar', 
                data:{labels:LABELS_OBJ2, datasets:[{label:'Nivel', data:avgs, backgroundColor:'rgba(37, 99, 235, 0.2)', borderColor:'#2563eb'}]}
            });
        }

        // --- FUNCIÓN PRINCIPAL: GENERAR VISTA DE REPORTE ---
        function renderReportView() {
            const val = document.getElementById('parroquiaFilter').value;
            const data = currentFilteredData;
            
            // 1. Header Data
            document.getElementById('reportLocation').innerText = val === 'ALL' ? 'CONSOLIDADO PROVINCIAL' : 'PARROQUIA ' + val.toUpperCase();
            document.getElementById('repKpiCount').innerText = data.length;
            
            // 2. Calcular Promedios
            let sums = new Array(8).fill(0);
            data.forEach(r => { for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]); });
            const avgs = sums.map(s => (s/(data.length||1)).toFixed(1));
            const global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            
            document.getElementById('repKpiIndex').innerText = global;
            const st = document.getElementById('repKpiStatus');
            if(global>=4) { st.innerText="SÓLIDA"; st.style.color="#16a34a"; } 
            else if(global>=3) { st.innerText="MEDIA"; st.style.color="#d97706"; } 
            else { st.innerText="CRÍTICA"; st.style.color="#dc2626"; }

            // 3. Mapa Reporte (Puntos Simples)
            mapReport.eachLayer((layer) => { if(!!layer.toGeoJSON) mapReport.removeLayer(layer); }); // Limpiar marcadores
            let bounds = [];
            data.forEach(r => {
                let lat = parseFloat(r[5])+(Math.random()-0.5)*0.001;
                let lng = parseFloat(r[6])+(Math.random()-0.5)*0.001;
                let avg = 0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg/=8;
                let color = avg>=4?'#16a34a':(avg>=3?'#d97706':'#dc2626');
                L.circleMarker([lat, lng], {radius:5, fillColor:color, color:'black', weight:1, fillOpacity:1}).addTo(mapReport);
                bounds.push([lat, lng]);
            });
            if(bounds.length) mapReport.fitBounds(bounds, {padding:[20,20]});

            // 4. Radar Reporte (Nuevo Canvas)
            if(chartInstances['radarReport']) chartInstances['radarReport'].destroy();
            chartInstances['radarReport'] = new Chart(document.getElementById('radarReport'), {
                type:'radar', 
                data:{
                    labels:LABELS_OBJ2, 
                    datasets:[{
                        label:'Nivel', data:avgs, 
                        backgroundColor:'rgba(220, 38, 38, 0.2)', // Rojo suave como en tu imagen
                        borderColor:'#dc2626', 
                        pointBackgroundColor:'#dc2626',
                        pointRadius: 2
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 5, ticks: { display: false }, grid: { color: '#e2e8f0' }, pointLabels: { font: { size: 9, family: 'Inter' } } } },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });

            // 5. Grilla de Variables (Dictamen Técnico)
            const grid = document.getElementById('reportGridVars'); grid.innerHTML="";
            avgs.forEach((avg, i) => {
                let color = avg>=4?'#16a34a':(avg>=3?'#d97706':'#dc2626');
                let text = avg>=4 ? reportTexts.high : (avg>=3 ? reportTexts.mid : reportTexts.low);
                grid.innerHTML += `
                <div class="var-box">
                    <div class="vb-head"><span class="vb-name">${LABELS_OBJ2[i]}</span><span class="vb-val" style="color:${color}">${avg}</span></div>
                    <div class="vb-desc">${text}</div>
                </div>`;
            });

            // 6. Tabla Reporte (Últimos 5 registros)
            const tbody = document.getElementById('reportTableBody'); tbody.innerHTML="";
            data.slice(0, 6).forEach(r => {
                let avg = 0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg=(avg/8).toFixed(1);
                tbody.innerHTML += `<tr><td>${r[2]}</td><td>${r[4]}</td><td>${new Date(r[0]).toLocaleDateString()}</td><td class="text-center fw-bold">${avg}</td></tr>`;
            });
        }

        function printReport() {
            // Asegurar renderizado antes de imprimir
            renderReportView();
            setTimeout(() => window.print(), 500);
        }
    </script>
</body>
</html>
