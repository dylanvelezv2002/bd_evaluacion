<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Situaci贸n | Gesti贸n de Riesgos</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #2563eb;
            --bg: #f1f5f9; --card: #ffffff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--primary); }

        /* PRELOADER */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 4px solid #e2e8f0;
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* NAVBAR & FILTRO */
        .navbar { background: var(--card); border-bottom: 1px solid #e2e8f0; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .brand-text { font-weight: 800; letter-spacing: -0.5px; color: var(--primary); font-size: 1.2rem; }
        
        .filter-select {
            background-color: #f8fafc; border: 1px solid #cbd5e1; font-weight: 600; color: var(--secondary);
            padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; width: 250px;
        }

        /* CARDS */
        .tech-card {
            background: var(--card); border: 1px solid #e2e8f0; border-radius: 10px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);
            height: 100%; display: flex; flex-direction: column; justify-content: space-between;
        }
        .kpi-value { font-size: 2.2rem; font-weight: 800; line-height: 1; }
        .kpi-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }

        /* MONITOR TERRITORIAL (MAPA DE CALOR) */
        .territory-card {
            background: white; border-radius: 8px; padding: 12px;
            border-left: 5px solid #ccc; margin-bottom: 10px;
            transition: transform 0.2s; cursor: pointer;
        }
        .territory-card:hover { transform: translateX(5px); }
        .t-name { font-weight: 700; font-size: 0.9rem; }
        .t-score { font-weight: 800; font-size: 1.1rem; float: right; }
        
        /* COLORES DE ESTADO */
        .border-success { border-left-color: var(--success) !important; }
        .border-warning { border-left-color: var(--warning) !important; }
        .border-danger { border-left-color: var(--danger) !important; }
        .text-success { color: var(--success) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-danger { color: var(--danger) !important; }

        /* ANLISIS TCNICO */
        .ai-analysis-box {
            background-color: #f8fafc; border-left: 3px solid var(--accent);
            padding: 12px; font-size: 0.8rem; color: #475569; margin-top: 15px;
            border-radius: 0 4px 4px 0; min-height: 50px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .ai-label { font-size: 0.65rem; font-weight: 700; color: var(--accent); text-transform: uppercase; margin-bottom: 4px; }

        .btn-icon { border: none; background: transparent; color: #94a3b8; transition: 0.2s; }
        .btn-icon:hover { color: var(--accent); transform: scale(1.1); }

        @media print {
            .no-print { display: none !important; }
            .tech-card { border: 1px solid #ccc; break-inside: avoid; }
            body { background: white; }
        }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="loader-spinner"></div>
        <h6 class="fw-bold text-secondary">Conectando Sala de Situaci贸n...</h6>
        <small class="text-muted">UEB - GAD Provincial SDT</small>
    </div>

    <nav class="navbar fixed-top no-print">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <span class="brand-text me-4"><i class="bi bi-grid-1x2-fill text-primary me-2"></i>War Room de Riesgos</span>
                
                <select id="parroquiaFilter" class="filter-select form-select form-select-sm shadow-sm" onchange="applyFilter()">
                    <option value="ALL"> Todas las Parroquias</option>
                    </select>
            </div>

            <div class="d-flex gap-2">
                <button onclick="downloadCSV()" class="btn btn-outline-success btn-sm fw-bold"><i class="bi bi-file-earmark-excel"></i> Data</button>
                <button onclick="window.print()" class="btn btn-primary btn-sm fw-bold"><i class="bi bi-printer"></i> PDF</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4" style="margin-top: 90px; max-width: 1600px;">
        
        <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-2">
            <div>
                <h5 class="fw-bold text-secondary m-0">REPORTE SITUACIONAL</h5>
                <h2 class="fw-bold text-primary m-0" id="reportTitle">Consolidado Provincial</h2>
            </div>
            <div class="text-end">
                <small class="text-muted fw-bold">ltima Actualizaci贸n</small>
                <div class="fw-bold"><script>document.write(new Date().toLocaleDateString())</script></div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="tech-card align-items-center justify-content-center py-4">
                    <div class="kpi-label">Muestra (Encuestas)</div>
                    <div class="kpi-value" id="kpiTotal">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tech-card align-items-center justify-content-center py-4">
                    <div class="kpi-label">ndice de Gesti贸n (1-5)</div>
                    <div class="kpi-value text-primary" id="kpiPromedio">0.0</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="tech-card py-3 px-4 flex-row align-items-center justify-content-between">
                    <div>
                        <div class="kpi-label">Nivel de Preparaci贸n</div>
                        <div class="kpi-value" id="kpiEstado" style="font-size: 1.8rem">-</div>
                    </div>
                    <i class="bi bi-shield-check fs-1 text-secondary opacity-25"></i>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-primary fw-bold m-0">ANLISIS DE INDICADORES (OBJETIVO 2)</h6>
                    <span class="badge bg-light text-dark border">8 Variables Evaluadas</span>
                </div>
                
                <div class="row" id="chartsGrid">
                    </div>
            </div>

            <div class="col-lg-4">
                
                <div class="tech-card mb-3" style="height: auto;">
                    <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                        <h6 class="text-secondary fw-bold m-0 text-uppercase" style="font-size: 0.8rem">Perfil de Capacidades</h6>
                        <button class="btn-icon no-print" onclick="downloadCanvas('radarChart')"><i class="bi bi-camera"></i></button>
                    </div>
                    <div style="height: 280px;">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div class="ai-analysis-box mt-2">
                        <span class="ai-label">SNTESIS DEL PERFIL:</span>
                        <span id="radarAnalysisText">Cargando...</span>
                    </div>
                </div>

                <div class="tech-card" style="height: auto;">
                    <h6 class="text-secondary fw-bold text-uppercase mb-3 border-bottom pb-2" style="font-size: 0.8rem">Monitor Territorial (Heatmap)</h6>
                    <div id="territoryGrid" style="max-height: 400px; overflow-y: auto;">
                        </div>
                </div>

            </div>
        </div>
        
        <div class="row mt-4 mb-5 no-print">
            <div class="col-12">
                <div class="tech-card">
                    <h6 class="text-secondary fw-bold text-uppercase mb-3">Base de Datos Filtrada</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover" style="font-size: 0.8rem;">
                            <thead class="table-light"><tr><th>Fecha</th><th>Parroquia</th><th>Comunidad</th><th>Cargo</th></tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // 锔 PEGA TU URL DE GOOGLE APPS SCRIPT AQU
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";

        // VARIABLES GLOBALES
        let RAW_DATA = []; // Todos los datos crudos
        let FILTERED_DATA = []; // Datos filtrados actuales
        let chartInstances = {}; // Para destruir gr谩ficas al actualizar

        // TEXTOS "IA" (MOTOR DE VARIACIN)
        const aiEngine = {
            generic: {
                low: ["Nivel cr铆tico detectado. Requiere plan de acci贸n urgente.", "Debilidad estructural que afecta la operatividad.", "Indicador deficiente. Priorizar en la capacitaci贸n."],
                mid: ["Desempe帽o regular con brechas operativas.", "Estabilidad parcial. Se requieren ajustes t茅cnicos.", "Nivel aceptable pero no sostenible a largo plazo."],
                high: ["Fortaleza consolidada. Modelo de gesti贸n exitoso.", "Excelente desempe帽o. Referente para otras zonas.", "Objetivo cumplido con altos est谩ndares."]
            }
        };
        // Funci贸n simple para texto aleatorio
        function getAiText(level) {
            const texts = aiEngine.generic[level];
            return texts[Math.floor(Math.random() * texts.length)];
        }

        const labels = [
            "1. Participaci贸n", "2. Compromiso", "3. Capacitaci贸n", "4. Plan Comunitario",
            "5. Comunicaci贸n", "6. Articulaci贸n", "7. Inclusi贸n", "8. Replicabilidad"
        ];

        // --- INICIO ---
        window.onload = () => {
            fetch(API_URL)
                .then(res => res.json())
                .then(response => {
                    document.getElementById('preloader').style.display = 'none';
                    if(response.data) {
                        RAW_DATA = response.data;
                        initFilters();     // 1. Llenar Select
                        applyFilter();     // 2. Cargar Dashboard
                        renderTerritoryMonitor(); // 3. Cargar Monitor Lateral
                    }
                })
                .catch(err => { console.error(err); alert("Error cargando datos"); });
        };

        // --- 1. SISTEMA DE FILTRADO ---
        function initFilters() {
            const select = document.getElementById('parroquiaFilter');
            // Obtener parroquias 煤nicas de la columna 1 (铆ndice 1)
            const parroquias = [...new Set(RAW_DATA.map(row => row[1]))].sort();
            
            parroquias.forEach(p => {
                if(p) { // Evitar vac铆os
                    const option = document.createElement('option');
                    option.value = p;
                    option.text = ` ${p}`;
                    select.appendChild(option);
                }
            });
        }

        function applyFilter() {
            const selected = document.getElementById('parroquiaFilter').value;
            
            // Filtrar datos
            if (selected === 'ALL') {
                FILTERED_DATA = RAW_DATA;
                document.getElementById('reportTitle').innerText = "Consolidado Provincial";
            } else {
                FILTERED_DATA = RAW_DATA.filter(row => row[1] === selected);
                document.getElementById('reportTitle').innerText = `Reporte: ${selected}`;
            }

            updateDashboard();
        }

        // --- 2. ACTUALIZAR DASHBOARD ---
        function updateDashboard() {
            const total = FILTERED_DATA.length;
            
            if (total === 0) {
                alert("No hay datos para esta selecci贸n.");
                return;
            }

            // Calcular Promedios
            let sums = new Array(8).fill(0);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            FILTERED_DATA.forEach(row => {
                // Llenar tabla inferior
                tbody.innerHTML += `<tr><td>${new Date(row[0]).toLocaleDateString()}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[4]}</td></tr>`;
                // Sumar (Datos num茅ricos desde 铆ndice 5)
                for(let i=0; i<8; i++) sums[i] += Number(row[i+5]);
            });

            const avgs = sums.map(s => (s/total).toFixed(1));
            const globalAvg = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);

            // KPIs
            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiPromedio').innerText = globalAvg;
            
            const kpiEstado = document.getElementById('kpiEstado');
            if(globalAvg >= 4) { kpiEstado.innerText = "Sostenible"; kpiEstado.className = "kpi-value text-success"; }
            else if(globalAvg >= 3) { kpiEstado.innerText = "En Desarrollo"; kpiEstado.className = "kpi-value text-warning"; }
            else { kpiEstado.innerText = "Cr铆tico"; kpiEstado.className = "kpi-value text-danger"; }

            renderGrid(avgs);
            renderRadar(avgs);
        }

        // --- 3. MONITOR TERRITORIAL (HEATMAP) ---
        function renderTerritoryMonitor() {
            const container = document.getElementById('territoryGrid');
            container.innerHTML = "";
            
            // Agrupar por Parroquia
            const groups = {};
            RAW_DATA.forEach(row => {
                const p = row[1];
                if(!groups[p]) groups[p] = { sum: 0, count: 0 };
                // Sumar todas las 8 preguntas de esa fila
                let rowSum = 0;
                for(let i=0; i<8; i++) rowSum += Number(row[i+5]);
                groups[p].sum += (rowSum / 8); // Promedio de la fila
                groups[p].count++;
            });

            // Renderizar Tarjetas
            for (const [parroquia, data] of Object.entries(groups)) {
                if(!parroquia) continue;
                const score = (data.sum / data.count).toFixed(1);
                let borderClass = "border-danger";
                let textClass = "text-danger";
                
                if(score >= 4) { borderClass = "border-success"; textClass = "text-success"; }
                else if(score >= 3) { borderClass = "border-warning"; textClass = "text-warning"; }

                container.innerHTML += `
                    <div class="territory-card ${borderClass}" onclick="selectParroquia('${parroquia}')">
                        <span class="t-name">${parroquia}</span>
                        <span class="t-score ${textClass}">${score}</span>
                        <div style="font-size:0.75rem; color:#999; margin-top:2px;">${data.count} encuestas</div>
                    </div>
                `;
            }
        }

        // Funci贸n auxiliar para click en el monitor
        function selectParroquia(p) {
            document.getElementById('parroquiaFilter').value = p;
            applyFilter();
        }

        // --- RENDERIZADORES GRFICOS ---
        function renderGrid(avgs) {
            const container = document.getElementById('chartsGrid');
            container.innerHTML = "";

            avgs.forEach((avg, i) => {
                let level = "low"; 
                let color = "#ef4444";
                if(avg >= 4) { level = "high"; color = "#10b981"; }
                else if(avg >= 3) { level = "mid"; color = "#f59e0b"; }

                const text = getAiText(level); // IA simple
                const canvasId = `chart${i}`;
                
                // Destruir gr谩fica previa si existe
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();

                container.innerHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="tech-card p-3 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title text-dark m-0">${labels[i]}</h6>
                                <div>
                                    <span class="badge me-2 text-white" style="background:${color}">${avg}</span>
                                    <button class="btn-icon no-print" onclick="downloadCanvas('${canvasId}')"><i class="bi bi-camera"></i></button>
                                </div>
                            </div>
                            <div style="height: 60px;">
                                <canvas id="${canvasId}"></canvas>
                            </div>
                            <div class="ai-analysis-box">
                                <span class="ai-label">An谩lisis T茅cnico:</span> ${text}
                            </div>
                        </div>
                    </div>
                `;

                // Dibujar (con delay para que exista el elemento)
                setTimeout(() => {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    chartInstances[canvasId] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: [''],
                            datasets: [{ data: [avg], backgroundColor: color, borderRadius: 4, barThickness: 25 }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                            scales: { x: { min: 0, max: 5, display: false }, y: { display: false } },
                            plugins: { legend: { display: false }, tooltip: { enabled: false } }
                        }
                    });
                }, 0);
            });
        }

        function renderRadar(avgs) {
            const canvasId = 'radarChart';
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const ctx = document.getElementById(canvasId).getContext('2d');
            const avg = avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8;
            
            document.getElementById('radarAnalysisText').innerText = avg > 3.5 ? 
                "Perfil balanceado. Listo para fase operativa." : 
                "Asimetr铆as detectadas. Reforzar capacitaci贸n.";

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels.map(l => l.split(". ")[1]),
                    datasets: [{
                        label: 'Nivel', data: avgs,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderColor: '#2563eb', borderWidth: 2,
                        pointBackgroundColor: '#2563eb'
                    }]
                },
                options: {
                    scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { display: false } } },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });
        }

        // --- UTILIDADES ---
        function downloadCanvas(id) {
            const canvas = document.getElementById(id);
            const link = document.createElement('a');
            link.download = `grafica_${id}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function downloadCSV() {
            let csv = "Fecha,Parroquia,Comunidad,Nombre,Cargo,P1,P2,P3,P4,P5,P6,P7,P8\n";
            FILTERED_DATA.forEach(r => {
                csv += r.map(c => `"${c}"`).join(",") + "\n";
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "Reporte_Riesgos.csv";
            link.click();
        }
    </script>
</body>
</html>
