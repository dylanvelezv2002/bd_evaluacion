<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala Situacional | GAD Provincial SDT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #2563eb;
            --bg: #f8fafc; --card: #ffffff;
            --success: #059669; --warning: #d97706; --danger: #dc2626;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--primary); font-size: 0.9rem; }

        /* PRELOADER */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 4px solid #e2e8f0;
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* NAVBAR */
        .navbar { background: var(--card); border-bottom: 1px solid #e2e8f0; padding: 15px 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .brand-text { font-weight: 800; letter-spacing: -0.5px; color: var(--primary); font-size: 1.2rem; }

        /* TARJETAS */
        .tech-card {
            background: var(--card); 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            height: 100%; 
            display: flex; flex-direction: column;
        }
        
        .card-header-title {
            font-size: 0.85rem; font-weight: 700; color: var(--secondary); 
            text-transform: uppercase; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* KPIS GRANDES */
        .kpi-value { font-size: 2.5rem; font-weight: 800; line-height: 1; letter-spacing: -1px; color: var(--primary); }
        .kpi-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; margin-bottom: 5px; }

        /* ANLISIS TCNICO */
        .ai-analysis-box {
            background-color: #f8fafc; border-left: 4px solid var(--accent);
            padding: 15px; font-size: 0.85rem; color: #334155; margin-top: auto;
            border-radius: 0 6px 6px 0; line-height: 1.6; text-align: justify;
        }
        .ai-label { font-size: 0.7rem; font-weight: 800; color: var(--accent); text-transform: uppercase; display: block; margin-bottom: 5px; }

        /* MAPA */
        #map { height: 400px; width: 100%; border-radius: 8px; z-index: 1; border: 1px solid #e2e8f0; }

        /* MONITOR TERRITORIAL */
        .territory-item {
            padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: all 0.2s;
            border-left: 4px solid transparent; display: flex; justify-content: space-between; align-items: center;
        }
        .territory-item:hover { background-color: #f1f5f9; padding-left: 18px; }
        .t-name { font-weight: 600; font-size: 0.9rem; }
        .t-score { font-weight: 800; font-size: 1rem; }

        /* COLORES */
        .border-success { border-left-color: var(--success) !important; }
        .border-warning { border-left-color: var(--warning) !important; }
        .border-danger { border-left-color: var(--danger) !important; }
        .text-success { color: var(--success) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-danger { color: var(--danger) !important; }

        @media print {
            .no-print { display: none !important; }
            .tech-card { border: 1px solid #ccc; break-inside: avoid; box-shadow: none; }
            body { background: white; font-size: 11px; }
            .ai-analysis-box { background: #f9f9f9 !important; border-left-color: #000 !important; }
            #map { height: 300px; }
        }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="loader-spinner"></div>
        <h6 class="fw-bold text-secondary">Cargando Sala Situacional...</h6>
        <small class="text-muted">GAD Provincial Santo Domingo de los Ts谩chilas</small>
    </div>

    <nav class="navbar fixed-top no-print">
        <div class="container-fluid">
            <div class="d-flex align-items-center gap-3">
                <span class="brand-text"><i class="bi bi-grid-1x2-fill text-primary me-2"></i>WAR ROOM RIESGOS</span>
                <select id="parroquiaFilter" class="form-select form-select-sm shadow-sm" style="width: 240px; font-weight:600;" onchange="applyFilter()">
                    <option value="ALL"> Provincia Completa</option>
                    </select>
            </div>
            <div class="d-flex gap-2">
                <button onclick="window.print()" class="btn btn-primary btn-sm fw-bold shadow-sm"><i class="bi bi-printer"></i> Imprimir Reporte</button>
                <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm shadow-sm"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4" style="margin-top: 90px; max-width: 1600px;">
        
        <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-3">
            <div>
                <h5 class="fw-bold text-secondary m-0">INFORME TCNICO PROVINCIAL</h5>
                <h3 class="fw-bold text-primary m-0" id="reportTitle">Consolidado Provincial</h3>
            </div>
            <div class="text-end">
                <span class="badge bg-primary mb-1" style="font-size: 0.8rem;">PROYECTO VINCULACIN 2025</span>
                <div class="small fw-bold text-muted">Fecha de Corte: <script>document.write(new Date().toLocaleDateString())</script></div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="tech-card align-items-center justify-content-center py-4">
                    <div class="kpi-label">Encuestas Procesadas</div>
                    <div class="kpi-value" id="kpiTotal">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tech-card align-items-center justify-content-center py-4">
                    <div class="kpi-label">ndice de Gesti贸n (1-5)</div>
                    <div class="kpi-value text-primary" id="kpiPromedio">0.0</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="tech-card flex-row align-items-center justify-content-between px-5 py-4">
                    <div>
                        <div class="kpi-label">Estado General</div>
                        <div class="fw-bold text-uppercase" id="kpiEstado" style="font-size: 2rem">-</div>
                    </div>
                    <i class="bi bi-shield-check fs-1 opacity-25" style="font-size: 4rem !important;"></i>
                </div>
            </div>
        </div>

        <div class="row g-4">
            
            <div class="col-lg-8">
                
                <div class="tech-card p-0 overflow-hidden mb-4">
                    <div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold m-0 text-primary"><i class="bi bi-geo-alt-fill me-2"></i>MONITOR GEOESPACIAL</h6>
                        <span class="badge bg-white text-dark border">Santo Domingo + La Concordia</span>
                    </div>
                    <div id="map"></div>
                </div>

                <h6 class="text-primary fw-bold mb-4 border-bottom pb-2">ANLISIS ESTRUCTURAL (OBJETIVO 2)</h6>
                <div class="row g-4" id="chartsGrid"></div>
            </div>

            <div class="col-lg-4">
                
                <div class="tech-card mb-4">
                    <div class="card-header-title">
                        <span><i class="bi bi-radar me-2"></i>PERFIL DE CAPACIDADES</span>
                        <button class="btn btn-sm btn-link text-muted p-0" onclick="downloadCanvas('radarChart')"><i class="bi bi-download"></i></button>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div class="ai-analysis-box">
                        <span class="ai-label">SNTESIS DEL PERFIL:</span>
                        <span id="radarAnalysisText">Procesando...</span>
                    </div>
                </div>

                <div class="tech-card mb-4 p-0 overflow-hidden" style="max-height: 500px;">
                    <div class="p-3 bg-light border-bottom">
                        <h6 class="fw-bold m-0 text-secondary" style="font-size:0.8rem">SEMFORO PARROQUIAL</h6>
                    </div>
                    <div id="territoryGrid" style="overflow-y: auto;">
                        </div>
                </div>

                <div class="tech-card p-0 overflow-hidden">
                    <div class="p-3 bg-light border-bottom">
                        <h6 class="fw-bold m-0 text-secondary" style="font-size:0.8rem">BASE DE ACTORES</h6>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0" style="font-size:0.75rem">
                            <thead class="table-light"><tr><th>Parroquia</th><th>Cargo</th><th>Nota</th></tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 锔 TU URL DEL SCRIPT DE GOOGLE
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";

        // LISTA OFICIAL DE PARROQUIAS RURALES (GAD PROVINCIAL)
        const PARROQUIAS_OFICIALES = [
            "Alluriqu铆n", "Puerto Lim贸n", "Luz de Am茅rica", 
            "San Jacinto del B煤a", "Valle Hermoso", "El Esfuerzo", 
            "Santa Mar铆a del Toachi", "La Villegas", "Monterrey", "Plan Piloto"
        ];

        let RAW_DATA = [];
        let FILTERED_DATA = [];
        let map;
        let markersLayer = new L.LayerGroup();
        let chartInstances = {};

        // TEXTOS TCNICOS (IA)
        const techAnalysisDB = {
            generic: {
                low: ["Se identifica una vulnerabilidad cr铆tica en este indicador. La falta de gesti贸n efectiva compromete la operatividad del comit茅 ante eventos adversos. Se recomienda una intervenci贸n correctiva inmediata.", "Desempe帽o deficiente. Los resultados evidencian una desconexi贸n estructural que impide alcanzar los objetivos de resiliencia planteados en el proyecto."],
                mid: ["Estabilidad operativa parcial. Si bien existen capacidades instaladas, estas son insuficientes para escenarios de alta complejidad. Se requiere un plan de fortalecimiento a mediano plazo.", "Nivel de gesti贸n regular. El indicador cumple con los m铆nimos normativos, pero carece de la robustez necesaria para garantizar sostenibilidad sin apoyo externo."],
                high: ["Capacidad de respuesta consolidada. El comit茅 demuestra autonom铆a y suficiencia t茅cnica en este aspecto, constituy茅ndose como un referente de buenas pr谩cticas locales.", "Excelente desempe帽o institucional. La gesti贸n en este componente valida la metodolog铆a aplicada y sugiere un alto potencial de replicabilidad en otros territorios."]
            }
        };

        function getAiText(score) {
            const level = score >= 4 ? 'high' : (score >= 3 ? 'mid' : 'low');
            const texts = techAnalysisDB.generic[level];
            return texts[Math.floor(Math.random() * texts.length)];
        }

        const labels = ["1. Participaci贸n", "2. Compromiso", "3. Capacitaci贸n", "4. Plan Local", "5. Comunicaci贸n", "6. Articulaci贸n", "7. Inclusi贸n", "8. R茅plica"];

        window.onload = () => {
            initMap();
            fetch(API_URL).then(r=>r.json()).then(d => {
                document.getElementById('preloader').style.display = 'none';
                if(d.data) { RAW_DATA=d.data; initFilters(); applyFilter(); }
            });
        };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO', maxZoom: 19
            }).addTo(map);
            markersLayer.addTo(map);
            L.control.zoom({position: 'bottomright'}).addTo(map);
        }

        function initFilters() {
            const sel = document.getElementById('parroquiaFilter');
            // Cargamos la lista oficial fija para que siempre aparezcan todas
            PARROQUIAS_OFICIALES.sort().forEach(p => {
                sel.add(new Option(p, p));
            });
        }

        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            FILTERED_DATA = val === 'ALL' ? RAW_DATA : RAW_DATA.filter(r=>r[1]===val);
            document.getElementById('reportTitle').innerText = val === 'ALL' ? "Consolidado Provincial" : `Reporte: ${val}`;
            
            if(val !== 'ALL' && FILTERED_DATA.length > 0 && FILTERED_DATA[0][5]) {
                map.setView([FILTERED_DATA[0][5], FILTERED_DATA[0][6]], 13);
            } else {
                map.setView([-0.2530, -79.1754], 10);
            }
            updateDashboard();
        }

        function updateDashboard() {
            const total = FILTERED_DATA.length;
            // Si no hay datos, limpiar y salir (pero mostrar ceros)
            if(total===0) {
                 document.getElementById('kpiTotal').innerText = "0";
                 document.getElementById('kpiPromedio').innerText = "0.0";
                 document.getElementById('kpiEstado').innerText = "SIN DATOS";
                 document.getElementById('kpiEstado').className = "fw-bold text-muted text-uppercase";
                 markersLayer.clearLayers();
                 document.getElementById('chartsGrid').innerHTML = "<div class='col-12 text-center text-muted py-5'>No hay encuestas registradas para esta parroquia a煤n.</div>";
                 document.getElementById('territoryGrid').innerHTML = "";
                 document.getElementById('tableBody').innerHTML = "";
                 return;
            }

            markersLayer.clearLayers();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            let sums = new Array(8).fill(0);

            FILTERED_DATA.forEach(row => {
                let s = 0; for(let i=0; i<8; i++) s+=Number(row[i+7]);
                let avg = (s/8).toFixed(1);
                for(let i=0; i<8; i++) sums[i]+=Number(row[i+7]);

                tbody.innerHTML += `<tr><td>${row[1]}</td><td>${row[4]}</td><td><b>${avg}</b></td></tr>`;

                if(row[5] && row[6]) {
                    let color = avg>=4 ? '#059669' : (avg>=3 ? '#d97706' : '#dc2626');
                    let popup = `<div style="font-family:Inter; min-width:180px;">
                        <div style="border-bottom:2px solid ${color}; font-weight:bold; margin-bottom:5px;">${row[2]}</div>
                        <div style="font-size:11px; color:#444;">
                            <b>Rep:</b> ${row[3]}<br>
                            <b>Cargo:</b> ${row[4]}<br>
                            <b>Parr:</b> ${row[1]}
                        </div>
                        <div style="background:${color}; color:white; text-align:center; border-radius:3px; margin-top:5px; font-weight:bold;">NOTA: ${avg}</div>
                    </div>`;
                    L.circleMarker([row[5], row[6]], {radius: 8, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9}).bindPopup(popup).addTo(markersLayer);
                }
            });

            const avgs = sums.map(s=>(s/total).toFixed(1));
            const global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            
            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiPromedio').innerText = global;
            const kpiState = document.getElementById('kpiEstado');
            
            if(global>=4) { kpiState.innerText = "RESILIENTE"; kpiState.className = "fw-bold text-success text-uppercase"; }
            else if(global>=3) { kpiState.innerText = "EN DESARROLLO"; kpiState.className = "fw-bold text-warning text-uppercase"; }
            else { kpiState.innerText = "CRTICO"; kpiState.className = "fw-bold text-danger text-uppercase"; }

            renderCharts(avgs);
            renderRadar(avgs);
            renderMonitor();
        }

        function renderCharts(avgs) {
            const container = document.getElementById('chartsGrid');
            container.innerHTML = "";
            avgs.forEach((avg, i) => {
                const color = avg>=4 ? '#059669' : (avg>=3 ? '#d97706' : '#dc2626');
                const text = getAiText(avg);
                const id = `chart${i}`;
                
                container.innerHTML += `
                <div class="col-md-6">
                    <div class="tech-card p-3 h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="card-header-title m-0 p-0 border-0 text-dark">${labels[i]}</h6>
                            <span class="badge" style="background:${color}">${avg}</span>
                        </div>
                        <div style="height: 40px;"><canvas id="${id}"></canvas></div>
                        <div class="ai-analysis-box">${text}</div>
                    </div>
                </div>`;

                setTimeout(() => {
                    new Chart(document.getElementById(id), {
                        type: 'bar',
                        data: { labels: [''], datasets: [{ data: [avg], backgroundColor: color, barThickness: 15, borderRadius: 4 }] },
                        options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x:{min:0, max:5, display:false}, y:{display:false} }, plugins:{legend:{display:false}} }
                    });
                }, 0);
            });
        }

        function renderMonitor() {
            const c = document.getElementById('territoryGrid'); c.innerHTML = "";
            const g = {};
            // Inicializar todas las parroquias oficiales en 0
            PARROQUIAS_OFICIALES.forEach(p => { g[p] = {s:0, c:0}; });

            // Llenar con datos reales
            RAW_DATA.forEach(r => {
                const p = r[1]; 
                if(g[p]) {
                   let sum=0; for(let i=0;i<8;i++) sum+=Number(r[i+7]);
                   g[p].s+=sum/8; g[p].c++;
                }
            });

            Object.keys(g).sort().forEach(p => {
                const d = g[p];
                const s = d.c > 0 ? (d.s/d.c).toFixed(1) : "0.0";
                // Si es 0.0 lo ponemos gris, si no aplicamos sem谩foro
                let border = d.c===0 ? 'border-left: 4px solid #e2e8f0' : (s>=4 ? 'border-success' : (s>=3 ? 'border-warning' : 'border-danger'));
                let color = d.c===0 ? 'text-muted' : (s>=4 ? 'text-success' : (s>=3 ? 'text-warning' : 'text-danger'));

                c.innerHTML += `<div class="territory-item ${border.includes('solid')?'':border}" style="${border.includes('solid')?border:''}" onclick="document.getElementById('parroquiaFilter').value='${p}'; applyFilter();">
                    <span class="t-name text-secondary">${p}</span><span class="t-score ${color}">${s}</span>
                </div>`;
            });
        }

        function renderRadar(avgs) {
            const ctx = document.getElementById('radarChart');
            if(chartInstances['radar']) chartInstances['radar'].destroy();
            const global = avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8;
            document.getElementById('radarAnalysisText').innerText = global>3.5 ? "Perfil consolidado. Apto para operaciones." : "Brechas detectadas. Requiere capacitaci贸n.";
            
            chartInstances['radar'] = new Chart(ctx, {
                type: 'radar',
                data: { labels: labels.map(l=>l.split('. ')[1]), datasets: [{ label: 'Nivel', data: avgs, backgroundColor: 'rgba(37, 99, 235, 0.2)', borderColor: '#2563eb', borderWidth: 2 }] },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks:{display:false} } }, plugins:{legend:{display:false}}, maintainAspectRatio: false }
            });
        }
        
        function downloadCanvas(id) {
            const link = document.createElement('a'); link.download = 'grafica.png'; link.href = document.getElementById(id).toDataURL(); link.click();
        }
    </script>
</body>
</html>
