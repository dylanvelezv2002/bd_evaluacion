<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Riesgos | UEB - GAD</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- DISEÑO ORIGINAL RESTAURADO (V2.1 CLEAN UI) --- */
        :root {
            --bg-body: #f1f5f9; --surface: #ffffff; --primary: #2563eb; --primary-dark: #1e3a8a;
            --text-main: #0f172a; --text-muted: #64748b; --border-light: #e2e8f0;
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.03); --radius: 16px;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding-bottom: 60px; }

        /* HEADER & NAV */
        .top-bar { background: var(--surface); padding: 1.2rem 3rem; margin-bottom: 2.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light); position: sticky; top: 0; z-index: 1000; }
        .project-title { font-size: 1.25rem; font-weight: 800; color: var(--primary-dark); }
        .project-subtitle { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-select { background-color: #f8fafc; border: 1px solid var(--border-light); border-radius: 10px; font-weight: 600; cursor: pointer; }
        .nav-pills { background: #e2e8f0; padding: 4px; border-radius: 12px; display: inline-flex; }
        .nav-pills .nav-link { color: var(--text-muted); font-weight: 600; font-size: 0.85rem; padding: 8px 20px; border-radius: 9px; }
        .nav-pills .nav-link.active { background-color: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-weight: 700; }

        /* CARDS, KPIS, MAPS */
        .clean-card { background: var(--surface); border-radius: var(--radius); padding: 1.5rem; height: 100%; box-shadow: var(--shadow-card); display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .kpi-val { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 4px; }
        .kpi-lbl { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .map-container { height: 450px; width: 100%; border-radius: var(--radius); background: #e2e8f0; z-index: 1; }
        .badge-status { padding: 6px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        
        /* POPUPS MAPA */
        .leaflet-popup-content-wrapper { border-radius: 12px !important; padding: 0 !important; overflow: hidden; }
        .popup-header { background: var(--primary); color: white; padding: 10px 15px; font-size: 0.85rem; font-weight: 700; }
        .popup-body { padding: 12px 15px; font-size: 0.9rem; background: white; }
        .popup-row { display: flex; justify-content: space-between; margin-bottom: 4px; }

        /* PRELOADER RESTAURADO */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .spinner-custom { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ESTILOS ESPECÍFICOS PARA EL REPORTE (HOJA A4) --- */
        .a4-sheet {
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm;
            box-shadow: 0 0 25px rgba(0,0,0,0.1); position: relative; color: #1e293b; font-family: 'Inter', sans-serif;
        }
        .rep-header { border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end; }
        .rep-title { font-size: 1.6rem; font-weight: 900; color: #0f172a; text-transform: uppercase; line-height: 1; }
        .rep-subtitle { font-size: 0.8rem; color: #64748b; font-weight: 600; margin-top: 5px; }
        .rep-section { margin-bottom: 25px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; }
        .rep-sec-title { background: #f8fafc; color: var(--primary-dark); font-weight: 800; text-transform: uppercase; font-size: 0.85rem; padding: 8px 12px; margin: -15px -15px 15px -15px; border-bottom: 1px solid #e2e8f0; border-radius: 8px 8px 0 0; }
        
        .rep-kpi-row { display: flex; justify-content: space-around; text-align: center; margin-bottom: 15px; }
        .rep-kpi-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .rep-kpi-lbl { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #94a3b8; }
        
        .rep-grid-visual { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 220px; }
        .rep-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .rep-table th { background: #f1f5f9; padding: 8px; text-align: left; font-weight: 700; color: #475569; }
        .rep-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; color: #334155; }

        /* IMPRESIÓN: SOLO MUESTRA LA HOJA A4 */
        @media print {
            body * { visibility: hidden; }
            #pills-report, #pills-report * { visibility: visible; }
            .a4-sheet { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 10mm; box-shadow: none; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="spinner-custom"></div>
        <div id="loaderText" class="text-secondary small fw-bold tracking-wider">CONECTANDO BASE DE DATOS...</div>
    </div>

    <div class="top-bar no-print">
        <div class="header-content-left">
            <div class="project-title"><i class="bi bi-shield-check text-primary me-2"></i>MONITOR DE RIESGOS</div>
            <div class="project-subtitle ps-1">UEB & GAD PROVINCIAL SDT | GESTIÓN 2025</div>
        </div>
        <div class="header-content-right d-flex gap-3">
            <select id="parroquiaFilter" class="form-select" style="width: 240px;" onchange="applyFilter()">
                <option value="ALL">Vista General Provincial</option>
            </select>
        </div>
    </div>

    <div class="container-fluid px-4 px-md-5" style="max-width: 1600px;">
        
        <div class="d-flex justify-content-center justify-content-lg-start mb-4 no-print">
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-obj1">1. DIAGNÓSTICO INSTITUCIONAL</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-obj2">2. EVALUACIÓN COMUNITARIA</button></li>
                <li class="nav-item"><button class="nav-link ms-3 bg-dark text-white" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="prepareReport()">3. GENERAR REPORTE PDF</button></li>
            </ul>
        </div>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-obj1">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Total GADs</div><div class="kpi-val" id="capTotal">0</div></div><div class="fs-1 text-secondary opacity-25"><i class="bi bi-building"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Sist. Alerta</div><div class="kpi-val text-primary" id="capAlarma">0%</div></div><div class="fs-1 text-primary opacity-25"><i class="bi bi-broadcast"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Flota Vehicular</div><div class="kpi-val text-success" id="capVehiculo">0%</div></div><div class="fs-1 text-success opacity-25"><i class="bi bi-truck"></i></div></div></div>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-lg-8"><div class="clean-card p-0"><div class="p-3 px-4 border-bottom bg-white"><span class="text-muted small fw-bold">MAPA DE RECURSOS</span></div><div id="mapCap" class="map-container" style="border-radius: 0 0 16px 16px;"></div></div></div>
                    <div class="col-lg-4 d-flex flex-column gap-4">
                        <div class="clean-card flex-grow-1"><div class="text-muted small fw-bold mb-2">TALENTO HUMANO</div><div class="flex-grow-1 d-flex align-items-center"><canvas id="chartTalento"></canvas></div></div>
                        <div class="clean-card flex-grow-1"><div class="text-muted small fw-bold mb-2">LOGÍSTICA</div><div class="flex-grow-1 d-flex align-items-center"><canvas id="chartLogistica"></canvas></div></div>
                    </div>
                </div>
                <div class="clean-card p-4 mb-4 border-start border-5 border-primary">
                    <h5 class="fw-bold text-primary mb-2 small text-uppercase">Dictamen Técnico</h5>
                    <div id="obj1ReportText" class="small text-secondary" style="line-height: 1.6;">Cargando análisis...</div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-obj2">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Comunidades</div><div class="kpi-val" id="kpiTotal">0</div></div><div class="fs-1 text-secondary opacity-25"><i class="bi bi-people"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Índice Global</div><div class="kpi-val text-primary" id="kpiPromedio">0.0</div></div><div class="fs-1 text-primary opacity-25"><i class="bi bi-bar-chart"></i></div></div></div>
                    <div class="col-md-4"><div class="clean-card flex-row align-items-center p-4"><div><div class="kpi-lbl">Estado</div><div class="fw-bold text-uppercase mt-1" id="kpiEstado" style="font-size: 1.5rem;">-</div></div><div class="fs-1 text-secondary opacity-25"><i class="bi bi-shield-check"></i></div></div></div>
                </div>
                <div class="row g-4 mb-5">
                    <div class="col-lg-8"><div class="clean-card p-0"><div class="p-3 px-4 border-bottom bg-white"><span class="text-muted small fw-bold">MAPA DE CALOR SOCIAL</span></div><div id="mapEval" class="map-container" style="border-radius: 0 0 16px 16px;"></div></div></div>
                    <div class="col-lg-4"><div class="clean-card"><div class="text-muted small fw-bold mb-3">PERFIL DE RESILIENCIA</div><div class="d-flex align-items-center justify-content-center h-100"><canvas id="radarChart"></canvas></div></div></div>
                </div>
                <h4 class="fw-bold text-secondary mb-4 small text-uppercase">Desglose de Indicadores</h4>
                <div class="row g-4" id="chartsGrid"></div>
            </div>

            <div class="tab-pane fade" id="pills-report">
                <div class="d-flex flex-column align-items-center">
                    <button onclick="window.print()" class="btn btn-dark fw-bold mb-4 shadow-sm px-5 py-2 rounded-pill no-print"><i class="bi bi-printer-fill me-2"></i>IMPRIMIR REPORTE FINAL</button>
                    
                    <div class="a4-sheet">
                        <div class="rep-header">
                            <div>
                                <div class="rep-title">INFORME DE EVALUACIÓN INTEGRAL</div>
                                <div class="rep-subtitle">GAD PROVINCIAL SDT | GESTIÓN DE RIESGOS</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-primary" id="repLocation">CONSOLIDADO</div>
                                <div class="small text-muted" id="repDate">Fecha: --/--/----</div>
                            </div>
                        </div>

                        <div class="rep-section">
                            <div class="rep-sec-title">1. CAPACIDADES INSTITUCIONALES (OBJETIVO 1)</div>
                            <div class="rep-kpi-row">
                                <div><div class="rep-kpi-lbl">COBERTURA SALUD</div><div class="rep-kpi-val" id="repValSalud">0%</div></div>
                                <div><div class="rep-kpi-lbl">SIST. ALARMA</div><div class="rep-kpi-val text-danger" id="repValAlarma">0%</div></div>
                                <div><div class="rep-kpi-lbl">VEHÍCULOS</div><div class="rep-kpi-val text-success" id="repValVeh">0%</div></div>
                            </div>
                            <div class="d-flex gap-4" style="height: 150px;">
                                <div style="flex:1; display:flex; justify-content:center;"><canvas id="repChartBars"></canvas></div>
                                <div style="flex:1; font-size:0.75rem; color:#475569; text-align:justify; border-left:2px solid #e2e8f0; padding-left:15px; display:flex; align-items:center;">
                                    <span id="repTxtDiag">El análisis de recursos muestra...</span>
                                </div>
                            </div>
                        </div>

                        <div class="rep-section">
                            <div class="rep-sec-title">2. EVALUACIÓN COMUNITARIA (OBJETIVO 2)</div>
                            <div class="rep-grid-visual mb-3">
                                <div style="border:1px solid #e2e8f0; border-radius:6px; overflow:hidden;">
                                    <div id="mapRep" style="width:100%; height:100%;"></div>
                                </div>
                                <div style="display:flex; justify-content:center; align-items:center;">
                                    <canvas id="repChartRadar"></canvas>
                                </div>
                            </div>
                            
                            <div class="small fw-bold text-muted mb-2 text-uppercase">Resumen de Evaluaciones Recientes:</div>
                            <table class="rep-table">
                                <thead><tr><th>Comunidad</th><th>Responsable</th><th>Fecha</th><th>Puntaje</th></tr></thead>
                                <tbody id="repTableBody"></tbody>
                            </table>
                        </div>

                        <div class="position-absolute bottom-0 start-0 w-100 p-5 text-center">
                            <div style="border-top: 1px solid #e2e8f0; padding-top: 10px;" class="small text-muted fst-italic">
                                Sistema de Monitoreo de Riesgos - Universidad Estatal de Bolívar
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- CONFIGURACIÓN Y CONEXIÓN ---
        const BASE_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";
        // Usamos AllOrigins para evitar bloqueos de CORS
        const PROXY_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(BASE_URL);
        
        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];
        const LABELS_OBJ2 = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];
        const TIPS = ["Conectando con Google Sheets...", "Procesando datos geográficos...", "Generando indicadores..."];

        let DATA_CAP=[], DATA_EVAL=[], mapCap, mapEval, mapRep;
        let layerCap=L.layerGroup(), layerEval=L.layerGroup(), layerRep=L.layerGroup();
        let charts = {};

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            runPreloader();
            const sel = document.getElementById('parroquiaFilter');
            PARROQUIAS.sort().forEach(p => sel.add(new Option(p, p)));
            document.getElementById('repDate').innerText = "Fecha: " + new Date().toLocaleDateString();
            
            initMaps();
            
            // FETCH DE DATOS
            fetch(PROXY_URL).then(r => r.json()).then(d => {
                document.getElementById('preloader').style.opacity = '0';
                setTimeout(()=>document.getElementById('preloader').style.display='none', 500);
                
                if(d.status === 'success') {
                    DATA_CAP = d.dataCap || [];
                    DATA_EVAL = d.dataEval || [];
                    applyFilter();
                } else {
                    Swal.fire("Aviso", "Base de datos vacía o inaccesible.", "warning");
                }
            }).catch(e => {
                document.getElementById('preloader').style.display='none';
                Swal.fire("Error de Conexión", "No se pudo conectar. Revisa tu internet.", "error");
            });

            // FIX: Refrescar mapas al cambiar de pestaña
            document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(el => {
                el.addEventListener('shown.bs.tab', () => {
                    mapCap.invalidateSize();
                    mapEval.invalidateSize();
                    if(el.getAttribute('data-bs-target')==='#pills-report') {
                        setTimeout(() => { mapRep.invalidateSize(); fitMap(mapRep, layerRep); }, 200);
                    }
                });
            });
        };

        function runPreloader() {
            let i=0; setInterval(()=>{ document.getElementById('loaderText').innerText=TIPS[i]; i=(i+1)%TIPS.length; }, 1500);
            setTimeout(()=>document.getElementById('preloader').style.display='none', 10000); // Fallback por si falla fetch
        }

        function initMaps() {
            const tiles = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            
            mapCap = L.map('mapCap', {zoomControl:false}).setView([-0.253, -79.17], 10);
            L.tileLayer(tiles).addTo(mapCap); layerCap.addTo(mapCap);

            mapEval = L.map('mapEval', {zoomControl:false}).setView([-0.253, -79.17], 10);
            L.tileLayer(tiles).addTo(mapEval); layerEval.addTo(mapEval);

            mapRep = L.map('mapRep', {zoomControl:false, attributionControl:false}).setView([-0.253, -79.17], 10);
            L.tileLayer(tiles).addTo(mapRep); layerRep.addTo(mapRep);
        }

        function createPopup(title, rows) {
            let body = rows.map(r => `<div class="popup-row"><span>${r[0]}</span><strong>${r[1]}</strong></div>`).join('');
            return `<div class="popup-header">${title}</div><div class="popup-body">${body}</div>`;
        }

        function fitMap(map, layer) {
            if(layer.getLayers().length > 0) map.fitBounds(layer.getBounds(), {padding:[20,20]});
            else map.setView([-0.253, -79.17], 10);
        }

        // --- LÓGICA PRINCIPAL DE FILTRO ---
        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            const isProv = val === 'ALL';
            const fCap = isProv ? DATA_CAP : DATA_CAP.filter(r => r[1] === val);
            const fEval = isProv ? DATA_EVAL : DATA_EVAL.filter(r => r[1] === val);

            // Renderizar pestañas
            renderTab1(fCap, isProv, val);
            renderTab2(fEval);
            
            // Guardar datos para el reporte (se renderiza al dar click en tab 3)
            window.REP_DATA = { cap: fCap, eval: fEval, name: isProv ? "CONSOLIDADO PROVINCIAL" : "PARROQUIA " + val };
            if(document.querySelector('#pills-report').classList.contains('active')) prepareReport();
        }

        // --- RENDERIZADO TAB 1 (DIAGNÓSTICO) ---
        function renderTab1(data, isProv, name) {
            document.getElementById('capTotal').innerText = data.length;
            let salud=0, alarma=0, veh=0, fuego=0;
            
            layerCap.clearLayers();
            data.forEach(r => {
                if(r[6]==='SI') salud++; if(r[8]==='SI') fuego++; if(r[11]==='SI') alarma++; if(r[13]==='SI') veh++;
                let lat = parseFloat(r[4]), lng = parseFloat(r[5]);
                if(lat && lng) {
                    let score = (r[6]==='SI'?1:0) + (r[11]==='SI'?1:0) + (r[13]==='SI'?1:0);
                    let color = score>=2?'#16a34a':(score===1?'#f59e0b':'#dc2626');
                    L.circleMarker([lat+(Math.random()-0.5)*0.001, lng], {radius:8, fillColor:color, color:'white', weight:2, fillOpacity:0.9})
                    .bindPopup(createPopup(r[1], [['Salud',r[6]],['Alarma',r[11]],['Vehículo',r[13]]])).addTo(layerCap);
                }
            });
            fitMap(mapCap, layerCap);

            let t = data.length||1;
            document.getElementById('capAlarma').innerText = Math.round((alarma/t)*100)+"%";
            document.getElementById('capVehiculo').innerText = Math.round((veh/t)*100)+"%";
            
            renderBar('chartTalento', ['Salud','Fuego'], [salud, fuego], '#2563eb');
            renderBar('chartLogistica', ['Alarma','Vehículo'], [alarma, veh], '#16a34a');
            
            document.getElementById('obj1ReportText').innerText = `Análisis ${isProv?'Provincial':name}: Se registran ${t} puntos. Cobertura de salud al ${Math.round((salud/t)*100)}% y sistemas de alerta al ${Math.round((alarma/t)*100)}%.`;
        }

        // --- RENDERIZADO TAB 2 (EVALUACIÓN) ---
        function renderTab2(data) {
            document.getElementById('kpiTotal').innerText = data.length;
            let sums = new Array(8).fill(0);
            
            layerEval.clearLayers();
            data.forEach(r => {
                for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]);
                let lat = parseFloat(r[5]), lng = parseFloat(r[6]);
                if(lat && lng) {
                    let avg=0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg=(avg/8).toFixed(1);
                    let color = avg>=4?'#16a34a':(avg>=3?'#f59e0b':'#dc2626');
                    L.circleMarker([lat+(Math.random()-0.5)*0.001, lng], {radius:7, fillColor:color, color:'white', weight:1, fillOpacity:0.9})
                    .bindPopup(createPopup(r[2], [['Parroquia',r[1]],['Nota',avg]])).addTo(layerEval);
                }
            });
            fitMap(mapEval, layerEval);

            let avgs = sums.map(s => (s/(data.length||1)).toFixed(1));
            let global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            
            document.getElementById('kpiPromedio').innerText = global;
            let st = document.getElementById('kpiEstado');
            st.innerText = global>=4 ? "SÓLIDO" : (global>=3 ? "REGULAR" : "CRÍTICO");
            st.className = "fw-bold text-uppercase mt-1 " + (global>=4?"text-success":(global>=3?"text-warning":"text-danger"));

            renderRadar('radarChart', avgs, '#2563eb', 'rgba(37, 99, 235, 0.2)');
            
            // Mini charts
            const grid = document.getElementById('chartsGrid'); grid.innerHTML="";
            avgs.forEach((v, i) => {
                let color = v>=4?'#16a34a':(v>=3?'#f59e0b':'#dc2626');
                grid.innerHTML += `<div class="col-md-3"><div class="clean-card p-3"><div class="d-flex justify-content-between"><span class="text-muted small fw-bold">${LABELS_OBJ2[i]}</span><span style="color:${color};font-weight:800">${v}</span></div><div style="height:40px"><canvas id="mini${i}"></canvas></div></div></div>`;
                setTimeout(()=>renderBar(`mini${i}`, [''], [v], color), 0);
            });
        }

        // --- RENDERIZADO TAB 3 (REPORTE UNIFICADO) ---
        function prepareReport() {
            const d = window.REP_DATA;
            if(!d) return;
            
            document.getElementById('repLocation').innerText = d.name;

            // DATOS OBJ 1
            let t = d.cap.length||1;
            let salud = d.cap.filter(r=>r[6]==='SI').length;
            let alarma = d.cap.filter(r=>r[11]==='SI').length;
            let veh = d.cap.filter(r=>r[13]==='SI').length;
            
            document.getElementById('repValSalud').innerText = Math.round((salud/t)*100)+"%";
            document.getElementById('repValAlarma').innerText = Math.round((alarma/t)*100)+"%";
            document.getElementById('repValVeh').innerText = Math.round((veh/t)*100)+"%";
            
            renderBar('repChartBars', ['Salud', 'Alarma', 'Vehículo'], [salud, alarma, veh], '#475569');
            document.getElementById('repTxtDiag').innerText = `Diagnóstico realizado sobre ${t} registros. Se evidencia una cobertura de salud del ${Math.round((salud/t)*100)}% y una capacidad logística vehicular del ${Math.round((veh/t)*100)}%. El sistema de alarmas opera al ${Math.round((alarma/t)*100)}%.`;

            // DATOS OBJ 2
            let sums = new Array(8).fill(0);
            d.eval.forEach(r => { for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]); });
            let avgs = sums.map(s => (s/(d.eval.length||1)).toFixed(1));
            
            renderRadar('repChartRadar', avgs, '#dc2626', 'rgba(220, 38, 38, 0.1)');

            // MAPA REPORTE (Puntos Evaluados)
            layerRep.clearLayers();
            d.eval.forEach(r => {
                let lat = parseFloat(r[5]), lng = parseFloat(r[6]);
                if(lat && lng) {
                    let avg=0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg=(avg/8).toFixed(1);
                    let color = avg>=4?'#16a34a':(avg>=3?'#f59e0b':'#dc2626');
                    L.circleMarker([lat, lng], {radius:5, fillColor:color, color:'#333', weight:1, fillOpacity:1}).addTo(layerRep);
                }
            });
            setTimeout(() => fitMap(mapRep, layerRep), 500);

            // TABLA REPORTE
            const tbody = document.getElementById('repTableBody'); tbody.innerHTML = "";
            d.eval.slice(0, 5).forEach(r => {
                let avg=0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg=(avg/8).toFixed(1);
                tbody.innerHTML += `<tr><td>${r[2]}</td><td>${r[4]}</td><td>${new Date(r[0]).toLocaleDateString()}</td><td><strong>${avg}</strong></td></tr>`;
            });
        }

        // --- HELPERS CHARTS ---
        function renderBar(id, lbls, vals, color) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar', data: { labels: lbls, datasets: [{ data: vals, backgroundColor: color, borderRadius: 4 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { display: false } } } }
            });
        }
        function renderRadar(id, data, color, bg) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'radar', data: { labels: LABELS_OBJ2, datasets: [{ data: data, borderColor: color, backgroundColor: bg, pointBackgroundColor: color, pointRadius: 2 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { min: 0, max: 5, ticks: { display: false }, pointLabels: { font: { size: 8 } } } } }
            });
        }
    </script>
</body>
</html>
