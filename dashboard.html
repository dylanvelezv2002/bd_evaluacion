<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Capacidades | Prácticas Pre-Profesionales</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #0f172a; 
            --accent: #2563eb; 
            --danger: #dc2626;
            --success: #16a34a;
            --bg-body: #f1f5f9;
            --sidebar-width: 260px;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: #334155; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 1.2rem; flex-shrink: 0; z-index: 50; }
        .brand { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #f1f5f9; }
        .brand h4 { font-weight: 800; margin: 0; color: var(--primary); letter-spacing: -0.5px; }
        .brand span { font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; }
        .nav-btn { padding: 10px 14px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #64748b; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; }
        .nav-btn:hover { background: #f8fafc; color: var(--primary); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15); }

        /* MAIN CONTENT */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 2rem; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title h2 { font-size: 1.4rem; font-weight: 800; margin: 0; color: var(--primary); }
        .select-custom { border: 1px solid #cbd5e1; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; color: var(--primary); outline: none; min-width: 250px; background-color: white; cursor: pointer; font-size: 0.9rem; }

        /* CARDS */
        .card-modern { background: white; border-radius: 10px; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 100%; display: flex; flex-direction: column; transition: transform 0.2s; }
        .card-modern:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header-custom { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .card-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.5px; }
        .kpi-big { font-size: 2rem; font-weight: 800; line-height: 1; margin-bottom: 0.2rem; color: var(--primary); }
        .map-wrapper { height: 380px; width: 100%; border-radius: 8px; overflow: hidden; background: #e2e8f0; z-index: 1; border: 1px solid #cbd5e1; }
        .chart-wrapper { position: relative; height: 180px; width: 100%; }

        /* POPUPS */
        .custom-popup .leaflet-popup-content-wrapper { padding: 0; border-radius: 6px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .custom-popup .leaflet-popup-content { margin: 0; width: 220px !important; }
        .pop-header { background: var(--primary); color: white; padding: 8px 12px; font-weight: 700; font-size: 0.75rem; }
        .pop-body { padding: 12px; font-size: 0.75rem; color: #334155; line-height: 1.4; background: white; }

        /* REPORTES A4 */
        .report-bg { background: #e2e8f0; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 40px; }
        .a4-sheet { 
            width: 210mm; min-height: 297mm; background: white; padding: 15mm; 
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; box-sizing: border-box;
            overflow: hidden; 
        }
        .doc-header { border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .doc-title { font-size: 1.4rem; font-weight: 900; color: var(--primary); text-transform: uppercase; line-height: 1.1; }
        .doc-sub { font-size: 0.8rem; color: var(--accent); font-weight: 700; text-transform: uppercase; }
        .doc-meta { text-align: right; font-size: 0.65rem; color: #475569; line-height: 1.4; }
        
        .kpi-row-doc { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .kpi-box-doc { background: #f8fafc; padding: 12px; text-align: center; border: 1px solid #e2e8f0; border-radius: 6px; }
        .kpi-doc-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .kpi-doc-lbl { font-size: 0.55rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-top: 4px; }
        
        .auto-text-box { font-size: 0.8rem; color: #334155; text-align: justify; line-height: 1.5; margin-bottom: 20px; padding: 10px; background: #f8fafc; border-radius: 6px; }
        .analysis-list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.7rem; }
        .analysis-item { background: white; padding: 8px 10px; border: 1px solid #f1f5f9; border-radius: 4px; border-left-width: 4px; }
        
        .doc-footer { margin-top: auto; border-top: 1px solid #e2e8f0; padding-top: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .footer-info { font-size: 0.6rem; color: #94a3b8; line-height: 1.4; }
        .qr-box { width: 40px; height: 40px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 6px; color: #cbd5e1; border: 1px solid #e2e8f0; }

        /* IMPRESIÓN */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; display: block; height: auto; overflow: visible; }
            .no-print, .sidebar, .top-bar, #loader, .tab-pane { display: none !important; }
            .report-bg { padding: 0; background: white; }
            .a4-sheet { margin: 0; box-shadow: none; page-break-after: always; display: none; width: 100% !important; height: 100% !important; }
            .print-visible { display: flex !important; }
        }

        .hidden { display: none !important; }
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <div class="fw-bold text-primary" style="letter-spacing: 1px;">CARGANDO SISTEMA</div>
        <div class="small text-muted mt-2">Conectando con Servidor UEB...</div>
    </div>

    <div class="sidebar no-print">
        <div class="brand">
            <h4>MONITOR RIESGOS</h4>
            <span>SISTEMA DE GESTIÓN TERRITORIAL</span>
        </div>
        <div class="nav-btn active" onclick="nav('diag', this)"><i class="bi bi-grid-1x2-fill"></i> Diagnóstico</div>
        <div class="nav-btn" onclick="nav('eval', this)"><i class="bi bi-people-fill"></i> Evaluación Social</div>
        <div class="nav-btn" onclick="nav('strat', this)"><i class="bi bi-signpost-split-fill"></i> Estrategias</div>
        <div class="nav-btn" onclick="nav('rep', this)"><i class="bi bi-printer-fill"></i> Reportes PDF</div>
        
        <div class="mt-auto pt-4 border-top text-center" style="font-size: 0.65rem; color: #94a3b8;">
            <p class="mb-1 fw-bold text-dark">RESPONSABLES:</p>
            Dylan Vélez & Jordan Sanabria<br>Ingeniería en Riesgos
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar no-print">
            <div class="page-title">
                <h2 id="pageTitle">Diagnóstico Institucional</h2>
                <span class="text-muted small">Panel de Control de Capacidades</span>
            </div>
            <select id="filter" class="select-custom shadow-sm" onchange="applyFilter()">
                <option value="ALL">CONSOLIDADO PROVINCIAL</option>
            </select>
        </div>

        <div id="view-diag" class="tab-pane active">
            <div class="row g-3 mb-3">
                <div class="col-md-4"><div class="card-modern">
                    <div class="card-header-custom"><span class="card-label">TOTAL PUNTOS</span><i class="bi bi-geo-alt text-muted"></i></div>
                    <div class="kpi-big" id="d_tot">0</div>
                    <small class="text-muted">Infraestructuras Levantadas</small>
                </div></div>
                <div class="col-md-4"><div class="card-modern">
                    <div class="card-header-custom"><span class="card-label">SISTEMA ALERTAS</span><i class="bi bi-broadcast text-danger"></i></div>
                    <div class="kpi-big text-danger" id="d_sat">0%</div>
                    <small class="text-danger">Cobertura SAT Funcional</small>
                </div></div>
                <div class="col-md-4"><div class="card-modern">
                    <div class="card-header-custom"><span class="card-label">LOGÍSTICA</span><i class="bi bi-truck text-success"></i></div>
                    <div class="kpi-big text-success" id="d_veh">0%</div>
                    <small class="text-success">Vehículos Operativos</small>
                </div></div>
            </div>
            <div class="row g-3">
                <div class="col-lg-8">
                    <div class="card-modern p-0">
                        <div class="p-3 border-bottom fw-bold text-primary small bg-light rounded-top">MAPA DE RECURSOS</div>
                        <div id="mapDiag" class="map-wrapper"></div>
                    </div>
                </div>
                <div class="col-lg-4 d-flex flex-column gap-3">
                    <div class="card-modern flex-grow-1">
                        <div class="card-header-custom"><span class="card-label">CAPACIDAD RESPUESTA</span></div>
                        <div class="chart-wrapper"><canvas id="chD1"></canvas></div>
                    </div>
                    <div class="card-modern flex-grow-1">
                        <div class="card-header-custom"><span class="card-label">EQUIPAMIENTO</span></div>
                        <div class="chart-wrapper"><canvas id="chD2"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-eval" class="tab-pane hidden">
            <div class="row g-3 mb-3">
                <div class="col-md-4"><div class="card-modern">
                    <div class="card-header-custom"><span class="card-label">ÍNDICE PERCEPCIÓN</span></div>
                    <div class="kpi-big text-primary" id="e_idx">0.0</div>
                    <small class="text-primary">Promedio General (1-5)</small>
                </div></div>
                <div class="col-md-4"><div class="card-modern">
                    <div class="card-header-custom"><span class="card-label">PARTICIPANTES</span></div>
                    <div class="kpi-big" id="e_tot">0</div>
                    <small class="text-muted">Encuestas Realizadas</small>
                </div></div>
                <div class="col-md-4"><div class="card-modern">
                    <div class="card-header-custom"><span class="card-label">ESTADO ACTUAL</span></div>
                    <div class="kpi-big" id="e_st">-</div>
                    <small>Nivel de Organización</small>
                </div></div>
            </div>
            <div class="row g-3">
                <div class="col-lg-7">
                    <div class="card-modern p-0">
                        <div class="p-3 border-bottom fw-bold text-primary small bg-light rounded-top">DISTRIBUCIÓN DE ACTORES</div>
                        <div id="mapEval" class="map-wrapper"></div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card-modern">
                        <div class="card-header-custom"><span class="card-label">RADAR DE VARIABLES SOCIALES</span></div>
                        <div class="chart-wrapper h-100 d-flex align-items-center"><canvas id="chEval"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-strat" class="tab-pane hidden">
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center p-5 border rounded bg-white shadow-sm">
                <div class="mb-3 p-3 bg-light rounded-circle"><i class="bi bi-cone-striped fs-1 text-warning"></i></div>
                <h3 class="fw-bold text-primary">Generador de Estrategias</h3>
                <p class="text-muted w-50">Seleccione una parroquia para visualizar el plan de acción recomendado basado en los resultados del diagnóstico.</p>
            </div>
        </div>

        <div id="view-rep" class="tab-pane hidden">
            <div class="report-bg">
                
                <div class="w-100 d-flex flex-column align-items-center gap-3">
                    <button onclick="printReport('doc1')" class="btn btn-dark w-50 shadow fw-bold no-print py-2">
                        <i class="bi bi-file-earmark-pdf-fill me-2"></i>GENERAR INFORME TÉCNICO (OBJ 1)
                    </button>
                    
                    <div class="a4-sheet" id="doc1">
                        <div class="doc-header">
                            <div>
                                <div class="doc-title">INFORME TÉCNICO</div>
                                <div class="doc-sub">DIAGNÓSTICO DE CAPACIDADES (OBJ 1)</div>
                            </div>
                            <div class="doc-meta">
                                <strong>Fecha de Emisión:</strong> <span id="r1_date"></span><br>
                                <strong>Área:</strong> <span id="r1_loc" class="text-uppercase fw-bold"></span>
                            </div>
                        </div>
                        <div class="kpi-row-doc">
                            <div class="kpi-box-doc"><div class="kpi-doc-val" id="r1_sal">0%</div><div class="kpi-doc-lbl">COBERTURA SALUD</div></div>
                            <div class="kpi-box-doc"><div class="kpi-doc-val text-danger" id="r1_sat">0%</div><div class="kpi-doc-lbl">SISTEMA ALERTAS</div></div>
                            <div class="kpi-box-doc"><div class="kpi-doc-val text-success" id="r1_veh">0%</div><div class="kpi-doc-lbl">LOGÍSTICA</div></div>
                        </div>
                        <div class="d-flex gap-3 mb-4" style="height: 250px;">
                            <div style="width: 60%; border:1px solid #cbd5e1; border-radius:4px; overflow:hidden;"><div id="mapR1" style="width:100%; height:100%"></div></div>
                            <div style="width: 40%; display:flex; align-items:center;"><canvas id="chR1"></canvas></div>
                        </div>
                        <div class="mb-2 fw-bold text-primary small border-bottom pb-1">ANÁLISIS DE DATOS</div>
                        <div id="r1_txt" class="auto-text-box"></div>
                        <div class="doc-footer">
                            <div class="footer-info">
                                <strong>UNIVERSIDAD ESTATAL DE BOLÍVAR</strong><br>Carrera de Gestión de Riesgos y Desastres<br>Elaborado por: Dylan Vélez & Jordan Sanabria
                            </div>
                            <div class="qr-box">UEB</div>
                        </div>
                    </div>
                </div>

                <div class="w-100 d-flex flex-column align-items-center gap-3 mt-5">
                    <button onclick="printReport('doc2')" class="btn btn-primary w-50 shadow fw-bold no-print py-2">
                        <i class="bi bi-file-earmark-pdf-fill me-2"></i>GENERAR INFORME SOCIAL (OBJ 2)
                    </button>
                    
                    <div class="a4-sheet" id="doc2">
                        <div class="doc-header" style="border-color: var(--accent);">
                            <div>
                                <div class="doc-title" style="color: var(--accent);">EVALUACIÓN SOCIAL</div>
                                <div class="doc-sub">PERCEPCIÓN DEL RIESGO (OBJ 2)</div>
                            </div>
                            <div class="doc-meta">
                                <strong>Fecha de Emisión:</strong> <span id="r2_date"></span><br>
                                <strong>Área:</strong> <span id="r2_loc" class="text-uppercase fw-bold"></span>
                            </div>
                        </div>
                        <div class="kpi-row-doc">
                            <div class="kpi-box-doc"><div class="kpi-doc-val" id="r2_tot">0</div><div class="kpi-doc-lbl">TOTAL ACTORES</div></div>
                            <div class="kpi-box-doc"><div class="kpi-doc-val text-primary" id="r2_idx">0.0</div><div class="kpi-doc-lbl">ÍNDICE PROMEDIO</div></div>
                            <div class="kpi-box-doc"><div class="kpi-doc-val" id="r2_st">-</div><div class="kpi-doc-lbl">CALIFICACIÓN</div></div>
                        </div>
                        <div class="d-flex gap-3 mb-4" style="height: 220px;">
                            <div style="width: 50%; border:1px solid #cbd5e1; border-radius:4px; overflow:hidden;"><div id="mapR2" style="width:100%; height:100%"></div></div>
                            <div style="width: 50%; display:flex; align-items:center; justify-content:center;"><canvas id="chR2"></canvas></div>
                        </div>
                        <div class="mb-2 fw-bold text-accent small border-bottom pb-1" style="color: var(--accent);">MATRIZ DE HALLAZGOS</div>
                        <div id="r2_list" class="analysis-list"></div>
                        <div class="doc-footer">
                            <div class="footer-info">
                                <strong>UNIVERSIDAD ESTATAL DE BOLÍVAR</strong><br>Carrera de Gestión de Riesgos y Desastres<br>Elaborado por: Dylan Vélez & Jordan Sanabria
                            </div>
                            <div class="qr-box">UEB</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // CONFIGURACIÓN (YA CALIBRADA)
        // ==========================================
        
        const C_CAP = {
            PARROQUIA: 1,  
            NOMBRE: 2,     
            LAT: 4,        
            LNG: 5,        
            SALUD: 6,      
            BOMBEROS: 8,   
            SAT: 11,       
            VEHICULO: 13   
        };

        const C_EVAL = {
            PARROQUIA: 1,  
            NOMBRE: 2,     
            ROL: 4,        
            LAT: 5,        
            LNG: 6,        
            NOTA_INICIO: 7 
        };

        const WORKER_URL = "https://ueb.dylanvillasagua.workers.dev/";
        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];
        const VARS = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];
        
        let DC=[], DE=[], maps={}, charts={}, layerGroups={};

        // --- SISTEMA ---
        function safeFloat(val) {
            if (!val) return null;
            let n = parseFloat(val.toString().replace(',', '.'));
            return isNaN(n) ? null : n;
        }

        function getJitter(val) {
            let v = safeFloat(val);
            return v ? v + (Math.random() - 0.5) * 0.003 : null;
        }

        window.onload = () => {
            const s = document.getElementById('filter');
            PARROQUIAS.sort().forEach(p => s.add(new Option(p, p)));
            initMaps();
            loadData();
        };

        function loadData() {
            fetch(WORKER_URL)
                .then(response => {
                    if (!response.ok) throw new Error('Error HTTP: ' + response.status);
                    return response.json();
                })
                .then(jsonData => {
                    if(jsonData.status === 'success') {
                        DC = jsonData.dataCap || [];
                        DE = jsonData.dataEval || [];
                        document.getElementById('loader').classList.add('hidden');
                        applyFilter();
                    } else { throw new Error("JSON sin status success"); }
                })
                .catch(e => {
                    console.error("Error:", e);
                    // AQUÍ ESTABA EL "ERROR DE CONEXIÓN" ENGAÑOSO. LO HE QUITADO PARA QUE NO ASUSTE SI ES UN ERROR DE MAPA.
                    // alert("Error: " + e.message); 
                    document.getElementById('loader').classList.add('hidden');
                });
        }

        window.nav = (id, el) => {
            document.querySelectorAll('.tab-pane').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            const t = {diag:"Diagnóstico Institucional", eval:"Evaluación Social", strat:"Estrategias", rep:"Centro de Reportes"};
            document.getElementById('pageTitle').innerText = t[id];
            
            setTimeout(() => { 
                for(let k in maps) maps[k].invalidateSize(); 
                if(id==='rep'){ fitMap('mapR1', layerGroups['mapR1']); fitMap('mapR2', layerGroups['mapR2']); }
            }, 200);
        };

        window.applyFilter = () => {
            const val = document.getElementById('filter').value;
            const isProv = val === 'ALL';
            const name = isProv ? "Santo Domingo de los Tsáchilas" : val;
            
            const fC = isProv ? DC : DC.filter(r => r[C_CAP.PARROQUIA] === val);
            const fE = isProv ? DE : DE.filter(r => r[C_EVAL.PARROQUIA] === val);
            
            updDiag(fC); 
            updEval(fE); 
            updRep(fC, fE, name);
        };

        function updDiag(d) {
            document.getElementById('d_tot').innerText = d.length;
            let s=0, f=0, a=0, v=0;
            let markers = [];
            
            d.forEach(r => {
                let lat = getJitter(r[C_CAP.LAT]);
                let lng = getJitter(r[C_CAP.LNG]);
                
                if(lat && lng) {
                    let hasSat = r[C_CAP.SAT] === 'SI';
                    let color = hasSat ? '#16a34a' : '#dc2626';
                    let popup = `<div class="pop-header" style="background:${color}"><span>${r[C_CAP.NOMBRE]}</span></div>
                                 <div class="pop-body">
                                    <strong>SAT:</strong> ${r[C_CAP.SAT] || 'No def.'}<br>
                                    <strong>Vehículo:</strong> ${r[C_CAP.VEHICULO] || 'No def.'}
                                 </div>`;
                    
                    markers.push(L.circleMarker([lat, lng], {radius: 7, fillColor: color, color: "white", weight: 2, fillOpacity: 0.9}).bindPopup(popup, {className: 'custom-popup'}));

                    if(r[C_CAP.SALUD]==='SI') s++;
                    if(r[C_CAP.BOMBEROS]==='SI') f++;
                    if(r[C_CAP.SAT]==='SI') a++;
                    if(r[C_CAP.VEHICULO]==='SI') v++;
                }
            });
            
            updateMapLayer('mapDiag', markers);
            
            let total = d.length || 1;
            document.getElementById('d_sat').innerText = Math.round((a/total)*100) + '%';
            document.getElementById('d_veh').innerText = Math.round((v/total)*100) + '%';
            
            renderBar('chD1', ['Salud', 'Bomberos'], [s, f], '#2563eb');
            renderBar('chD2', ['SAT', 'Vehículos'], [a, v], '#0f172a');
        }

        function updEval(d) {
            document.getElementById('e_tot').innerText = d.length;
            let sums = new Array(8).fill(0);
            let markers = [];

            d.forEach(r => {
                let lat = getJitter(r[C_EVAL.LAT]);
                let lng = getJitter(r[C_EVAL.LNG]);

                if(lat && lng) {
                    let avg = 0;
                    for(let i=0; i<8; i++) {
                        let val = Number(r[C_EVAL.NOTA_INICIO + i]) || 0;
                        sums[i] += val;
                        avg += val;
                    }
                    avg /= 8;
                    
                    let color = avg >= 3.5 ? '#2563eb' : '#dc2626';
                    let popup = `<div class="pop-header" style="background:${color}"><span>${r[C_EVAL.NOMBRE]}</span></div>
                                 <div class="pop-body">
                                    <strong>Rol:</strong> ${r[C_EVAL.ROL]}<br>
                                    <strong>Promedio:</strong> ${avg.toFixed(2)} / 5.0
                                 </div>`;

                    markers.push(L.circleMarker([lat, lng], {radius: 7, fillColor: color, color: "white", weight: 2, fillOpacity: 0.9}).bindPopup(popup, {className: 'custom-popup'}));
                }
            });

            updateMapLayer('mapEval', markers);

            let avgs = sums.map(x => Number((x / (d.length || 1)).toFixed(2)));
            let glob = (avgs.reduce((a,b)=>a+b,0)/8).toFixed(2);
            
            document.getElementById('e_idx').innerText = glob;
            document.getElementById('e_st').innerText = glob>=3.5 ? "FORTALECIDO" : (glob>=2.5 ? "EN PROCESO" : "VULNERABLE");
            
            renderRadar('chEval', avgs, '#2563eb', 'rgba(37, 99, 235, 0.2)');
        }

        function updRep(dc, de, name) {
            document.querySelectorAll('#r1_loc, #r2_loc').forEach(e => e.innerText = name);
            let dateStr = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.querySelectorAll('#r1_date, #r2_date').forEach(e => e.innerText = dateStr);

            // DATOS REPORTE 1
            let t1 = dc.length || 1;
            let a = dc.filter(r => r[C_CAP.SAT]==='SI').length;
            let v = dc.filter(r => r[C_CAP.VEHICULO]==='SI').length;
            let s = dc.filter(r => r[C_CAP.SALUD]==='SI').length;
            
            document.getElementById('r1_sal').innerText = Math.round((s/t1)*100) + '%';
            document.getElementById('r1_sat').innerText = Math.round((a/t1)*100) + '%';
            document.getElementById('r1_veh').innerText = Math.round((v/t1)*100) + '%';

            let txt1 = `Se han evaluado ${t1} puntos en ${name}. La cobertura de Sistemas de Alerta Temprana (SAT) alcanza el ${Math.round((a/t1)*100)}%, lo cual indica un nivel ${a/t1 > 0.6 ? 'aceptable' : 'crítico'} de preparación tecnológica. En logística, el ${Math.round((v/t1)*100)}% de las entidades cuenta con vehículo operativo.`;
            document.getElementById('r1_txt').innerText = txt1;

            renderBar('chR1', ['Salud', 'SAT', 'Vehículo'], [s, a, v], '#0f172a');
            
            let m1 = [];
            dc.forEach(r => { 
                let lat=getJitter(r[C_CAP.LAT]), lng=getJitter(r[C_CAP.LNG]); 
                if(lat && lng) m1.push(L.circleMarker([lat,lng],{radius:4,color:'#0f172a',weight:0,fillColor:'#0f172a',fillOpacity:0.8}));
            });
            updateMapLayer('mapR1', m1);

            // DATOS REPORTE 2
            let sums = new Array(8).fill(0);
            de.forEach(r => { for(let i=0; i<8; i++) sums[i] += Number(r[C_EVAL.NOTA_INICIO + i]) || 0; });
            let avgs = sums.map(x => Number((x / (de.length || 1)).toFixed(2)));
            let glob = (avgs.reduce((a,b)=>a+b,0)/8).toFixed(2);
            
            document.getElementById('r2_tot').innerText = de.length;
            document.getElementById('r2_idx').innerText = glob;
            document.getElementById('r2_st').innerText = glob>=3.5 ? "ALTO" : "BAJO";

            let htmlList = "";
            avgs.forEach((val, i) => {
                let isGood = val >= 3.0;
                let color = isGood ? '#16a34a' : '#dc2626';
                htmlList += `<div class="analysis-item" style="border-left-color:${color}">
                                <strong style="color:${color}">${VARS[i]} (${val})</strong>
                                <br><span class="text-muted">${isGood ? 'Fortaleza identificada.' : 'Requiere plan de mejora.'}</span>
                             </div>`;
            });
            document.getElementById('r2_list').innerHTML = htmlList;
            
            renderRadar('chR2', avgs, '#2563eb', 'rgba(37, 99, 235, 0.1)');
            
            let m2 = [];
            de.forEach(r => { 
                let lat=getJitter(r[C_EVAL.LAT]), lng=getJitter(r[C_EVAL.LNG]); 
                if(lat && lng) m2.push(L.circleMarker([lat,lng],{radius:4,color:'#2563eb',weight:0,fillColor:'#2563eb',fillOpacity:0.8}));
            });
            updateMapLayer('mapR2', m2);
        }

        // --- SOLUCIÓN AL ERROR DE MAPA ---
        function initMaps() {
            ['mapDiag','mapEval','mapR1','mapR2'].forEach(id => {
                maps[id] = L.map(id, {zoomControl:false, attributionControl:false}).setView([-0.25, -79.17], 9);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(maps[id]);
                // AQUÍ ESTABA EL ERROR: layerGroup no tiene getBounds(), pero featureGroup SÍ.
                layerGroups[id] = L.featureGroup().addTo(maps[id]);
            });
        }

        function updateMapLayer(id, markers) {
            if(maps[id] && layerGroups[id]) {
                layerGroups[id].clearLayers();
                markers.forEach(m => m.addTo(layerGroups[id]));
                if(markers.length > 0) fitMap(id, layerGroups[id]);
            }
        }

        function fitMap(id, lg) {
            if(maps[id] && lg.getLayers().length > 0) {
                maps[id].invalidateSize();
                maps[id].fitBounds(lg.getBounds(), {padding: [30,30]});
            }
        }

        function renderBar(id, l, d, c) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar',
                data: {labels:l, datasets:[{data:d, backgroundColor:c, borderRadius:3}]},
                options: {responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{display:false}}}}
            });
        }

        function renderRadar(id, d, c, bg) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'radar',
                data: {labels:VARS, datasets:[{data:d, borderColor:c, backgroundColor:bg, pointRadius:0}]},
                options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{r:{min:0, max:5, ticks:{display:false}, pointLabels:{font:{size:8}}}}}
            });
        }

        window.printReport = (docId) => {
            document.querySelectorAll('.a4-sheet').forEach(e => e.classList.remove('print-visible'));
            const t = document.getElementById(docId);
            t.classList.add('print-visible');
            if(docId==='doc1') fitMap('mapR1', layerGroups['mapR1']);
            if(docId==='doc2') fitMap('mapR2', layerGroups['mapR2']);
            setTimeout(() => { window.print(); t.classList.remove('print-visible'); }, 500);
        }
    </script>
</body>
</html>
