<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Riesgos | UEB - GAD</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-app: #f3f4f6; /* Gris muy suave para el fondo */
            --white: #ffffff;
            --primary: #1e40af; /* Azul institucional fuerte */
            --text-dark: #111827;
            --text-gray: #6b7280;
            --border: #e5e7eb;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-dark);
            padding-bottom: 50px;
        }

        /* --- HEADER LIMPIO --- */
        .top-bar {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .project-title { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .project-subtitle { font-size: 0.8rem; color: var(--text-gray); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }

        /* --- TARJETAS (CARDS) CON ESPACIO --- */
        .clean-card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 25px;
            height: 100%; /* Para que se alineen */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .clean-card:hover { transform: translateY(-2px); }
        
        .card-title-custom {
            font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: var(--text-gray);
            margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 10px;
        }

        /* --- KPIS --- */
        .kpi-big { font-size: 2.5rem; font-weight: 800; color: var(--text-dark); line-height: 1; }
        .kpi-desc { font-size: 0.8rem; color: var(--text-gray); font-weight: 500; margin-top: 5px; }

        /* --- MAPA --- */
        #map { height: 400px; width: 100%; border-radius: 8px; border: 1px solid var(--border); z-index: 1; }

        /* --- ANÁLISIS TÉCNICO (El recuadro gris) --- */
        .analysis-box {
            background-color: #f9fafb;
            border-left: 4px solid var(--primary);
            padding: 15px;
            font-size: 0.85rem;
            color: #374151;
            line-height: 1.6;
            margin-top: 20px;
            border-radius: 0 6px 6px 0;
            text-align: justify;
        }
        .analysis-label { font-size: 0.7rem; font-weight: 800; color: var(--primary); text-transform: uppercase; display: block; margin-bottom: 5px; }

        /* --- BOTONES --- */
        .btn-download {
            border: 1px solid var(--border); background: white; color: var(--text-gray);
            padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .btn-download:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- TABLAS --- */
        .table-clean th { background: #f9fafb; font-size: 0.75rem; text-transform: uppercase; padding: 12px; }
        .table-clean td { padding: 12px; font-size: 0.85rem; border-bottom: 1px solid var(--border); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        /* --- IMPRESIÓN --- */
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .clean-card { border: 1px solid #000; box-shadow: none; break-inside: avoid; margin-bottom: 20px; }
            .analysis-box { background: #eee !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="top-bar no-print">
        <div>
            <div class="project-title">GUÍA DE CONFORMACIÓN DE COMITÉS COMUNITARIOS</div>
            <div class="project-subtitle">Prácticas Pre-Profesionales | UEB & GAD Provincial SDT</div>
        </div>
        <div class="d-flex gap-3 align-items-center">
            <select id="parroquiaFilter" class="form-select form-select-sm" style="width: 200px; font-weight: 600;" onchange="applyFilter()">
                <option value="ALL">Provincia Completa</option>
                </select>
            <button onclick="window.print()" class="btn btn-dark btn-sm fw-bold px-3">Imprimir PDF</button>
        </div>
    </div>

    <div class="container-fluid px-4" style="max-width: 1600px;">
        
        <div class="mb-4 pb-2 border-bottom">
            <div class="d-flex justify-content-between align-items-end">
                <h2 class="fw-bold m-0 text-dark" id="reportTitle">Reporte Consolidado</h2>
                <div class="text-end text-muted">
                    <small>Fecha de Corte: <script>document.write(new Date().toLocaleDateString())</script></small>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="clean-card d-flex align-items-center justify-content-between px-4">
                    <div>
                        <div class="kpi-desc">COMUNIDADES EVALUADAS</div>
                        <div class="kpi-big" id="kpiTotal">0</div>
                    </div>
                    <i class="bi bi-people fs-1 text-black-50 opacity-25"></i>
                </div>
            </div>
            <div class="col-md-4">
                <div class="clean-card d-flex align-items-center justify-content-between px-4">
                    <div>
                        <div class="kpi-desc">ÍNDICE DE GESTIÓN (1-5)</div>
                        <div class="kpi-big text-primary" id="kpiPromedio">0.0</div>
                    </div>
                    <i class="bi bi-graph-up-arrow fs-1 text-primary opacity-25"></i>
                </div>
            </div>
            <div class="col-md-4">
                <div class="clean-card d-flex align-items-center justify-content-between px-4">
                    <div>
                        <div class="kpi-desc">ESTADO DEL PROYECTO</div>
                        <div class="fw-bold text-uppercase" id="kpiEstado" style="font-size: 1.5rem;">-</div>
                    </div>
                    <i class="bi bi-shield-check fs-1 opacity-25"></i>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="clean-card p-0 overflow-hidden">
                    <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-secondary small">MAPA DE GESTIÓN</span>
                        <span class="badge bg-light text-dark border">Santo Domingo de los Tsáchilas</span>
                    </div>
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="clean-card p-0 overflow-hidden" style="max-height: 455px; display:flex; flex-direction:column;">
                    <div class="p-3 bg-white border-bottom">
                        <span class="fw-bold text-secondary small">MONITOR PARROQUIAL</span>
                    </div>
                    <div id="territoryGrid" style="overflow-y: auto; flex-grow: 1;">
                        </div>
                </div>
            </div>
        </div>

        <h5 class="fw-bold text-secondary mb-4 pb-2 border-bottom">ANÁLISIS TÉCNICO DE RESULTADOS</h5>
        
        <div class="row g-4 mb-5" id="chartsGrid">
            </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="clean-card bg-light border-primary">
                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-lightbulb-fill me-2"></i>RECOMENDACIÓN ESTRATÉGICA PARA EL GAD:</h6>
                    <p id="globalRecommendation" style="font-size: 0.95rem; line-height: 1.6; color: #374151;">
                        Cargando datos para generar recomendación...
                    </p>
                </div>
                
                <div class="clean-card mt-4 p-0 overflow-hidden">
                    <div class="p-3 border-bottom"><span class="fw-bold small text-secondary">BASE DE DATOS</span></div>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-clean mb-0 w-100">
                            <thead><tr><th>Fecha</th><th>Parroquia</th><th>Comunidad</th><th>Cargo</th><th>Nota</th></tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="clean-card">
                    <div class="card-title-custom">
                        PERFIL DE COMPETENCIAS
                        <button class="btn-download" onclick="downloadCanvas('radarChart')"><i class="bi bi-download"></i></button>
                    </div>
                    <div style="height: 250px;">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div class="text-center mt-3 small text-muted">
                        <em>Gráfico Radial de Capacidades Instaladas</em>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ============================================
        // ⚠️ PEGA AQUÍ TU URL DE GOOGLE APPS SCRIPT
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";

        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];
        const labels = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];
        
        let RAW_DATA = [], FILTERED_DATA = [], map, markersLayer = new L.LayerGroup(), chartInstances = {};

        // --- BASE DE DATOS DE TEXTOS TÉCNICOS LARGOS ---
        const analysisDB = {
            low: "Vulnerabilidad Crítica. El indicador muestra deficiencias estructurales graves. La falta de gestión efectiva en este componente compromete la operatividad del comité ante eventos adversos. Se recomienda una intervención correctiva inmediata mediante talleres focalizados.",
            mid: "Estabilidad Operativa Parcial. Si bien existen capacidades instaladas, estas son insuficientes para escenarios de alta complejidad. El comité cumple con los mínimos normativos, pero carece de la robustez necesaria para garantizar sostenibilidad sin apoyo externo.",
            high: "Capacidad Consolidada. El comité demuestra autonomía y suficiencia técnica en este aspecto, constituyéndose como un referente de buenas prácticas locales. La gestión valida la metodología de la Guía de Conformación."
        };

        window.onload = () => {
            initMap();
            initFilters();
            fetch(API_URL).then(r => r.json()).then(d => {
                if(d.data) { RAW_DATA = d.data; applyFilter(); }
            });
        };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO', maxZoom: 18
            }).addTo(map);
            markersLayer.addTo(map);
            L.control.zoom({position: 'bottomright'}).addTo(map);
        }

        function initFilters() {
            const sel = document.getElementById('parroquiaFilter');
            PARROQUIAS.sort().forEach(p => sel.add(new Option(p, p)));
        }

        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            FILTERED_DATA = val === 'ALL' ? RAW_DATA : RAW_DATA.filter(r => r[1] === val);
            document.getElementById('reportTitle').innerText = val === 'ALL' ? "Reporte Consolidado Provincial" : `Reporte Situacional: ${val}`;
            
            // Zoom mapa
            if(val !== 'ALL' && FILTERED_DATA.length > 0 && FILTERED_DATA[0][5]) {
                map.setView([FILTERED_DATA[0][5], FILTERED_DATA[0][6]], 13);
            } else {
                map.setView([-0.2530, -79.1754], 10);
            }
            updateDashboard();
        }

        function updateDashboard() {
            const total = FILTERED_DATA.length;
            if(total === 0) return; // Manejar vacío

            markersLayer.clearLayers();
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = "";
            let sums = new Array(8).fill(0);

            FILTERED_DATA.forEach(row => {
                let s=0; for(let i=0;i<8;i++) s+=Number(row[i+7]);
                let avg = (s/8).toFixed(1);
                for(let i=0;i<8;i++) sums[i]+=Number(row[i+7]);

                // Tabla
                tbody.innerHTML += `<tr>
                    <td>${new Date(row[0]).toLocaleDateString()}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td><span class="badge bg-light text-dark border">${row[4]}</span></td>
                    <td><b>${avg}</b></td>
                </tr>`;

                // Mapa
                if(row[5] && row[6]) {
                    let color = avg>=4 ? '#10b981' : (avg>=3 ? '#f59e0b' : '#ef4444');
                    L.circleMarker([row[5], row[6]], {radius:8, fillColor:color, color:'white', weight:2, fillOpacity:1})
                     .bindPopup(`<b>${row[2]}</b><br>Nota: ${avg}`).addTo(markersLayer);
                }
            });

            const avgs = sums.map(s => (s/total).toFixed(1));
            const global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            
            // KPIs
            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiPromedio').innerText = global;
            const st = document.getElementById('kpiEstado');
            if(global>=4) { st.innerText="RESILIENTE"; st.className="fw-bold text-success"; }
            else if(global>=3) { st.innerText="EN PROCESO"; st.className="fw-bold text-warning"; }
            else { st.innerText="CRÍTICO"; st.className="fw-bold text-danger"; }

            // Recomendación
            const recText = global>=3.5 ? 
                "El proceso de conformación ha sido exitoso. Se recomienda al GAD Provincial iniciar la fase de dotación de equipamiento básico y simulacros, dado que la estructura social está consolidada." : 
                "Se detectan debilidades estructurales. Se recomienda NO avanzar a la fase de equipamiento hasta reforzar el componente de capacitación y compromiso en las directivas mediante un re-entrenamiento.";
            document.getElementById('globalRecommendation').innerText = recText;

            renderCharts(avgs);
            renderMonitor();
            renderRadar(avgs);
        }

        function renderCharts(avgs) {
            const c = document.getElementById('chartsGrid'); c.innerHTML = "";
            avgs.forEach((avg, i) => {
                const level = avg>=4 ? 'high' : (avg>=3 ? 'mid' : 'low');
                const color = avg>=4 ? '#10b981' : (avg>=3 ? '#f59e0b' : '#ef4444');
                const text = analysisDB[level];
                const id = `chart${i}`;

                c.innerHTML += `
                <div class="col-md-6 col-xl-3"> <div class="clean-card d-flex flex-column justify-content-between">
                        <div>
                            <div class="card-title-custom">
                                ${labels[i]}
                                <button class="btn-download" onclick="downloadCanvas('${id}')" title="Descargar Gráfica"><i class="bi bi-download"></i></button>
                            </div>
                            <div class="d-flex justify-content-between align-items-end mb-3">
                                <span class="display-6 fw-bold" style="color:${color}">${avg}</span>
                                <span class="text-muted small">/ 5.0</span>
                            </div>
                            <div style="height: 60px;">
                                <canvas id="${id}"></canvas>
                            </div>
                        </div>
                        <div class="analysis-box">
                            <span class="analysis-label">ANÁLISIS TÉCNICO:</span>
                            ${text}
                        </div>
                    </div>
                </div>`;

                setTimeout(() => {
                    new Chart(document.getElementById(id), {
                        type: 'bar',
                        data: { labels: [''], datasets: [{ data: [avg], backgroundColor: color, borderRadius: 4, barThickness: 20 }] },
                        options: { 
                            indexAxis: 'y', maintainAspectRatio: false, 
                            scales: { x:{min:0, max:5, display:false}, y:{display:false} }, 
                            plugins: { legend: {display:false}, tooltip: {enabled: false} } // Tooltip desactivado para limpieza
                        }
                    });
                }, 0);
            });
        }

        function renderMonitor() {
            const c = document.getElementById('territoryGrid'); c.innerHTML = "";
            const g = {}; PARROQUIAS.forEach(p => g[p]={s:0,c:0});
            RAW_DATA.forEach(r => { if(g[r[1]]) { let s=0;for(let i=0;i<8;i++)s+=Number(r[i+7]); g[r[1]].s+=s/8; g[r[1]].c++; }});

            Object.keys(g).sort().forEach(p => {
                const d = g[p]; const s = d.c>0 ? (d.s/d.c).toFixed(1) : "0.0";
                const color = d.c===0 ? '#9ca3af' : (s>=4 ? '#10b981' : (s>=3 ? '#f59e0b' : '#ef4444'));
                const dot = `<span class="status-dot" style="background:${color}"></span>`;
                
                c.innerHTML += `
                <div style="padding: 12px; border-bottom:1px solid #f3f4f6; cursor:pointer; display:flex; justify-content:space-between;" 
                     onclick="document.getElementById('parroquiaFilter').value='${p}'; applyFilter();">
                    <span style="font-size:0.8rem; font-weight:600; color:#374151;">${dot} ${p}</span>
                    <span style="font-weight:800; color:${color}">${s}</span>
                </div>`;
            });
        }

        function renderRadar(avgs) {
            const ctx = document.getElementById('radarChart');
            if(chartInstances['radar']) chartInstances['radar'].destroy();
            chartInstances['radar'] = new Chart(ctx, {
                type: 'radar',
                data: { labels: labels, datasets: [{ label: 'Nivel', data: avgs, backgroundColor: 'rgba(30, 64, 175, 0.2)', borderColor: '#1e40af', borderWidth: 2 }] },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks:{display:false} } }, plugins: { legend: {display:false} }, maintainAspectRatio: false }
            });
        }

        function downloadCanvas(id) {
            const link = document.createElement('a'); link.download = `grafica_${id}.png`;
            link.href = document.getElementById(id).toDataURL(); link.click();
        }
    </script>
</body>
</html>
