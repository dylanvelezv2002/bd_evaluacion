<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Monitoreo SGR</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #1e293b;   /* Azul acero oscuro */
            --border: #e2e8f0;    /* Borde sutil */
            --bg-body: #f8fafc;   /* Fondo casi blanco */
            --accent: #0f172a;    /* Negro/Azul para textos */
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--accent); 
            font-size: 0.85rem; /* Fuente más compacta */
        }

        /* NAVBAR COMPACTA */
        .navbar { 
            background: white; 
            border-bottom: 1px solid var(--border); 
            padding: 8px 20px; 
            height: 55px;
        }
        .brand-title { font-weight: 700; font-size: 1rem; color: var(--primary); text-transform: uppercase; }

        /* TARJETAS COMPACTAS */
        .panel-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px; /* Bordes más cuadrados */
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .card-header-sm {
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title-text { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; }

        /* MAPA */
        #map { height: 450px; width: 100%; background: #e5e7eb; border: 1px solid var(--border); }

        /* KPI COMPACTOS */
        .kpi-box { display: flex; align-items: center; gap: 15px; }
        .kpi-number { font-size: 1.5rem; font-weight: 700; color: var(--primary); line-height: 1; }
        .kpi-text { font-size: 0.7rem; color: #64748b; font-weight: 500; text-transform: uppercase; }

        /* TEXTO TÉCNICO */
        .tech-text {
            font-size: 0.8rem;
            color: #475569;
            line-height: 1.4;
            text-align: justify;
            border-left: 3px solid #3b82f6;
            padding-left: 10px;
            margin-top: 10px;
            background: #f1f5f9;
            padding: 8px;
        }

        /* TABLAS DENSAS */
        .table-dense th, .table-dense td { padding: 4px 8px; font-size: 0.8rem; }
        .table-dense th { background: #f1f5f9; text-transform: uppercase; font-size: 0.7rem; }

        /* PRELOADER MINIMALISTA */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .loader-bar { width: 200px; height: 3px; background: #e2e8f0; margin-top: 10px; position: relative; overflow: hidden; }
        .loader-bar::after { content: ''; position: absolute; width: 50%; height: 100%; background: var(--primary); animation: slide 1s infinite; }
        @keyframes slide { 0% { left: -50%; } 100% { left: 100%; } }

        /* IMPRESIÓN */
        @media print {
            .no-print { display: none !important; }
            .panel-card { border: 1px solid #000; break-inside: avoid; box-shadow: none; }
            body { font-size: 10px; background: white; }
            #map { height: 300px; }
        }
    </style>
</head>
<body>

    <div id="preloader">
        <div style="font-weight:700; font-size:1.2rem;">CARGANDO SISTEMA</div>
        <div class="loader-bar"></div>
    </div>

    <nav class="navbar fixed-top no-print">
        <div class="container-fluid">
            <div class="d-flex align-items-center gap-3">
                <span class="brand-title"><i class="bi bi-hdd-network me-2"></i>SISTEMA INTEGRADO DE GESTIÓN DE RIESGOS</span>
                <div style="height:20px; width:1px; background:#cbd5e1;"></div>
                <select id="parroquiaFilter" class="form-select form-select-sm" style="width: 220px; font-size:0.8rem; border-color:#cbd5e1;" onchange="applyFilter()">
                    <option value="ALL">VISTA PROVINCIAL (GENERAL)</option>
                </select>
            </div>
            <div class="d-flex gap-2">
                <button onclick="window.print()" class="btn btn-dark btn-sm py-0" style="font-size:0.75rem;"><i class="bi bi-printer me-1"></i> IMPRIMIR</button>
                <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm py-0"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-3" style="margin-top: 70px; max-width: 1800px;">
        
        <div class="d-flex justify-content-between align-items-end mb-3 pb-2 border-bottom">
            <div>
                <h4 class="fw-bold m-0" style="color:#0f172a;" id="reportTitle">REPORTE CONSOLIDADO</h4>
                <span class="badge bg-secondary rounded-0" style="font-size:0.65rem;">PROYECTO VINCULACIÓN UEB-GAD</span>
            </div>
            <div class="text-end">
                <div class="kpi-text">FECHA DE CORTE</div>
                <div style="font-weight:700;"><script>document.write(new Date().toISOString().split('T')[0])</script></div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-lg-9">
                <div class="panel-card p-0 overflow-hidden h-100">
                    <div class="d-flex justify-content-between align-items-center px-3 py-2 bg-light border-bottom">
                        <span class="card-title-text"><i class="bi bi-geo-alt-fill me-1"></i> VISOR TERRITORIAL</span>
                        <span class="badge bg-dark rounded-0" style="font-size:0.6rem">CARTO VOYAGER</span>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="row g-2 h-100">
                    <div class="col-12">
                        <div class="panel-card mb-2 py-3">
                            <div class="kpi-box">
                                <i class="bi bi-file-earmark-text fs-3 text-secondary"></i>
                                <div>
                                    <div class="kpi-number" id="kpiTotal">0</div>
                                    <div class="kpi-text">Registros</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="panel-card mb-2 py-3">
                            <div class="kpi-box">
                                <i class="bi bi-graph-up-arrow fs-3 text-primary"></i>
                                <div>
                                    <div class="kpi-number" id="kpiPromedio">0.0</div>
                                    <div class="kpi-text">Ind. Gestión</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12" style="flex-grow: 1;">
                        <div class="panel-card h-100 mb-0 d-flex flex-column">
                            <div class="card-header-sm">
                                <span class="card-title-text">PERFIL RADAR</span>
                            </div>
                            <div style="flex-grow: 1; min-height: 150px;">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h6 class="card-title-text mb-3 ps-1 border-bottom pb-2">ANÁLISIS ESTRUCTURAL DE INDICADORES (OBJETIVO 2)</h6>
        
        <div class="row g-3" id="chartsGrid">
            </div>

        <div class="row mt-3 mb-5 no-print">
            <div class="col-12">
                <div class="panel-card">
                    <div class="card-header-sm">
                        <span class="card-title-text">REGISTRO DETALLADO DE ACTORES</span>
                        <input type="text" id="searchBox" class="form-control form-control-sm rounded-0" style="width:200px;" placeholder="Filtrar datos...">
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-striped table-hover table-dense mb-0" id="dataTable">
                            <thead>
                                <tr><th>Fecha</th><th>Parroquia</th><th>Comunidad</th><th>Nombre</th><th>Cargo</th><th>Lat</th><th>Lng</th><th>Nota</th></tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ⚠️ URL API APPS SCRIPT
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";

        // VARIABLES
        let RAW_DATA = [];
        let FILTERED_DATA = [];
        let map;
        let markersLayer = new L.LayerGroup();
        let chartInstances = {};

        // TEXTOS TÉCNICOS (IA LÓGICA)
        const techAnalysisDB = {
            generic: {
                low: ["Nivel Crítico. Incumplimiento de estándares mínimos operativos. Requiere intervención inmediata.", "Deficiencia Estructural. La capacidad de respuesta es nula ante eventos adversos."],
                mid: ["Nivel Medio. Operatividad parcial condicionada a factores externos. Se sugiere reforzamiento.", "Estabilidad Precaria. Cumple requisitos formales pero carece de validación práctica."],
                high: ["Nivel Óptimo. Capacidades instaladas consolidadas y sostenibles.", "Alta Resiliencia. Estructura organizativa funcional y validada."]
            }
        };

        const labels = [
            "1. Participación", "2. Compromiso", "3. Capacitación", "4. Plan Local",
            "5. Comunicación", "6. Articulación", "7. Inclusión", "8. Réplica"
        ];

        window.onload = () => {
            initMap();
            fetch(API_URL).then(r=>r.json()).then(d => {
                document.getElementById('preloader').style.display = 'none';
                if(d.data) { RAW_DATA=d.data; initFilters(); applyFilter(); }
            });
        };

        function initMap() {
            // Mapa CartoDB Voyager (Gris/Limpio/Profesional)
            map = L.map('map', {zoomControl: false}).setView([-0.2530, -79.1754], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                maxZoom: 19
            }).addTo(map);
            markersLayer.addTo(map);
            L.control.zoom({position: 'bottomright'}).addTo(map);
        }

        function initFilters() {
            const sel = document.getElementById('parroquiaFilter');
            [...new Set(RAW_DATA.map(r=>r[1]))].sort().forEach(p => {
                if(p) sel.add(new Option(p.toUpperCase(), p));
            });
        }

        function applyFilter() {
            const val = document.getElementById('parroquiaFilter').value;
            FILTERED_DATA = val === 'ALL' ? RAW_DATA : RAW_DATA.filter(r=>r[1]===val);
            
            document.getElementById('reportTitle').innerText = val === 'ALL' ? "REPORTE CONSOLIDADO" : `REPORTE: ${val}`;
            updateDashboard();
        }

        function updateDashboard() {
            const total = FILTERED_DATA.length;
            if(total===0) return;

            // 1. MAPA Y TABLA
            markersLayer.clearLayers();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            
            let sums = new Array(8).fill(0);

            FILTERED_DATA.forEach(row => {
                // Calcular promedio fila
                let s = 0; for(let i=0; i<8; i++) s+=Number(row[i+7]);
                let avg = (s/8).toFixed(1);
                
                // Sumar totales
                for(let i=0; i<8; i++) sums[i]+=Number(row[i+7]);

                // Tabla
                tbody.innerHTML += `<tr>
                    <td>${new Date(row[0]).toLocaleDateString()}</td>
                    <td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td>
                    <td><span class="badge bg-light text-dark border rounded-0">${row[4]}</span></td>
                    <td style="font-family:monospace">${Number(row[5]).toFixed(4)}</td>
                    <td style="font-family:monospace">${Number(row[6]).toFixed(4)}</td>
                    <td><b>${avg}</b></td>
                </tr>`;

                // Marcador Mapa
                if(row[5] && row[6]) {
                    let color = avg>=4 ? '#10b981' : (avg>=3 ? '#f59e0b' : '#ef4444');
                    
                    // POPUP CON TODA LA INFORMACIÓN
                    let popupContent = `
                        <div style="font-family:'Roboto'; font-size:11px; width:200px;">
                            <div style="background:${color}; color:white; padding:5px; font-weight:bold; text-transform:uppercase;">
                                ${row[2]}
                            </div>
                            <table style="width:100%; margin-top:5px; border-collapse:collapse;">
                                <tr><td style="color:#666;">Parroquia:</td><td><b>${row[1]}</b></td></tr>
                                <tr><td style="color:#666;">Representante:</td><td>${row[3]}</td></tr>
                                <tr><td style="color:#666;">Cargo:</td><td>${row[4]}</td></tr>
                                <tr><td style="color:#666;">Fecha:</td><td>${new Date(row[0]).toLocaleDateString()}</td></tr>
                                <tr style="border-top:1px solid #eee;"><td style="padding-top:5px;">NOTA FINAL:</td><td style="padding-top:5px; font-size:14px;"><b>${avg}</b>/5.0</td></tr>
                            </table>
                        </div>
                    `;

                    L.circleMarker([row[5], row[6]], {
                        radius: 6, fillColor: color, color: '#333', weight: 1, fillOpacity: 1
                    }).bindPopup(popupContent).addTo(markersLayer);
                }
            });

            // 2. KPIS
            const avgs = sums.map(s=>(s/total).toFixed(1));
            const global = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            
            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiPromedio').innerText = global;

            renderGrid(avgs);
            renderRadar(avgs);
        }

        function renderGrid(avgs) {
            const container = document.getElementById('chartsGrid');
            container.innerHTML = "";

            avgs.forEach((avg, i) => {
                const level = avg>=4 ? 'high' : (avg>=3 ? 'mid' : 'low');
                const text = techAnalysisDB.generic[level][Math.floor(Math.random()*2)];
                const color = avg>=4 ? '#10b981' : (avg>=3 ? '#f59e0b' : '#ef4444');
                const id = `chart${i}`;

                container.innerHTML += `
                <div class="col-md-3">
                    <div class="panel-card h-100 p-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="card-title-text text-dark">${labels[i]}</span>
                            <span style="font-weight:700; font-size:0.9rem; color:${color}">${avg}</span>
                        </div>
                        <div style="height:40px;"><canvas id="${id}"></canvas></div>
                        <div class="tech-text">${text}</div>
                    </div>
                </div>`;

                setTimeout(() => {
                    new Chart(document.getElementById(id), {
                        type: 'bar',
                        data: { labels: [''], datasets: [{ data: [avg], backgroundColor: color, barThickness: 10, borderRadius: 2 }] },
                        options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: {min:0, max:5, display:false}, y: {display:false} }, plugins: {legend: {display:false}} }
                    });
                }, 0);
            });
        }

        function renderRadar(avgs) {
            const ctx = document.getElementById('radarChart');
            if(chartInstances['radar']) chartInstances['radar'].destroy();
            
            chartInstances['radar'] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels.map(l=>l.split('. ')[1]),
                    datasets: [{
                        label: 'Nivel', data: avgs,
                        backgroundColor: 'rgba(15, 23, 42, 0.2)',
                        borderColor: '#0f172a', borderWidth: 1.5, pointRadius: 2
                    }]
                },
                options: {
                    scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: {display:false}, grid:{color:'#e2e8f0'} } },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });
        }
        
        // Filtro tabla
        document.getElementById('searchBox').addEventListener('keyup', function() {
            let val = this.value.toLowerCase();
            document.querySelectorAll('#dataTable tbody tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        });
    </script>
</body>
</html>
