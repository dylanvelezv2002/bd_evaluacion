<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gestión de Riesgos | UEB - GAD</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #0f172a; /* Azul Oscuro Corporativo */
            --secondary-color: #334155;
            --accent-color: #2563eb; /* Azul Brillante UI */
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
        }

        /* NAVBAR */
        .navbar {
            background-color: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 15px 20px;
        }
        .brand-title {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        /* TARJETAS (CARDS) */
        .kpi-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .kpi-title { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .kpi-value { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin-top: 5px; }
        
        /* SECCIONES */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-top: 30px;
        }
        .section-title { font-size: 1.1rem; font-weight: 700; color: var(--secondary-color); }

        /* TABLAS */
        .custom-table thead { background-color: #f8fafc; }
        .custom-table th { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            color: #64748b; 
            font-weight: 700; 
            border-bottom: 2px solid #e2e8f0;
        }
        .custom-table td { font-size: 0.9rem; vertical-align: middle; border-color: #f1f5f9; }
        
        /* STATUS BADGES (Profesionales) */
        .status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-success { background-color: #dcfce7; color: #166534; } /* Verde suave */
        .status-warning { background-color: #fef9c3; color: #854d0e; } /* Amarillo suave */
        .status-danger { background-color: #fee2e2; color: #991b1b; } /* Rojo suave */

        /* ANALISIS BOX */
        .tech-analysis {
            background-color: #f8fafc;
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            font-size: 0.9rem;
            color: #475569;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <nav class="navbar fixed-top">
        <div class="container-fluid">
            <span class="brand-title">
                <i class="bi bi-bar-chart-fill text-primary me-2"></i>
                Sistema de Monitoreo de Comités
            </span>
            <div class="d-flex gap-2">
                <button onclick="window.print()" class="btn btn-outline-secondary btn-sm fw-bold">
                    <i class="bi bi-printer"></i> PDF
                </button>
                <button onclick="location.reload()" class="btn btn-primary btn-sm fw-bold">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4" style="margin-top: 80px; max-width: 1400px;">
        
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Comités Evaluados</div>
                    <div class="kpi-value" id="totalEncuestas">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Índice General de Gestión</div>
                    <div class="kpi-value" id="promedioGlobal">0.0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Indicador Más Alto</div>
                    <div class="kpi-value text-success" style="font-size: 1.2rem;" id="bestIndicator">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Área Crítica</div>
                    <div class="kpi-value text-danger" style="font-size: 1.2rem;" id="worstIndicator">-</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                
                <div class="kpi-card mb-4">
                    <h6 class="section-title mb-3">Perfil de Capacidades del Comité (Radar)</h6>
                    <div style="height: 350px; width: 100%;">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div class="tech-analysis mt-3">
                        <strong>Interpretación Técnica:</strong> 
                        <span id="radarAnalysis">Cargando datos para generar interpretación...</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <h6 class="section-title mb-3">Matriz de Evaluación (Objetivo 2)</h6>
                    <div class="table-responsive">
                        <table class="table custom-table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Variable / Indicador</th>
                                    <th class="text-center">Puntaje (1-5)</th>
                                    <th>Estado</th>
                                    <th>Observación Técnica</th>
                                </tr>
                            </thead>
                            <tbody id="matrixBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="kpi-card h-100">
                    <h6 class="section-title mb-3">Registro de Participantes</h6>
                    <input type="text" id="searchBox" class="form-control form-control-sm mb-3" placeholder="Filtrar por Parroquia...">
                    
                    <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                        <table class="table table-sm custom-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Parroquia</th>
                                    <th>Cargo</th>
                                </tr>
                            </thead>
                            <tbody id="participantsTable">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================================================
        // ⚠️ PEGA AQUÍ TU URL DEL SCRIPT DE GOOGLE
        // ===================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";

        // Configuración de Variables (Labels)
        const labels = [
            "1. Participación", "2. Compromiso", "3. Capacitación", 
            "4. Plan (Herramienta)", "5. Comunicación", "6. Articulación Inst.", 
            "7. Inclusión", "8. Replicabilidad"
        ];

        // Configuración de Análisis Automático
        const analysisConfig = [
            { id: 0, msgLow: "Baja convocatoria.", msgHigh: "Alta legitimidad social." },
            { id: 1, msgLow: "Liderazgo débil.", msgHigh: "Directiva empoderada." },
            { id: 2, msgLow: "Falta reforzar conocimientos.", msgHigh: "Conceptos claros." },
            { id: 3, msgLow: "Resistencia al Plan.", msgHigh: "Plan validado." },
            { id: 4, msgLow: "Tensión interna.", msgHigh: "Confianza alta." },
            { id: 5, msgLow: "Desconexión institucional.", msgHigh: "Sinergia GAD-UEB." },
            { id: 6, msgLow: "Directiva poco diversa.", msgHigh: "Inclusión efectiva." },
            { id: 7, msgLow: "Iniciativa aislada.", msgHigh: "Modelo replicable." }
        ];

        // Cargar Datos
        window.onload = () => {
            fetch(API_URL)
            .then(res => res.json())
            .then(response => {
                if(response.data) processData(response.data);
            })
            .catch(err => console.error("Error:", err));
        };

        function processData(rows) {
            // 1. KPIs Básicos
            document.getElementById('totalEncuestas').innerText = rows.length;
            
            // 2. Procesar Participantes (Tabla Derecha)
            const pTable = document.getElementById('participantsTable');
            pTable.innerHTML = "";
            rows.forEach(row => {
                let fecha = new Date(row[0]).toLocaleDateString();
                pTable.innerHTML += `
                    <tr>
                        <td style="font-size:0.8rem text-muted">${fecha}</td>
                        <td class="fw-bold">${row[1]}</td>
                        <td><span class="badge bg-light text-dark border">${row[4]}</span></td>
                    </tr>
                `;
            });

            // 3. Calcular Promedios
            let sums = new Array(8).fill(0);
            rows.forEach(row => {
                for(let i=0; i<8; i++) sums[i] += Number(row[i+5]); // Datos empiezan en col 5 (F)
            });
            
            const avgs = sums.map(s => (s / rows.length).toFixed(1));

            // 4. KPI Global
            const globalAvg = (avgs.reduce((a,b) => parseFloat(a)+parseFloat(b), 0) / 8).toFixed(1);
            document.getElementById('promedioGlobal').innerText = globalAvg;

            // 5. Encontrar Mejor y Peor
            let maxVal = Math.max(...avgs);
            let minVal = Math.min(...avgs);
            document.getElementById('bestIndicator').innerText = labels[avgs.indexOf(maxVal.toFixed(1))];
            document.getElementById('worstIndicator').innerText = labels[avgs.indexOf(minVal.toFixed(1))];

            // 6. Renderizar Matriz
            renderMatrix(avgs);
            
            // 7. Renderizar Radar Chart
            renderRadar(avgs);
        }

        function renderMatrix(avgs) {
            const tbody = document.getElementById('matrixBody');
            tbody.innerHTML = "";
            
            avgs.forEach((val, i) => {
                let badgeClass = "status-danger";
                let statusText = "ÁREA DE MEJORA";
                let obs = analysisConfig[i].msgLow;

                if(val >= 4.0) {
                    badgeClass = "status-success";
                    statusText = "FORTALEZA";
                    obs = analysisConfig[i].msgHigh;
                } else if(val >= 3.0) {
                    badgeClass = "status-warning";
                    statusText = "ALERTA";
                    obs = "Requiere seguimiento.";
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${labels[i]}</td>
                        <td class="text-center fw-bold">${val}</td>
                        <td><span class="status-badge ${badgeClass}">${statusText}</span></td>
                        <td class="text-muted small">${obs}</td>
                    </tr>
                `;
            });
        }

        function renderRadar(dataValues) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // Análisis Automático del Radar
            const avg = dataValues.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8;
            let analysisText = "";
            if(avg > 4) analysisText = "El comité presenta un perfil equilibrado y sólido en la mayoría de áreas.";
            else if(avg > 3) analysisText = "El comité es funcional pero presenta asimetrías en capacidades técnicas vs. sociales.";
            else analysisText = "El comité se encuentra en estado crítico y requiere intervención inmediata.";
            document.getElementById('radarAnalysis').innerText = analysisText;

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels.map(l => l.substring(3)), // Quitar el numero para la grafica
                    datasets: [{
                        label: 'Nivel de Gestión',
                        data: dataValues,
                        fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)', // Azul transparente
                        borderColor: 'rgb(37, 99, 235)',
                        pointBackgroundColor: 'rgb(37, 99, 235)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(37, 99, 235)'
                    }]
                },
                options: {
                    elements: { line: { borderWidth: 3 } },
                    scales: {
                        r: {
                            angleLines: { display: true, color: '#e2e8f0' },
                            grid: { color: '#e2e8f0' },
                            pointLabels: {
                                font: { size: 11, family: 'Inter' },
                                color: '#64748b'
                            },
                            suggestedMin: 0,
                            suggestedMax: 5,
                            ticks: { stepSize: 1, backdropColor: 'transparent' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        // Buscador Simple
        document.getElementById('searchBox').addEventListener('keyup', function() {
            let val = this.value.toLowerCase();
            let rows = document.querySelectorAll('#participantsTable tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        });
    </script>
</body>
</html>
