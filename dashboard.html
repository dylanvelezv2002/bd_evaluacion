<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISMON | Sistema de Monitoreo UEB</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- DISEÑO ENTERPRISE DASHBOARD --- */
        :root {
            --sidebar-bg: #0f172a; /* Azul muy oscuro profesional */
            --sidebar-text: #94a3b8;
            --bg-main: #f1f5f9;
            --card-bg: #ffffff;
            --primary: #2563eb;
            --risk-high: #dc2626;
            --risk-mid: #f59e0b;
            --risk-low: #16a34a;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); height: 100vh; overflow: hidden; margin: 0; display: flex; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 20px; height: 100vh; flex-shrink: 0; }
        .brand { font-size: 1.1rem; font-weight: 800; color: white; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .menu-item { padding: 12px 15px; color: var(--sidebar-text); text-decoration: none; display: flex; align-items: center; gap: 12px; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; font-size: 0.9rem; font-weight: 500; cursor: pointer; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .sidebar-footer { margin-top: auto; font-size: 0.7rem; color: #475569; border-top: 1px solid #1e293b; padding-top: 20px; }

        /* CONTENIDO PRINCIPAL */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        /* HEADER DE SECCIÓN */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 1.5rem; font-weight: 800; color: #1e293b; margin: 0; }
        .page-subtitle { font-size: 0.85rem; color: #64748b; font-weight: 500; }

        /* FILTRO ESTILIZADO */
        .custom-select { background: white; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 8px; font-weight: 600; color: #334155; min-width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
        .stat-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; line-height: 1.1; margin-bottom: 5px; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #64748b; letter-spacing: 0.5px; }
        .stat-icon { position: absolute; right: 20px; top: 25px; font-size: 2.5rem; opacity: 0.1; color: #1e293b; }

        /* MAPAS & GRÁFICOS */
        .visual-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; height: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-head { font-size: 0.85rem; font-weight: 800; color: #334155; text-transform: uppercase; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .map-frame { flex-grow: 1; border-radius: 8px; overflow: hidden; background: #e2e8f0; min-height: 400px; position: relative; }

        /* REPORTES A4 (SOLO SE VEN EN LA PESTAÑA 3) */
        .report-preview-area { background: #cbd5e1; padding: 40px; border-radius: 12px; display: flex; gap: 30px; overflow-x: auto; justify-content: center; }
        
        .a4-paper { 
            background: white; width: 210mm; min-height: 297mm; padding: 15mm; flex-shrink: 0;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.65); transform-origin: top center; margin-bottom: -90mm; margin-right: -20mm; margin-left: -20mm;
        }

        /* ESTILOS INTERNOS DEL REPORTE */
        .doc-header { border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .doc-title { font-size: 1.6rem; font-weight: 900; color: var(--primary); line-height: 1; }
        .doc-sub { font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-top: 5px; }
        .doc-meta { text-align: right; font-size: 0.7rem; color: #475569; }
        
        .doc-section { margin-bottom: 25px; }
        .doc-section-title { background: #f8fafc; color: #0f172a; font-weight: 800; text-transform: uppercase; font-size: 0.75rem; padding: 8px; border-left: 4px solid var(--primary); margin-bottom: 15px; }
        
        .analysis-block { font-size: 0.75rem; color: #334155; text-align: justify; line-height: 1.5; column-count: 2; column-gap: 25px; border: 1px solid #e2e8f0; padding: 15px; border-radius: 6px; background: #fff; }
        
        .matrix-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .matrix-item { border: 1px solid #e2e8f0; padding: 8px; border-radius: 4px; }
        .matrix-head { display: flex; justify-content: space-between; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; border-bottom: 1px solid #f1f5f9; }
        .matrix-text { font-size: 0.6rem; color: #64748b; line-height: 1.2; text-align: justify; }

        .doc-footer { position: absolute; bottom: 15mm; left: 15mm; right: 15mm; border-top: 1px solid #cbd5e1; padding-top: 10px; text-align: center; font-size: 0.6rem; color: #94a3b8; }

        /* UTILS */
        .badge-status { padding: 5px 10px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-warn { background: #fef9c3; color: #854d0e; }
        .status-crit { background: #fee2e2; color: #991b1b; }
        
        .hidden { display: none !important; }

        /* PRINT */
        @media print {
            .sidebar, .main-content > *:not(.printable-active), .no-print { display: none !important; }
            .main-content { padding: 0; margin: 0; height: auto; overflow: visible; }
            .printable-active { display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; transform: none !important; box-shadow: none; }
            @page { size: A4; margin: 10mm; }
        }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner mb-3"></div>
        <div class="small fw-bold text-secondary tracking-wide" id="loadMsg">INICIANDO SISTEMA...</div>
    </div>

    <div class="sidebar no-print">
        <div class="brand">
            <i class="bi bi-grid-1x2-fill text-primary fs-4"></i> SISMON v5.0
        </div>
        
        <div class="menu-item active" onclick="showView('home', this)">
            <i class="bi bi-speedometer2"></i> Dashboard General
        </div>
        <div class="menu-item" onclick="showView('diag', this)">
            <i class="bi bi-hospital"></i> 1. Diagnóstico Inst.
        </div>
        <div class="menu-item" onclick="showView('eval', this)">
            <i class="bi bi-people-fill"></i> 2. Evaluación Social
        </div>
        <div class="menu-item" onclick="showView('anexos', this)">
            <i class="bi bi-folder-fill"></i> 3. Estrategias (Anexo)
        </div>
        <div class="menu-item" onclick="showView('reports', this)">
            <i class="bi bi-printer-fill"></i> 4. Generar Reportes
        </div>

        <div class="sidebar-footer">
            <div>UEB - GAD PROVINCIAL SDT</div>
            <div class="opacity-50 mt-1">Prácticas Pre-Profesionales</div>
            <div class="mt-2 fw-bold text-white">Ing. Riesgos de Desastres</div>
        </div>
    </div>

    <div class="main-content">
        
        <div class="section-header no-print">
            <div>
                <h1 class="page-title" id="pageTitle">Panel de Control</h1>
                <div class="page-subtitle">Sistema de Monitoreo y Gestión de Riesgos</div>
            </div>
            <div>
                <select id="globalFilter" class="custom-select" onchange="applyGlobalFilter()">
                    <option value="ALL">TODA LA PROVINCIA</option>
                </select>
            </div>
        </div>

        <div id="view-home" class="view-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-val" id="home_total">0</div>
                    <div class="stat-label">Puntos Monitoreados</div>
                    <i class="bi bi-geo-alt-fill stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-val text-primary" id="home_index">0.0</div>
                    <div class="stat-label">Índice de Resiliencia</div>
                    <i class="bi bi-activity stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-val text-danger" id="home_alert">0%</div>
                    <div class="stat-label">Déficit Alertas</div>
                    <i class="bi bi-exclamation-triangle-fill stat-icon"></i>
                </div>
            </div>
            <div class="visual-card">
                <div class="card-head">
                    <span>Mapa de Situación Provincial</span>
                    <span class="badge bg-primary text-white">TIEMPO REAL</span>
                </div>
                <div id="mapHome" class="map-frame"></div>
            </div>
        </div>

        <div id="view-diag" class="view-section hidden">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-val" id="d_gads">0</div><div class="stat-label">GADs Activos</div></div>
                <div class="stat-card"><div class="stat-val text-success" id="d_veh">0%</div><div class="stat-label">Cobertura Vehicular</div></div>
                <div class="stat-card"><div class="stat-val text-danger" id="d_alm">0%</div><div class="stat-label">Sist. Alarma</div></div>
            </div>
            <div class="row g-4 h-100">
                <div class="col-lg-8">
                    <div class="visual-card">
                        <div class="card-head">Georreferenciación de Recursos</div>
                        <div id="mapDiag" class="map-frame"></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="visual-card gap-3">
                        <div style="flex:1"><canvas id="chartD1"></canvas></div>
                        <div style="flex:1"><canvas id="chartD2"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-eval" class="view-section hidden">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-val" id="e_tot">0</div><div class="stat-label">Comunidades</div></div>
                <div class="stat-card"><div class="stat-val text-primary" id="e_prom">0.0</div><div class="stat-label">Índice Gestión</div></div>
                <div class="stat-card"><div class="stat-val" id="e_status">-</div><div class="stat-label">Estado General</div></div>
            </div>
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="visual-card">
                        <div class="card-head">Mapa de Percepción Social</div>
                        <div id="mapEval" class="map-frame"></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="visual-card">
                        <div class="card-head">Radar de Variables</div>
                        <div style="flex-grow:1; display:flex; justify-content:center;"><canvas id="chartEval"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-anexos" class="view-section hidden">
            <div class="visual-card align-items-center justify-content-center text-center" style="min-height: 60vh;">
                <i class="bi bi-cone-striped text-warning mb-3" style="font-size: 4rem;"></i>
                <h2 class="fw-bold text-dark">EN CONSTRUCCIÓN</h2>
                <h5 class="text-secondary text-uppercase mb-4">Objetivo Específico 3: Estrategias y Planes</h5>
                <p class="text-muted" style="max-width: 600px;">
                    "Proponer estrategias a los actores comunitarios en la aplicación de la guía para la conformación de los 10 planes comunitarios desarrollados en cada parroquia."
                </p>
                <div class="mt-4 p-3 bg-light rounded border">
                    <i class="bi bi-info-circle me-2"></i>Este módulo servirá como repositorio digital de los anexos.
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section hidden">
            <div class="text-center mb-4 no-print">
                <div class="badge bg-dark mb-2">VISTA PREVIA (ESCALA REDUCIDA)</div>
                <p class="small text-muted">Selecciona un informe para imprimir. Se generará en A4 automáticamente.</p>
            </div>
            
            <div class="report-preview-area">
                
                <div class="d-flex flex-column gap-2">
                    <button onclick="printDoc('doc1')" class="btn btn-primary fw-bold shadow no-print"><i class="bi bi-printer me-2"></i>IMPRIMIR DIAGNÓSTICO</button>
                    
                    <div id="doc1" class="a4-paper">
                        <div class="doc-header">
                            <div>
                                <div class="text-uppercase fw-bold text-muted" style="font-size:0.7rem">UEB • GAD PROVINCIAL SDT</div>
                                <div class="doc-title">INFORME DE CAPACIDADES</div>
                                <div class="doc-sub">DIAGNÓSTICO SITUACIONAL (OBJETIVO 1)</div>
                            </div>
                            <div class="doc-meta">
                                <strong>Tutor:</strong> Ing. Mauricio Ledesma<br>
                                <span class="text-primary fw-bold loc-label">UBICACIÓN</span><br>
                                <span class="date-label">--/--/--</span>
                            </div>
                        </div>

                        <div class="row mb-4 text-center">
                            <div class="col-4"><div class="p-2 bg-light border rounded"><div class="fw-bold text-primary fs-3" id="r1_salud">0%</div><div class="small fw-bold text-muted">SALUD</div></div></div>
                            <div class="col-4"><div class="p-2 bg-light border rounded"><div class="fw-bold text-danger fs-3" id="r1_alarma">0%</div><div class="small fw-bold text-muted">ALARMAS</div></div></div>
                            <div class="col-4"><div class="p-2 bg-light border rounded"><div class="fw-bold text-success fs-3" id="r1_veh">0%</div><div class="small fw-bold text-muted">VEHÍCULOS</div></div></div>
                        </div>

                        <div class="row mb-4" style="height: 250px;">
                            <div class="col-7 h-100"><div style="border:1px solid #ccc; height:100%; border-radius:4px; overflow:hidden;"><div id="mapR1" style="width:100%; height:100%"></div></div></div>
                            <div class="col-5 h-100"><canvas id="chartR1"></canvas></div>
                        </div>

                        <div class="doc-section">
                            <div class="doc-section-title">DICTAMEN TÉCNICO SITUACIONAL</div>
                            <div id="r1_analysis" class="analysis-block"></div>
                        </div>

                        <div class="doc-footer">
                            Producto de Prácticas Pre-Profesionales: <strong>"Fortalecimiento de capacidades ante riesgos y desastres."</strong><br>
                            <strong>Dylan Vélez & Jordan Sanabria</strong> | Ingeniería en Riesgos de Desastres | UEB
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-column gap-2">
                    <button onclick="printDoc('doc2')" class="btn btn-danger fw-bold shadow no-print"><i class="bi bi-printer me-2"></i>IMPRIMIR EVALUACIÓN</button>
                    
                    <div id="doc2" class="a4-paper">
                        <div class="doc-header" style="border-color: var(--risk-high);">
                            <div>
                                <div class="text-uppercase fw-bold text-muted" style="font-size:0.7rem">UEB • GAD PROVINCIAL SDT</div>
                                <div class="doc-title" style="color:var(--risk-high)">EVALUACIÓN COMUNITARIA</div>
                                <div class="doc-sub" style="color:#b91c1c">ANÁLISIS DE RESILIENCIA (OBJETIVO 2)</div>
                            </div>
                            <div class="doc-meta">
                                <strong>Tutor:</strong> Ing. Mauricio Ledesma<br>
                                <span class="text-danger fw-bold loc-label">UBICACIÓN</span><br>
                                <span class="date-label">--/--/--</span>
                            </div>
                        </div>

                        <div class="row mb-4 text-center">
                            <div class="col-4"><div class="p-2 bg-light border rounded"><div class="fw-bold fs-3" id="r2_count">0</div><div class="small fw-bold text-muted">MUESTRA</div></div></div>
                            <div class="col-4"><div class="p-2 bg-light border rounded"><div class="fw-bold text-primary fs-3" id="r2_index">0.0</div><div class="small fw-bold text-muted">ÍNDICE</div></div></div>
                            <div class="col-4"><div class="p-2 bg-light border rounded"><div class="fw-bold text-warning fs-3" id="r2_status">-</div><div class="small fw-bold text-muted">ESTADO</div></div></div>
                        </div>

                        <div class="row mb-4" style="height: 200px;">
                            <div class="col-6 h-100"><div style="border:1px solid #ccc; height:100%; border-radius:4px; overflow:hidden;"><div id="mapR2" style="width:100%; height:100%"></div></div></div>
                            <div class="col-6 h-100 d-flex justify-content-center"><canvas id="chartR2"></canvas></div>
                        </div>

                        <div class="doc-section">
                            <div class="doc-section-title">MATRIZ DE ANÁLISIS FACTORIAL</div>
                            <div id="r2_matrix" class="matrix-grid"></div>
                        </div>

                        <div class="doc-footer">
                            Producto de Prácticas Pre-Profesionales: <strong>"Fortalecimiento de capacidades ante riesgos y desastres."</strong><br>
                            <strong>Dylan Vélez & Jordan Sanabria</strong> | Ingeniería en Riesgos de Desastres | UEB
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- CONFIGURACIÓN DEL SISTEMA ---
        const API_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec");
        const PARROQUIAS = ["Alluriquín", "Puerto Limón", "Luz de América", "San Jacinto del Búa", "Valle Hermoso", "El Esfuerzo", "Santa María del Toachi", "La Villegas", "Monterrey", "Plan Piloto"];
        const VARS = ["Participación", "Compromiso", "Capacitación", "Plan Local", "Comunicación", "Articulación", "Inclusión", "Réplica"];

        // BANCO DE REDACCIÓN TÉCNICA (NO REPETITIVA)
        const TECHNICAL_DB = {
            obj1: {
                intro: ["El levantamiento de información en el territorio de", "El diagnóstico técnico ejecutado en", "La evaluación de infraestructura en"],
                deficit: ["evidencia una vulnerabilidad sistémica crítica", "muestra brechas significativas en la capacidad instalada", "revela una fragilidad operativa"],
                solid: ["presenta indicadores de cobertura aceptables", "demuestra una estructura de respuesta consolidada", "refleja una inversión sostenida en recursos"],
                rec: ["Se impera la necesidad de implementar sistemas de alerta temprana.", "Es urgente la gestión interinstitucional para dotación vehicular.", "Se recomienda fortalecer los protocolos de mantenimiento."]
            },
            obj2: {
                low: ["Desarticulación estructural. La comunidad carece de cohesión para la respuesta organizada.", "Percepción del riesgo nula. No existen mecanismos de autoprotección activados.", "Vulnerabilidad social alta. Dependencia total de organismos externos."],
                mid: ["Organización incipiente. Existen líderes identificados pero falta capacitación técnica.", "Respuesta reactiva. La comunidad actúa post-evento sin planificación previa.", "Cohesión parcial. Se requiere fortalecer los canales de comunicación."],
                high: ["Resiliencia consolidada. La comunidad posee protocolos de actuación validados.", "Autogestión efectiva. Capacidad demostrada para la primera respuesta local.", "Gobernanza robusta. Alta participación en la toma de decisiones preventivas."]
            }
        };

        let DATA_CAP=[], DATA_EVAL=[], maps={}, charts={};

        // --- INICIO ---
        window.onload = () => {
            const s = document.getElementById('parroquiaFilter');
            PARROQUIAS.sort().forEach(p => s.add(new Option(p, p)));
            
            initMaps();
            startSystem();
        };

        function startSystem() {
            const msgs = ["CONECTANDO SERVIDOR...", "VERIFICANDO DATOS...", "CALCULANDO ÍNDICES...", "GENERANDO VISTAS..."];
            let i=0; const t = setInterval(()=>document.getElementById('loadMsg').innerText=msgs[i++%msgs.length], 800);

            fetch(API_URL + "&t=" + Date.now())
                .then(r => r.json())
                .then(d => {
                    clearInterval(t);
                    if(d.status === 'success') initData(d.dataCap, d.dataEval);
                    else throw new Error("Data Error");
                })
                .catch(() => {
                    clearInterval(t);
                    console.warn("Offline");
                    // Datos Dummy
                    initData([["","Alluriquín","","","-.29","-79.05","SI","NO","SI","SI","NO","SI","NO","SI"]], 
                             [["2025-11-22","Alluriquín","Centro","Lider","Juan",-.29,-79.05,4,5,3,4,5,4,3,5]]);
                });
        }

        function initData(dc, de) {
            DATA_CAP = dc||[]; DATA_EVAL = de||[];
            document.getElementById('loader').style.display='none';
            applyGlobalFilter();
        }

        // --- NAVEGACIÓN ---
        window.showView = (id, el) => {
            document.querySelectorAll('.view-section').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            
            // Refrescar Mapas al cambiar de vista
            setTimeout(() => {
                Object.values(maps).forEach(m => m.invalidateSize());
                if(id==='reports') { fitMap(maps.mapR1); fitMap(maps.mapR2); }
            }, 100);

            const titles = {home:"Panel de Control", diag:"Diagnóstico Institucional", eval:"Evaluación Comunitaria", reports:"Generador de Informes", anexos:"Estrategias y Planes"};
            document.getElementById('pageTitle').innerText = titles[id];
        };

        // --- LÓGICA DE NEGOCIO ---
        window.applyGlobalFilter = () => {
            const val = document.getElementById('globalFilter').value; // Filtro del header
            // Sincronizar con el filtro de la sidebar si existiera, o usar el ID correcto
            // Nota: En el HTML usé 'parroquiaFilter' en el sidebar y 'globalFilter' en el header.
            // Vamos a usar el del header como principal.
            const pVal = document.getElementById('parroquiaFilter').value; // Usamos este si el del header no existe o viceversa
            
            const selVal = document.getElementById('parroquiaFilter').value;
            const isProv = selVal === 'ALL';
            const name = isProv ? "CONSOLIDADO PROVINCIAL" : "PARROQUIA " + selVal.toUpperCase();

            const fCap = isProv ? DATA_CAP : DATA_CAP.filter(r => r[1] === selVal);
            const fEval = isProv ? DATA_EVAL : DATA_EVAL.filter(r => r[1] === selVal);

            updateHome(fCap, fEval);
            updateDiag(fCap);
            updateEval(fEval);
            updateReports(fCap, fEval, name);
        };

        function updateHome(dc, de) {
            // Stats Home
            let alertDef = dc.length ? (dc.filter(r=>r[11]==='NO').length / dc.length * 100) : 0;
            let sums=new Array(8).fill(0); de.forEach(r=>{for(let i=0;i<8;i++)sums[i]+=Number(r[i+7])});
            let idx = de.length ? (sums.reduce((a,b)=>a+b,0)/(de.length*8)).toFixed(1) : "0.0";

            document.getElementById('home_total').innerText = dc.length + de.length;
            document.getElementById('home_index').innerText = idx;
            document.getElementById('home_alert').innerText = Math.round(alertDef) + "%";

            // Mapa Home (Muestra todo)
            let lg = L.layerGroup();
            dc.forEach(r=> {if(parseFloat(r[4])) L.circleMarker([r[4],r[5]],{radius:4,color:'#2563eb'}).addTo(lg)});
            de.forEach(r=> {if(parseFloat(r[5])) L.circleMarker([r[5],r[6]],{radius:4,color:'#dc2626'}).addTo(lg)});
            refreshMap('mapHome', lg);
        }

        function updateDiag(d) {
            document.getElementById('d_gads').innerText = d.length;
            let s=0,a=0,v=0,f=0;
            let lg = L.layerGroup();
            d.forEach(r => {
                if(r[6]==='SI')s++; if(r[8]==='SI')f++; if(r[11]==='SI')a++; if(r[13]==='SI')v++;
                if(parseFloat(r[4])) {
                    let sc = (r[6]==='SI'?1:0)+(r[11]==='SI'?1:0)+(r[13]==='SI'?1:0);
                    let c = sc>=2?'#16a34a':(sc===1?'#f59e0b':'#dc2626');
                    L.circleMarker([r[4],r[5]], {radius:6,color:'white',fillColor:c,fillOpacity:0.9,weight:1}).addTo(lg)
                    .bindPopup(`<div class="pop-head">${r[1]}</div><div class="pop-body">Salud: ${r[6]}<br>Alarma: ${r[11]}</div>`);
                }
            });
            refreshMap('mapDiag', lg);
            
            let t = d.length||1;
            document.getElementById('d_veh').innerText = Math.round(v/t*100)+"%";
            document.getElementById('d_alm').innerText = Math.round(a/t*100)+"%";

            renderBar('chartD1', ['Salud','Fuego'], [s,f], '#2563eb');
            renderBar('chartD2', ['Alarma','Vehículo'], [a,v], '#16a34a');
        }

        function updateEval(d) {
            document.getElementById('e_tot').innerText = d.length;
            let sums=new Array(8).fill(0);
            let lg = L.layerGroup();
            d.forEach(r => {
                for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]);
                if(parseFloat(r[5])) {
                    let avg=0; for(let i=0;i<8;i++) avg+=Number(r[i+7]); avg/=8;
                    let c = avg>=4?'#16a34a':(avg>=3?'#f59e0b':'#dc2626');
                    L.circleMarker([r[5],r[6]], {radius:6,color:'white',fillColor:c,fillOpacity:0.9,weight:1}).addTo(lg)
                    .bindPopup(`<div class="pop-head">${r[2]}</div><div class="pop-body">Nota: ${avg.toFixed(1)}<br>Resp: ${r[4]}</div>`);
                }
            });
            refreshMap('mapEval', lg);

            let avgs = sums.map(x => (x/(d.length||1)).toFixed(1));
            let glob = (avgs.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/8).toFixed(1);
            document.getElementById('e_prom').innerText = glob;
            document.getElementById('e_status').innerText = glob>=4?"SÓLIDO":(glob>=3?"MEDIO":"BAJO");
            
            renderRadar('chartEval', avgs, '#2563eb', 'rgba(37,99,235,0.2)');
        }

        // --- LÓGICA DE REPORTES ---
        function updateReports(dc, de, name) {
            // Common
            document.querySelectorAll('.loc-label').forEach(e => e.innerText = name);
            document.querySelectorAll('.date-label').forEach(e => e.innerText = new Date().toLocaleDateString());

            // DOC 1: DIAGNÓSTICO
            let t1 = dc.length||1;
            let s=dc.filter(r=>r[6]==='SI').length, a=dc.filter(r=>r[11]==='SI').length, v=dc.filter(r=>r[13]==='SI').length;
            
            document.getElementById('r1_salud').innerText = Math.round(s/t1*100)+"%";
            document.getElementById('r1_alarma').innerText = Math.round(a/t1*100)+"%";
            document.getElementById('r1_veh').innerText = Math.round(v/t1*100)+"%";
            
            // Redacción Técnica Obj 1
            let p1 = (a/t1) < 0.5 ? TECHNICAL_DB.obj1.deficit[0] : TECHNICAL_DB.obj1.solid[0];
            let p2 = (v/t1) < 0.5 ? TECHNICAL_DB.obj1.rec[1] : "La capacidad logística es adecuada.";
            document.getElementById('r1_analysis').innerHTML = `
                <p><strong>ANÁLISIS OPERATIVO:</strong> ${TECHNICAL_DB.obj1.intro[0]} ${name} ${p1}. Los datos cuantitativos indican una cobertura de salud del ${Math.round(s/t1*100)}% y una disponibilidad vehicular del ${Math.round(v/t1*100)}%.</p>
                <p><strong>CONCLUSIÓN:</strong> ${p2} Se requiere mantener el monitoreo constante de los indicadores críticos.</p>
            `;

            renderBar('chartR1', ['Salud','Alarma','Vehículo'], [s,a,v], '#1e3a8a');
            let lg1 = L.layerGroup();
            dc.forEach(r=>{if(parseFloat(r[4])) L.circleMarker([r[4],r[5]],{radius:4,color:'#000',weight:0.5,fillColor:'#2563eb',fillOpacity:1}).addTo(lg1)});
            refreshMap('mapR1', lg1);

            // DOC 2: EVALUACIÓN
            document.getElementById('r2_count').innerText = de.length;
            let sums=new Array(8).fill(0);
            de.forEach(r => { for(let i=0;i<8;i++) sums[i]+=Number(r[i+7]); });
            let avgs = sums.map(x => Number((x/(de.length||1)).toFixed(1)));
            let glob = (avgs.reduce((a,b)=>a+b,0)/8).toFixed(1);

            document.getElementById('r2_index').innerText = glob;
            let st = document.getElementById('r2_status');
            st.innerText = glob>=3.5?"ALTO":(glob>=2.5?"MEDIO":"BAJO");
            st.style.color = glob>=3.5?"#16a34a":(glob>=2.5?"#f59e0b":"#dc2626");

            renderRadar('chartR2', avgs, '#dc2626', 'rgba(220,38,38,0.1)');
            
            let lg2 = L.layerGroup();
            de.forEach(r=>{
                let val=0; for(let i=0;i<8;i++) val+=Number(r[i+7]); val/=8;
                let c=val>=4?'#16a34a':(val>=3?'#f59e0b':'#dc2626');
                if(parseFloat(r[5])) L.circleMarker([r[5],r[6]],{radius:4,color:'#000',weight:0.5,fillColor:c,fillOpacity:1}).addTo(lg2);
            });
            refreshMap('mapR2', lg2);

            // Matriz Técnica Obj 2
            const grid = document.getElementById('r2_matrix'); grid.innerHTML="";
            avgs.forEach((score, i) => {
                let txt = score>=4 ? TECHNICAL_DB.obj2.high[0] : (score>=3 ? TECHNICAL_DB.obj2.mid[0] : TECHNICAL_DB.obj2.low[0]);
                grid.innerHTML += `
                <div class="matrix-item">
                    <div class="matrix-head">
                        <span>${VARS[i]}</span>
                        <span>${score}/5.0</span>
                    </div>
                    <div class="matrix-text">${txt}</div>
                </div>`;
            });
        }

        // --- MAPS & CHARTS INIT ---
        function initMaps() {
            ['mapHome','mapDiag','mapEval','mapR1','mapR2'].forEach(id => {
                maps[id] = L.map(id, {zoomControl:false, attributionControl:false}).setView([-0.25, -79.17], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(maps[id]);
            });
        }
        function refreshMap(id, lg) {
            maps[id].eachLayer(l => { if(!!l.toGeoJSON) maps[id].removeLayer(l); });
            lg.addTo(maps[id]);
            if(lg.getLayers().length>0) setTimeout(()=>fitMap(maps[id]), 200);
        }
        function fitMap(m) { m.setView([-0.25, -79.17], 10); }
        
        function renderBar(id,l,d,c) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {type:'bar',data:{labels:l,datasets:[{data:d,backgroundColor:c,borderRadius:4}]},options:{indexAxis:'y',maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{display:false}}}}});
        }
        function renderRadar(id,d,c,bg) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {type:'radar',data:{labels:VARS,datasets:[{data:d,borderColor:c,backgroundColor:bg,pointRadius:2}]},options:{maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{r:{min:0,max:5,ticks:{display:false},pointLabels:{font:{size:8}}}}}});
        }

        window.printDoc = (id) => {
            document.querySelectorAll('.printable-active').forEach(e=>e.classList.remove('printable-active'));
            document.getElementById(id).classList.add('printable-active');
            window.print();
        };
    </script>
</body>
</html>
