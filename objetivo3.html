<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión PCDGR | Anexos</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f3f4f6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #1f2937; padding-bottom: 100px; }

        /* ESTILOS ACORDEÓN */
        .accordion-item { border: 1px solid #e5e7eb; border-radius: 8px !important; margin-bottom: 12px; overflow: hidden; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .accordion-button { font-weight: 700; color: var(--primary); background-color: #fff; padding: 1rem 1.25rem; }
        .accordion-button:not(.collapsed) { color: var(--accent); background-color: #eff6ff; box-shadow: none; }
        .accordion-button:focus { box-shadow: none; border-color: rgba(37,99,235,0.1); }

        /* FORMULARIOS */
        .form-label { font-size: 0.75rem; font-weight: 700; color: #4b5563; text-transform: uppercase; margin-bottom: 4px; }
        .form-control, .form-select { font-size: 0.9rem; padding: 0.6rem; border-radius: 6px; border: 1px solid #d1d5db; }
        .form-control:focus { border-color: var(--accent); ring: 2px var(--accent); }

        /* TABLAS DE INTEGRANTES */
        .nav-tabs .nav-link { font-size: 0.8rem; font-weight: 600; color: #6b7280; }
        .nav-tabs .nav-link.active { color: var(--accent); border-bottom: 2px solid var(--accent); font-weight: 800; }
        .table-custom th { background: #f9fafb; font-size: 0.7rem; text-transform: uppercase; color: #6b7280; padding: 8px; }
        .table-custom td { padding: 5px; vertical-align: middle; }
        
        /* CHECK VERDE SI HAY ARCHIVO */
        .file-check { display: none; color: #16a34a; font-size: 0.75rem; font-weight: 700; margin-top: 4px; }
        .has-file .file-check { display: block; }
        .has-file { border-color: #22c55e !important; background-color: #f0fdf4; }

        /* BOTONES */
        .btn-add { font-size: 0.75rem; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 5px; margin-top: 8px; cursor: pointer; }
        .btn-del { color: #ef4444; background: #fee2e2; border: none; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-del:hover { background: #ef4444; color: white; }
        
        .btn-submit { background: var(--primary); color: white; width: 100%; padding: 16px; border-radius: 8px; font-weight: 700; border: none; transition: 0.2s; }
        .btn-submit:hover { background: #1e293b; transform: translateY(-2px); }

        #preloader { position: fixed; inset:0; background:rgba(255,255,255,0.95); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div id="preloader">
    <div class="spinner-border text-primary mb-2"></div>
    <div class="small fw-bold text-muted">CARGANDO...</div>
</div>

<div class="container mt-4" style="max-width: 850px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-primary m-0">GESTIÓN DE ANEXOS</h4>
            <span class="text-muted small">Planes Comunitarios de Gestión de Riesgos</span>
        </div>
        <div class="badge bg-white text-dark border px-3 py-2 shadow-sm">
            <i class="bi bi-calendar-event me-1"></i> <span id="fechaDisplay"></span>
        </div>
    </div>

    <form id="mainForm">
        <input type="hidden" name="tipo" value="anexos_full">
        <input type="hidden" name="fecha_subida" id="fechaSubida">

        <div class="accordion" id="mainAccordion">

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#sec1" aria-expanded="true">
                        1. UBICACIÓN Y BÚSQUEDA
                    </button>
                </h2>
                <div id="sec1" class="accordion-collapse collapse show" data-bs-parent="#mainAccordion">
                    <div class="accordion-body bg-light">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Parroquia</label>
                                <select class="form-select" id="selParroquia" name="parroquia" required>
                                    <option value="" disabled selected>Seleccione...</option>
                                    <option value="Alluriquín">Alluriquín</option>
                                    <option value="Puerto Limón">Puerto Limón</option>
                                    <option value="Luz de América">Luz de América</option>
                                    <option value="San Jacinto del Búa">San Jacinto del Búa</option>
                                    <option value="Valle Hermoso">Valle Hermoso</option>
                                    <option value="El Esfuerzo">El Esfuerzo</option>
                                    <option value="Santa María del Toachi">Santa María del Toachi</option>
                                    <option value="La Villegas">La Villegas</option>
                                    <option value="Monterrey">Monterrey</option>
                                    <option value="Plan Piloto">Plan Piloto</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Comunidad / Recinto</label>
                                <input type="text" class="form-control" id="txtComunidad" name="comunidad" placeholder="Nombre exacto..." required>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-primary fw-bold w-100" onclick="buscarDatos()">
                                    <i class="bi bi-search me-1"></i> BUSCAR
                                </button>
                            </div>
                        </div>
                        <div id="searchFeedback" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec2">
                        2. INFORMACIÓN GENERAL
                    </button>
                </h2>
                <div id="sec2" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
                    <div class="accordion-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Responsable de Carga</label>
                                <input type="text" class="form-control" id="inpResponsable" name="responsable" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nombre del Plan</label>
                                <input type="text" class="form-control" id="inpPlan" name="plan_nombre" placeholder="Ej: Plan 2025">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Observaciones</label>
                                <textarea class="form-control" id="inpObs" name="observaciones" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec3">
                        3. INTEGRANTES (ANEXO 6 Y 7)
                    </button>
                </h2>
                <div id="sec3" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
                    <div class="accordion-body p-0">
                        <ul class="nav nav-tabs nav-fill bg-light px-2 pt-2" id="myTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabMando" type="button">Mando</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAux" type="button">Auxilios</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabInc" type="button">Incendios</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEva" type="button">Evacuación</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabProm" type="button">Promotores</button></li>
                        </ul>

                        <div class="tab-content p-3" id="myTabContent">
                            <div class="tab-pane fade show active" id="tabMando">
                                <h6 class="text-primary fw-bold small mb-3">ANEXO 6: CABEZAS DE MANDO</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Responsable Comité</label>
                                        <input type="text" class="form-control mb-2" name="head_resp_nom" placeholder="Nombres">
                                        <div class="d-flex gap-2">
                                            <input type="text" class="form-control" name="head_resp_ci" placeholder="Cédula">
                                            <input type="text" class="form-control" name="head_resp_tel" placeholder="Teléfono">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Coordinador Brigadas</label>
                                        <input type="text" class="form-control mb-2" name="head_coord_nom" placeholder="Nombres">
                                        <div class="d-flex gap-2">
                                            <input type="text" class="form-control" name="head_coord_ci" placeholder="Cédula">
                                            <input type="text" class="form-control" name="head_coord_tel" placeholder="Teléfono">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tabAux">
                                <div class="bg-primary bg-opacity-10 p-2 rounded mb-3 border border-primary">
                                    <label class="form-label text-primary">LÍDER BRIGADA AUXILIOS</label>
                                    <div class="row g-2">
                                        <div class="col-5"><input type="text" class="form-control form-control-sm" name="lider_aux_nom" placeholder="Nombre"></div>
                                        <div class="col-3"><input type="text" class="form-control form-control-sm" name="lider_aux_ci" placeholder="C.I."></div>
                                        <div class="col-4"><input type="text" class="form-control form-control-sm" name="lider_aux_tel" placeholder="Tel"></div>
                                    </div>
                                </div>
                                <table class="table table-sm table-custom w-100" id="tbl_aux"><tbody></tbody></table>
                                <div class="btn-add text-primary" onclick="addRow('aux')"><i class="bi bi-plus-circle-fill"></i> Agregar Integrante</div>
                            </div>

                            <div class="tab-pane fade" id="tabInc">
                                <div class="bg-danger bg-opacity-10 p-2 rounded mb-3 border border-danger">
                                    <label class="form-label text-danger">LÍDER BRIGADA INCENDIOS</label>
                                    <div class="row g-2">
                                        <div class="col-5"><input type="text" class="form-control form-control-sm" name="lider_inc_nom" placeholder="Nombre"></div>
                                        <div class="col-3"><input type="text" class="form-control form-control-sm" name="lider_inc_ci" placeholder="C.I."></div>
                                        <div class="col-4"><input type="text" class="form-control form-control-sm" name="lider_inc_tel" placeholder="Tel"></div>
                                    </div>
                                </div>
                                <table class="table table-sm table-custom w-100" id="tbl_inc"><tbody></tbody></table>
                                <div class="btn-add text-danger" onclick="addRow('inc')"><i class="bi bi-plus-circle-fill"></i> Agregar Integrante</div>
                            </div>

                            <div class="tab-pane fade" id="tabEva">
                                <div class="bg-success bg-opacity-10 p-2 rounded mb-3 border border-success">
                                    <label class="form-label text-success">LÍDER BRIGADA EVACUACIÓN</label>
                                    <div class="row g-2">
                                        <div class="col-5"><input type="text" class="form-control form-control-sm" name="lider_eva_nom" placeholder="Nombre"></div>
                                        <div class="col-3"><input type="text" class="form-control form-control-sm" name="lider_eva_ci" placeholder="C.I."></div>
                                        <div class="col-4"><input type="text" class="form-control form-control-sm" name="lider_eva_tel" placeholder="Tel"></div>
                                    </div>
                                </div>
                                <table class="table table-sm table-custom w-100" id="tbl_eva"><tbody></tbody></table>
                                <div class="btn-add text-success" onclick="addRow('eva')"><i class="bi bi-plus-circle-fill"></i> Agregar Integrante</div>
                            </div>

                            <div class="tab-pane fade" id="tabProm">
                                <div class="bg-dark bg-opacity-10 p-2 rounded mb-3 border border-dark">
                                    <label class="form-label text-dark">LÍDER PROMOTOR (ANEXO 7)</label>
                                    <div class="row g-2">
                                        <div class="col-5"><input type="text" class="form-control form-control-sm" name="lider_prom_nom" placeholder="Nombre"></div>
                                        <div class="col-3"><input type="text" class="form-control form-control-sm" name="lider_prom_ci" placeholder="C.I."></div>
                                        <div class="col-4"><input type="text" class="form-control form-control-sm" name="lider_prom_tel" placeholder="Tel"></div>
                                    </div>
                                </div>
                                <table class="table table-sm table-custom w-100" id="tbl_prom"><tbody></tbody></table>
                                <div class="btn-add text-dark" onclick="addRow('prom')"><i class="bi bi-plus-circle-fill"></i> Agregar Promotor</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec4">
                        4. ARCHIVOS DIGITALES (13 ANEXOS)
                    </button>
                </h2>
                <div id="sec4" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
                    <div class="accordion-body bg-light">
                        <div class="row g-3">
                            <script>
                                const fileLabels = [
                                    "1. Acta de Asamblea", "2. Listado Participantes", "3. Plan Firmado", 
                                    "4. Matriz de Actores", "5. Mapa Comunitario", "6. Ficha Comité (Scan)", 
                                    "7. Ficha Promotores (Scan)", "8. Cronograma", "9. Evidencias Fotos", 
                                    "10. Informe Final", "11. Anexo Extra A", "12. Anexo Extra B", "13. Anexo Extra C"
                                ];
                                fileLabels.forEach((lbl, i) => {
                                    document.write(`
                                    <div class="col-md-6 col-lg-4">
                                        <div class="p-3 bg-white border rounded shadow-sm h-100" id="boxFile${i+1}">
                                            <div style="font-weight:700; font-size:0.8rem; margin-bottom:5px;">${lbl}</div>
                                            <input type="file" class="form-control form-control-sm anexo-file" data-id="${i+1}" accept=".pdf,.jpg,.png">
                                            <div class="file-check" id="check${i+1}"><i class="bi bi-check-circle-fill"></i> Guardado en Nube</div>
                                        </div>
                                    </div>`);
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>

        </div> <div class="mt-4">
            <button type="submit" class="btn-submit shadow">
                <i class="bi bi-cloud-arrow-up-fill me-2 fs-5"></i>
                GUARDAR Y SUBIR INFORMACIÓN
            </button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ⚠️ REEMPLAZA CON LA URL DE TU WORKER
    const API_URL = "https://ueb.dylanvillasagua.workers.dev/";

    window.onload = () => {
        document.getElementById('preloader').style.display = 'none';
        document.getElementById('fechaSubida').value = new Date().toISOString();
        document.getElementById('fechaDisplay').innerText = new Date().toLocaleDateString();
    };

    // --- AGREGAR FILAS A LAS TABLAS ---
    function addRow(type) {
        const tbody = document.getElementById('tbl_' + type).querySelector('tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="width:45%"><input type="text" class="form-control form-control-sm" name="list_${type}_nom[]" placeholder="Nombre"></td>
            <td style="width:25%"><input type="text" class="form-control form-control-sm" name="list_${type}_ci[]" placeholder="Cédula"></td>
            <td style="width:25%"><input type="text" class="form-control form-control-sm" name="list_${type}_tel[]" placeholder="Teléfono"></td>
            <td style="width:5%"><button type="button" class="btn-del" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
        `;
        tbody.appendChild(tr);
    }

    // --- BUSCAR DATOS ---
    async function buscarDatos() {
        const p = document.getElementById('selParroquia').value;
        const c = document.getElementById('txtComunidad').value;
        const fb = document.getElementById('searchFeedback');

        if(!p || !c) return Swal.fire('Error', 'Seleccione Parroquia y Comunidad', 'warning');

        document.getElementById('preloader').style.display = 'flex';
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'search', parroquia: p, comunidad: c })
            });
            const json = await res.json();
            document.getElementById('preloader').style.display = 'none';

            if(json.status === 'found') {
                const d = json.data.raw_data;
                // Llenar campos simples
                document.getElementById('inpResponsable').value = d[4] || "";
                document.getElementById('inpPlan').value = d[5] || "";
                document.getElementById('inpObs').value = d[6] || "";
                
                // Marcar archivos existentes (Col R = index 17)
                for(let i=1; i<=13; i++){
                    const box = document.getElementById(`boxFile${i}`);
                    if(d[16+i] && d[16+i].startsWith('http')) box.classList.add('has-file');
                    else box.classList.remove('has-file');
                }
                
                fb.innerHTML = `<div class="alert alert-success py-2 small"><i class="bi bi-check-circle"></i> Datos encontrados. Se actualizará el registro.</div>`;
                // Abrir siguiente sección
                new bootstrap.Collapse(document.getElementById('sec2')).show();
            } else {
                fb.innerHTML = `<div class="alert alert-primary py-2 small"><i class="bi bi-info-circle"></i> Nuevo registro. Puede comenzar a llenar.</div>`;
                // Limpiar visuales
                document.querySelectorAll('.has-file').forEach(e => e.classList.remove('has-file'));
                new bootstrap.Collapse(document.getElementById('sec2')).show();
            }
        } catch(e) {
            document.getElementById('preloader').style.display = 'none';
            Swal.fire('Error', 'No se pudo conectar al servidor.', 'error');
        }
    }

    // --- SUBIR ARCHIVOS ---
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // --- ENVIAR FORMULARIO ---
    document.getElementById('mainForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const loader = document.getElementById('preloader');
        loader.style.display = 'flex';

        try {
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            // Capturar listas manuales (porque FormData falla con arrays vacíos)
            ['aux', 'inc', 'eva', 'prom'].forEach(type => {
                data[`list_${type}_nom`] = Array.from(document.querySelectorAll(`input[name="list_${type}_nom[]"]`)).map(x=>x.value);
                data[`list_${type}_ci`] = Array.from(document.querySelectorAll(`input[name="list_${type}_ci[]"]`)).map(x=>x.value);
                data[`list_${type}_tel`] = Array.from(document.querySelectorAll(`input[name="list_${type}_tel[]"]`)).map(x=>x.value);
            });

            // Procesar archivos
            const files = [];
            const inputs = document.querySelectorAll('.anexo-file');
            for(const inp of inputs) {
                if(inp.files.length > 0) {
                    const b64 = await fileToBase64(inp.files[0]);
                    files.push({ numero: inp.dataset.id, name: inp.files[0].name, mime: inp.files[0].type, content: b64 });
                }
            }
            data.files = files;

            // Enviar
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const res = await response.json();
            loader.style.display = 'none';

            if(res.status === 'success') {
                Swal.fire('¡Éxito!', res.message, 'success').then(() => location.reload());
            } else {
                throw new Error(res.message || 'Error desconocido');
            }

        } catch(err) {
            loader.style.display = 'none';
            Swal.fire({
                title: 'Error',
                text: 'Fallo al guardar: ' + err.message,
                icon: 'error'
            });
        }
    });
</script>

</body>
</html>
