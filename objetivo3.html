<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anexos Parroquiales | Planes Comunitarios</title>
    
    <!-- Fuentes y librerías -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--primary); padding-bottom: 60px; }

        /* HEADER */
        .header-bar { background: var(--card); border-bottom: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .title-main { font-weight: 800; color: var(--primary); font-size: 1.1rem; margin: 0; }
        .title-sub { font-size: 0.75rem; color: #64748b; font-weight: 600; margin-top: 4px; text-transform: uppercase; }

        /* AVISO */
        .legal-box { background-color: #fff; border-left: 5px solid #0d6efd; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.85rem; color: #334155; }
        .legal-title { font-weight: 800; text-transform: uppercase; color: #0d6efd; margin-bottom: 8px; }

        /* TARJETAS */
        .form-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .section-title { font-size: 0.85rem; font-weight: 700; color: #475569; border-bottom: 1px solid var(--bg); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }

        /* INPUTS */
        .form-label { font-size: 0.9rem; font-weight: 600; color: #334155; margin-bottom: 8px; }
        .form-control, .form-select { border-radius: 6px; padding: 10px 12px; font-size: 0.9rem; border-color: #cbd5e1; }

        /* ARCHIVOS */
        .file-hint { font-size: 0.78rem; color: #6b7280; }
        .anexo-header { font-size: 0.85rem; font-weight: 600; color: #4b5563; margin-bottom: 8px; }
        .anexo-box { border-bottom: 1px dashed #e5e7eb; padding-bottom: 10px; margin-bottom: 10px; }

        /* BOTÓN ENVIAR */
        .btn-submit { background: var(--accent); color: white; width: 100%; padding: 15px; font-weight: 700; border: none; border-radius: 8px; font-size: 1rem; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.2); transition: 0.2s; }
        .btn-submit:hover { background: #1d4ed8; transform: translateY(-2px); }
        .btn-submit:disabled { background: #cbd5e1; transform: none; cursor: not-allowed; }

        /* BARRA SYNC */
        #syncBar { display: none; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: center; justify-content: space-between; font-size: 0.85rem; }

        /* PRELOADER FIXED */
        #preloader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,1); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- PRELOADER -->
    <div id="preloader">
        <div class="spinner"></div>
        <h6 class="fw-bold text-secondary">Cargando sistema de anexos...</h6>
    </div>

    <!-- HEADER -->
    <div class="header-bar">
        <div class="container" style="max-width: 700px;">
            <h1 class="title-main">CARGA DE ANEXOS PARROQUIALES</h1>
            <div class="title-sub">Planes Comunitarios | Anexos 1 al 13</div>
        </div>
    </div>

    <div class="container" style="max-width: 700px;">

        <!-- BARRA DE SINCRONIZACIÓN OFFLINE -->
        <div id="syncBar">
            <div class="d-flex align-items-center">
                <i class="bi bi-cloud-arrow-up-fill fs-5 me-2"></i>
                <div><strong id="syncCount">0</strong> registros pendientes por subir.</div>
            </div>
            <button class="btn btn-warning btn-sm fw-bold" onclick="syncOfflineData()">SUBIR</button>
        </div>

        <!-- AVISO -->
        <div class="legal-box">
            <div class="legal-title">
                <i class="bi bi-folder-symlink-fill"></i> Registro de anexos de planes comunitarios
            </div>
            <div>
                Use este formulario para adjuntar los 13 anexos del plan comunitario (actas, listados, plan firmado, evidencias, etc.).
                <br>
                <b>La fecha se registra automáticamente como fecha de subida en el sistema.</b>
            </div>
        </div>

        <!-- FORMULARIO -->
        <form id="anexoForm">
            <!-- Identificador de tipo para Apps Script -->
            <input type="hidden" name="tipo" value="anexos">
            <input type="hidden" name="fecha_subida" id="fechaSubida">

            <!-- 1. Datos de referencia -->
            <div class="form-card">
                <h6 class="section-title">
                    <i class="bi bi-building-fill-gear"></i> 1. Datos de referencia
                </h6>

                <div class="mb-3">
                    <label class="form-label">Parroquia Rural <span class="text-danger">*</span></label>
                    <select class="form-select" name="parroquia" required>
                        <option value="" selected disabled>Seleccione...</option>
                        <option value="Alluriquín">Alluriquín</option>
                        <option value="Puerto Limón">Puerto Limón</option>
                        <option value="Luz de América">Luz de América</option>
                        <option value="San Jacinto del Búa">San Jacinto del Búa</option>
                        <option value="Valle Hermoso">Valle Hermoso</option>
                        <option value="El Esfuerzo">El Esfuerzo</option>
                        <option value="Santa María del Toachi">Santa María del Toachi</option>
                        <option value="La Villegas">La Villegas</option>
                        <option value="Monterrey">Monterrey</option>
                        <option value="Plan Piloto">Plan Piloto</option>
                    </select>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Comunidad / Recinto <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="comunidad" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Responsable de carga (nombre) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="responsable" required>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label">Nombre del Plan Comunitario o actividad <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="plan_nombre" placeholder="Ej. Plan Comunitario de Gestión de Riesgos 2025" required>
                </div>

                <div class="mt-3">
                    <label class="form-label">Fecha de subida (automática)</label>
                    <input type="text" class="form-control" id="fechaSubidaView" readonly>
                    <span class="file-hint">Se genera con la fecha y hora del momento de registro.</span>
                </div>

                <div class="mt-3">
                    <label class="form-label">Observaciones generales (opcional)</label>
                    <textarea class="form-control" name="observaciones" rows="2" placeholder="Notas relevantes sobre los anexos o el proceso comunitario."></textarea>
                </div>
            </div>

            <!-- 2. Anexos 1 al 13 -->
            <div class="form-card">
                <h6 class="section-title">
                    <i class="bi bi-paperclip"></i> 2. Anexos del plan (máximo 13)
                </h6>

                <p class="file-hint mb-3">
                    Cada anexo tiene un campo para una breve descripción y un archivo. 
                    No es obligatorio cargar los 13, pero al menos un anexo debe adjuntarse.
                </p>

                <!-- Generación manual de 13 anexos -->
                <!-- Anexo 1 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 1</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo1_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="1"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                            <div class="file-hint">Ej.: Acta de asamblea.</div>
                        </div>
                    </div>
                </div>

                <!-- Anexo 2 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 2</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo2_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="2"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                            <div class="file-hint">Ej.: Listado de participantes.</div>
                        </div>
                    </div>
                </div>

                <!-- Anexo 3 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 3</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo3_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="3"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                            <div class="file-hint">Ej.: Plan comunitario firmado.</div>
                        </div>
                    </div>
                </div>

                <!-- Anexo 4 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 4</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo4_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="4"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                            <div class="file-hint">Ej.: Matriz de actores.</div>
                        </div>
                    </div>
                </div>

                <!-- Anexo 5 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 5</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo5_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="5"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                            <div class="file-hint">Ej.: Mapa comunitario.</div>
                        </div>
                    </div>
                </div>

                <!-- Anexo 6 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 6</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo6_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="6"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

                <!-- Anexo 7 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 7</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo7_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="7"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

                <!-- Anexo 8 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 8</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo8_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="8"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

                <!-- Anexo 9 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 9</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo9_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="9"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

                <!-- Anexo 10 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 10</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo10_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="10"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

                <!-- Anexo 11 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 11</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo11_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="11"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

                <!-- Anexo 12 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 12</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo12_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="12"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

                <!-- Anexo 13 -->
                <div class="anexo-box">
                    <div class="anexo-header">Anexo 13</div>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="anexo13_titulo" placeholder="Descripción (opcional)">
                        </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control form-control-sm anexo-file" data-anexo="13"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.csv,.txt">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Botón enviar -->
            <div class="d-grid gap-2 mb-5">
                <button type="submit" class="btn-submit" id="btnSubmit">SUBIR ANEXOS</button>
                <p class="text-center small text-muted mt-2">
                    Si no hay conexión, los anexos se guardan en el dispositivo para subirlos después.
                </p>
            </div>
        </form>
    </div>

    <script>
        // ========================================
        // ⚠️ PEGA AQUÍ TU URL DE GOOGLE APPS SCRIPT
        // ========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec";
        const OFFLINE_KEY = "offlineAnexos";

        // --- INICIALIZACIÓN ---
        document.addEventListener("DOMContentLoaded", function() {
            const preloader = document.getElementById('preloader');
            if (preloader) setTimeout(() => { preloader.style.display = 'none'; }, 500);

            // Fecha automática de subida
            const now = new Date();
            const iso = now.toISOString();
            const localStr = now.toLocaleString('es-EC', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });

            const fechaHidden = document.getElementById('fechaSubida');
            const fechaView = document.getElementById('fechaSubidaView');
            if (fechaHidden) fechaHidden.value = iso;
            if (fechaView) fechaView.value = localStr;

            checkOfflineQueue();
        });

        // Seguro extra para preloader
        setTimeout(() => {
            const p = document.getElementById('preloader');
            if (p && p.style.display !== 'none') p.style.display = 'none';
        }, 3000);

        // --- UTILIDAD: archivo a Base64 (sin cabecera) ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result || "";
                    const base64 = String(result).split(",")[1] || "";
                    resolve(base64);
                };
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        }

        // --- CONSTRUIR PAYLOAD COMPLETO (FORM + ARCHIVOS) ---
        async function buildPayload(form) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Asegurar fecha_subida
            if (!data.fecha_subida) {
                data.fecha_subida = new Date().toISOString();
            }

            const files = [];
            const fileInputs = document.querySelectorAll('.anexo-file');
            const preloader = document.getElementById('preloader');

            const totalSlots = fileInputs.length;
            let processed = 0;

            for (const input of fileInputs) {
                const numero = input.dataset.anexo;
                const tituloField = form.querySelector(`[name="anexo${numero}_titulo"]`);
                const titulo = tituloField ? tituloField.value : "";

                if (input.files && input.files.length > 0) {
                    const file = input.files[0];
                    if (preloader) {
                        preloader.querySelector('h6').innerText =
                            `Procesando anexo ${numero}...`;
                    }
                    const base64 = await fileToBase64(file);

                    files.push({
                        numero: numero,
                        titulo: titulo,
                        fileName: file.name,
                        mimeType: file.type,
                        size: file.size,
                        content: base64
                    });
                }

                processed++;
            }

            data.files = files;
            return data;
        }

        // --- ENVÍO PRINCIPAL ---
        document.getElementById('anexoForm').addEventListener('submit', function (e) {
            e.preventDefault();
            handleSubmit(this);
        });

        async function handleSubmit(form) {
            const fileInputs = document.querySelectorAll('.anexo-file');
            let hasFile = false;
            fileInputs.forEach(input => {
                if (input.files && input.files.length > 0) hasFile = true;
            });

            if (!hasFile) {
                Swal.fire('Faltan anexos', 'Debe cargar al menos un anexo antes de enviar.', 'warning');
                return;
            }

            const preloader = document.getElementById('preloader');
            preloader.style.display = 'flex';
            preloader.style.opacity = '1';
            preloader.querySelector('h6').innerText = "Preparando anexos...";

            let data;
            try {
                data = await buildPayload(form);
            } catch (err) {
                preloader.style.display = 'none';
                Swal.fire('Error al procesar archivos', 'Revise los archivos seleccionados e intente de nuevo.', 'error');
                return;
            }

            try {
                preloader.querySelector('h6').innerText = "Enviando anexos al servidor...";

                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(data)
                });

                let json;
                try {
                    json = await res.json();
                } catch (e) {
                    json = { status: 'error' };
                }

                preloader.style.display = 'none';

                if (json.status === 'success') {
                    Swal.fire({
                        title: '¡Anexos subidos!',
                        text: `Se registraron los anexos de ${data.parroquia} - ${data.comunidad}.`,
                        icon: 'success',
                        confirmButtonColor: '#0f172a'
                    }).then(() => window.location.reload());
                } else {
                    // Guardar offline si el servidor responde con error
                    saveToLocalStorage(data);
                    Swal.fire({
                        title: 'Problema con el servidor',
                        text: 'Los anexos se guardaron en el dispositivo para intentar subirlos después.',
                        icon: 'info',
                        confirmButtonColor: '#d97706'
                    }).then(() => window.location.reload());
                }

            } catch (error) {
                preloader.style.display = 'none';
                // Sin conexión: guardar offline
                saveToLocalStorage(data);

                Swal.fire({
                    title: 'Sin conexión',
                    text: 'Los anexos se guardaron en el dispositivo. Podrá subirlos cuando tenga internet.',
                    icon: 'info',
                    confirmButtonColor: '#d97706'
                }).then(() => window.location.reload());
            }
        }

        // --- OFFLINE: guardar y sincronizar ---
        function saveToLocalStorage(data) {
            let queue = JSON.parse(localStorage.getItem(OFFLINE_KEY)) || [];
            queue.push(data);
            localStorage.setItem(OFFLINE_KEY, JSON.stringify(queue));
        }

        function checkOfflineQueue() {
            let queue = JSON.parse(localStorage.getItem(OFFLINE_KEY)) || [];
            if (queue.length > 0) {
                document.getElementById('syncBar').style.display = 'flex';
                document.getElementById('syncCount').innerText = queue.length;
            }
        }

        async function syncOfflineData() {
            let queue = JSON.parse(localStorage.getItem(OFFLINE_KEY)) || [];
            if (queue.length === 0) return;

            const preloader = document.getElementById('preloader');
            preloader.style.display = 'flex';
            preloader.style.opacity = '1';
            preloader.querySelector('h6').innerText = "Subiendo anexos pendientes...";

            try {
                for (let i = 0; i < queue.length; i++) {
                    const data = queue[i];
                    preloader.querySelector('h6').innerText =
                        `Subiendo registro ${i + 1} de ${queue.length}...`;

                    await fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(data)
                    });
                }

                localStorage.removeItem(OFFLINE_KEY);
                document.getElementById('syncBar').style.display = 'none';
                preloader.style.display = 'none';

                Swal.fire({
                    title: '¡Sincronización exitosa!',
                    text: 'Todos los anexos pendientes se han subido correctamente.',
                    icon: 'success',
                    confirmButtonColor: '#0f172a'
                }).then(() => window.location.reload());

            } catch (error) {
                preloader.style.display = 'none';
                Swal.fire({
                    title: 'Error de conexión',
                    text: 'Hubo un problema al subir los anexos. Verifique su internet e intente nuevamente.',
                    icon: 'error'
                });
            }
        }
    </script>
</body>
</html>

