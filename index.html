<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n Piloto - Gesti√≥n de Riesgos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: none; }
        .header-logos { background: white; padding: 20px; border-bottom: 4px solid #0d6efd; text-align: center; }
        
        /* Sem√°foro */
        .bg-fortaleza { background-color: #d1e7dd; color: #0f5132; border-left: 5px solid #198754; }
        .bg-mejora { background-color: #fff3cd; color: #664d03; border-left: 5px solid #ffc107; }
        .bg-critico { background-color: #f8d7da; color: #842029; border-left: 5px solid #dc3545; }
        
        /* Tabla */
        .matrix-table th { background-color: #343a40; color: white; text-align: center; font-size: 0.9rem; }
        .matrix-table td { font-size: 0.9rem; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="header-logos">
        <h3 class="fw-bold text-primary">UEB - GAD PROVINCIAL SDT</h3>
        <p class="text-muted m-0">Evaluaci√≥n del Proceso de Conformaci√≥n de Comit√©s</p>
    </div>

    <div class="container py-4">
        <div class="row g-4">
            
            <div class="col-lg-6">
                <div class="card p-4">
                    <h5 class="mb-3 text-primary fw-bold">üìù Nueva Evaluaci√≥n</h5>
                    <form id="miFormulario">
                        
                        <div class="bg-light p-3 rounded mb-3">
                            <label class="fw-bold small text-muted">UBICACI√ìN Y DATOS</label>
                            <div class="mb-2">
                                <select class="form-select" name="parroquia" required>
                                    <option value="" disabled selected>Seleccione Parroquia...</option>
                                    <option value="Alluriqu√≠n">Alluriqu√≠n</option>
                                    <option value="Puerto Lim√≥n">Puerto Lim√≥n</option>
                                    <option value="Luz de Am√©rica">Luz de Am√©rica</option>
                                    <option value="San Jacinto del B√∫a">San Jacinto del B√∫a</option>
                                    <option value="Valle Hermoso">Valle Hermoso</option>
                                    <option value="El Esfuerzo">El Esfuerzo</option>
                                    <option value="Santa Mar√≠a del Toachi">Santa Mar√≠a del Toachi</option>
                                    <option value="Santo Domingo">Santo Domingo (Cabecera)</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control" name="comunidad" placeholder="Comunidad / Recinto" required>
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="text" class="form-control" name="nombre" placeholder="Nombre" required>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" name="cargo" required>
                                        <option value="" disabled selected>Cargo...</option>
                                        <option value="Presidente">Presidente</option>
                                        <option value="Vicepresidente">Vicepresidente</option>
                                        <option value="Secretario">Secretario</option>
                                        <option value="Vocal">Vocal / Coord.</option>
                                        <option value="Comunidad">Comunidad</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="preguntasContainer"></div>

                        <button type="submit" class="btn btn-primary w-100 py-2 mt-3 fw-bold shadow-sm" id="btnEnviar">
                            GUARDAR RESPUESTA
                        </button>
                    </form>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card p-4 sticky-top" style="top: 20px;">
                    <h5 class="mb-3 text-success fw-bold">üìä Resultados en Tiempo Real</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered matrix-table mb-0">
                            <thead>
                                <tr>
                                    <th>Indicador</th>
                                    <th width="15%">Nota</th>
                                    <th>Diagn√≥stico</th>
                                </tr>
                            </thead>
                            <tbody id="tablaResultados">
                                <tr><td colspan="3" class="text-center py-3">Cargando datos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è PEGA AQU√ç TU URL DE GOOGLE APPS SCRIPT
        // ==========================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzY6lu7YA6rpHihQPY8vjwlxdMg32g3Ezii10aAlPdG2h6BlFWBdLmnYeD_rI5jtM3B/exec"; 
        
        // Configuraci√≥n de Preguntas
        const config = [
            { id: "p1", label: "1. Participaci√≥n", ok: "FORTALEZA: Alta legitimidad.", fail: "CR√çTICO: Ausentismo." },
            { id: "p2", label: "2. Compromiso", ok: "FORTALEZA: L√≠deres motivados.", fail: "CR√çTICO: Apat√≠a." },
            { id: "p3", label: "3. Capacitaci√≥n", ok: "FORTALEZA: Conocimiento claro.", fail: "CR√çTICO: Confusi√≥n." },
            { id: "p4", label: "4. El Plan (Herramienta)", ok: "EXITO: Plan validado.", fail: "FALLA: Resistencia al plan." },
            { id: "p5", label: "5. Comunicaci√≥n", ok: "FORTALEZA: Confianza total.", fail: "CR√çTICO: Tensi√≥n interna." },
            { id: "p6", label: "6. Articulaci√≥n Inst.", ok: "EXITO: Sinergia GAD-UEB.", fail: "CR√çTICO: Abandono." },
            { id: "p7", label: "7. Inclusi√≥n", ok: "FORTALEZA: Representatividad.", fail: "CR√çTICO: Exclusi√≥n." },
            { id: "p8", label: "8. Sostenibilidad", ok: "POTENCIAL: Efecto R√©plica.", fail: "RIESGO: Aislamiento." }
        ];

        // 1. Renderizar Preguntas
        const container = document.getElementById('preguntasContainer');
        config.forEach(c => {
            container.innerHTML += `
                <div class="d-flex align-items-center justify-content-between border-bottom py-2">
                    <label class="small fw-bold m-0" style="width:60%">${c.label}</label>
                    <select class="form-select form-select-sm" name="${c.id}" style="width:35%" required>
                        <option value="" selected disabled>-</option>
                        <option value="1">1</option><option value="2">2</option>
                        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                    </select>
                </div>`;
        });

        // 2. Cargar Datos Iniciales (GET)
        window.onload = () => {
            fetch(WEB_APP_URL)
                .then(response => response.json())
                .then(data => actualizarMatriz(data.promedios))
                .catch(error => console.error('Error cargando:', error));
        };

        // 3. Enviar Formulario (POST)
        document.getElementById('miFormulario').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnEnviar');
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            btn.disabled = true;
            btn.innerText = "Guardando...";

            // Enviamos como texto plano para evitar errores de CORS en GitHub
            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                alert("‚úÖ ¬°Encuesta guardada!");
                this.reset();
                actualizarMatriz(result.promedios);
                btn.disabled = false;
                btn.innerText = "GUARDAR RESPUESTA";
            })
            .catch(error => {
                alert("Error: " + error);
                btn.disabled = false;
            });
        });

        // 4. Actualizar Tabla
        function actualizarMatriz(promedios) {
            const tbody = document.getElementById('tablaResultados');
            tbody.innerHTML = "";
            
            if(!promedios) return;

            promedios.forEach((prom, i) => {
                let p = parseFloat(prom);
                let clase = "bg-critico";
                let texto = config[i].fail;
                
                if(p >= 4) { clase = "bg-fortaleza"; texto = config[i].ok; }
                else if(p >= 3) { clase = "bg-mejora"; texto = "ALERTA: Mejora necesaria."; }

                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold small">${config[i].label}</td>
                        <td class="text-center fw-bold">${p}</td>
                        <td class="${clase} small p-1 rounded">${texto}</td>
                    </tr>`;
            });
        }
    </script>
</body>
</html>
